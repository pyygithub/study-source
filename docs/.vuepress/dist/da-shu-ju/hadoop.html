<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hadoop | PYY在线笔记文档</title>
    <meta name="generator" content="VuePress 1.7.0">
    <link rel="icon" href="/study/img/logo.png">
    <meta name="description" content="PYY在线笔记文档">
    
    <link rel="preload" href="/study/assets/css/0.styles.bcec59ec.css" as="style"><link rel="preload" href="/study/assets/js/app.7f558c8e.js" as="script"><link rel="preload" href="/study/assets/js/2.6c6da70f.js" as="script"><link rel="preload" href="/study/assets/js/10.c4e17556.js" as="script"><link rel="prefetch" href="/study/assets/js/11.bfd73459.js"><link rel="prefetch" href="/study/assets/js/12.67cb43c3.js"><link rel="prefetch" href="/study/assets/js/13.a8110c04.js"><link rel="prefetch" href="/study/assets/js/14.3ecefd52.js"><link rel="prefetch" href="/study/assets/js/15.95fede84.js"><link rel="prefetch" href="/study/assets/js/16.ca9bb5a8.js"><link rel="prefetch" href="/study/assets/js/17.584bcd1e.js"><link rel="prefetch" href="/study/assets/js/18.006b9da3.js"><link rel="prefetch" href="/study/assets/js/19.ecc3b503.js"><link rel="prefetch" href="/study/assets/js/20.da5e2d6b.js"><link rel="prefetch" href="/study/assets/js/21.2777d930.js"><link rel="prefetch" href="/study/assets/js/22.35e62c84.js"><link rel="prefetch" href="/study/assets/js/23.6aa0a610.js"><link rel="prefetch" href="/study/assets/js/24.e41b0340.js"><link rel="prefetch" href="/study/assets/js/25.098ae0db.js"><link rel="prefetch" href="/study/assets/js/26.0fb15604.js"><link rel="prefetch" href="/study/assets/js/27.9642636c.js"><link rel="prefetch" href="/study/assets/js/28.86ef64ed.js"><link rel="prefetch" href="/study/assets/js/29.5cd933d1.js"><link rel="prefetch" href="/study/assets/js/3.96cf9b7a.js"><link rel="prefetch" href="/study/assets/js/4.d8e27131.js"><link rel="prefetch" href="/study/assets/js/5.f2bfab0e.js"><link rel="prefetch" href="/study/assets/js/6.1f1f2b65.js"><link rel="prefetch" href="/study/assets/js/7.577ac670.js"><link rel="prefetch" href="/study/assets/js/8.0d6a8bf4.js"><link rel="prefetch" href="/study/assets/js/9.3f39c3d6.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.bcec59ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记文档" class="logo"> <span class="site-name can-hide">PYY在线笔记文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/分布式/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/分布式/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dev Ops</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>大数据</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/da-shu-ju/hadoop.html" aria-current="page" class="active sidebar-link">Hadoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#大数据概念" class="sidebar-link">大数据概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#什么是大数据" class="sidebar-link">什么是大数据？</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#大数据特点" class="sidebar-link">大数据特点？</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#面临了哪些问题-如何解决" class="sidebar-link">面临了哪些问题,如何解决？</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#大数据应用场景" class="sidebar-link">大数据应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hadoop-的诞生" class="sidebar-link">Hadoop 的诞生</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hadoop-的起源" class="sidebar-link">Hadoop 的起源</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hadoop-的历史版本" class="sidebar-link">Hadoop 的历史版本</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hadoop-生态圈" class="sidebar-link">Hadoop 生态圈</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#大数据解决方案" class="sidebar-link">大数据解决方案</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-分布式系统配置" class="sidebar-link">HDFS 分布式系统配置</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-体系架构" class="sidebar-link">HDFS 体系架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#什么是block块" class="sidebar-link">什么是Block块</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#什么是机架感知" class="sidebar-link">什么是机架感知？</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-核心工作原理" class="sidebar-link">HDFS 核心工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#元数据管理" class="sidebar-link">元数据管理</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#元数据存储机制" class="sidebar-link">元数据存储机制</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#secondarynamenode-检查点" class="sidebar-link">SecondaryNameNode 检查点</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-写数据流程" class="sidebar-link">HDFS 写数据流程</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-读数据流程" class="sidebar-link">HDFS 读数据流程</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#安全模式" class="sidebar-link">安全模式</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#从一个-hdfs-edits-文件看到的一些问题" class="sidebar-link">从一个 HDFS edits 文件看到的一些问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-命令行客户端基本操作" class="sidebar-link">HDFS 命令行客户端基本操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#客户端理解" class="sidebar-link">客户端理解</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-命令行客户端的常用操作命令" class="sidebar-link">HDFS 命令行客户端的常用操作命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs-的-javaapi" class="sidebar-link">HDFS 的 JavaAPI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#开发环境准备" class="sidebar-link">开发环境准备</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#文件上传" class="sidebar-link">文件上传</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#下载文件" class="sidebar-link">下载文件</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#创建文件夹" class="sidebar-link">创建文件夹</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#删除文件" class="sidebar-link">删除文件</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#递归查询目录下所有文件列表" class="sidebar-link">递归查询目录下所有文件列表</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#判断文件是否存在" class="sidebar-link">判断文件是否存在</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#回收站" class="sidebar-link">回收站</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs客户端编程应用场景-数据采集" class="sidebar-link">HDFS客户端编程应用场景：数据采集</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#hdfs版的wordcount" class="sidebar-link">HDFS版的wordcount</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce" class="sidebar-link">MapReduce</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce-是什么" class="sidebar-link">MapReduce 是什么？</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#为什么要使用mr" class="sidebar-link">为什么要使用MR？</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce-框架" class="sidebar-link">MapReduce 框架</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce具有的特点" class="sidebar-link">MapReduce具有的特点</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce-实例" class="sidebar-link">MapReduce 实例</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce-版-wordcount-代码实现" class="sidebar-link">MapReduce 版 wordcount 代码实现</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#mapreduce-执行流程" class="sidebar-link">MapReduce 执行流程</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#yarn简介" class="sidebar-link">YARN简介</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#yarn架构" class="sidebar-link">YARN架构</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#yarn-的安装" class="sidebar-link">YARN 的安装</a></li><li class="sidebar-sub-header"><a href="/study/da-shu-ju/hadoop.html#运行上面的-wordcount-mr程序" class="sidebar-link">运行上面的 wordcount mr程序</a></li></ul></li></ul></li><li><a href="/study/da-shu-ju/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/study/da-shu-ju/azkaban.html" class="sidebar-link">Azkaban</a></li><li><a href="/study/da-shu-ju/elk-da-gui-mo-ri-zhi-shi-shi-chu-li.html" class="sidebar-link">ELK大规模日志实时处理</a></li><li><a href="/study/da-shu-ju/elasticsearch.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/study/da-shu-ju/flume.html" class="sidebar-link">Flume</a></li><li><a href="/study/da-shu-ju/hbase.html" class="sidebar-link">HBase</a></li><li><a href="/study/da-shu-ju/hive.html" class="sidebar-link">Hive</a></li><li><a href="/study/da-shu-ju/hue.html" class="sidebar-link">Hue</a></li><li><a href="/study/da-shu-ju/kafka.html" class="sidebar-link">Kafka</a></li><li><a href="/study/da-shu-ju/oozie.html" class="sidebar-link">Oozie</a></li><li><a href="/study/da-shu-ju/sqoop.html" class="sidebar-link">Sqoop</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="hadoop"><a href="#hadoop" class="header-anchor">#</a> Hadoop</h1> <h2 id="大数据概念"><a href="#大数据概念" class="header-anchor">#</a> 大数据概念</h2> <h3 id="什么是大数据"><a href="#什么是大数据" class="header-anchor">#</a> 什么是大数据？</h3> <blockquote><p>KB - MB - GB - TB - PB - EB - ZB - YB - DB - NB</p></blockquote> <p>一般来说达到 TB ，或日增达到 GB 就属于大数据了
MySQL 单表超过 500万 条数据</p> <h3 id="大数据特点"><a href="#大数据特点" class="header-anchor">#</a> 大数据特点？</h3> <p><strong>大数据的 5V 特性：</strong></p> <ul><li><p><strong>Volume：巨大的数据量</strong>
集中储存/集中计算已经无法处理巨大的数据量。
数据量呈指数增长：地震、录井 、石油钻塔的传感器一个月产生的数据量比全球所有的电影加在一起还要多。
新浪微博用户数2.5亿+，高峰每天几亿条。</p></li> <li><p><strong>Variety：非结构化数据多样性</strong>
文本/图片/视频/文档等，如诸如微地震，电磁以及光纤分布式温度监测（DTS） 。</p></li> <li><p><strong>Velocity：数据增长速度快</strong>
用户基数庞大/设备数量众多/实时海量/数据指数级别增长。</p></li> <li><p><strong>Valueless：数据价值密度低</strong>
每个钻井平台有 40,000 传感器,但是通常只有 10% 的数据使用到。
每个深水钻井平台的投资可达到$150M,能有效利用所有的数据非常关键,关系到安全与优化运营 。</p></li> <li><p><strong>Veracity：数据质量</strong>
数据的准确性和可信赖度，即数据的质量。</p></li></ul> <h3 id="面临了哪些问题-如何解决"><a href="#面临了哪些问题-如何解决" class="header-anchor">#</a> 面临了哪些问题,如何解决？</h3> <ul><li>数据如何存储 - HDFS</li> <li>数据如何计算 - MapReduce</li> <li>资源如何管理（CPU 内存 网络资源）- YARN</li></ul> <h3 id="大数据应用场景"><a href="#大数据应用场景" class="header-anchor">#</a> 大数据应用场景</h3> <ul><li><p><strong>个人推荐</strong>
根据用户喜好，推荐相关兴趣内容
千人一面：范围广、精度粗
一人一面：范围小、精度高
一人千面：兴趣内容范围大、精度高</p></li> <li><p><strong>风控</strong>
金融系统、银行、互联网金融 - 实时流处理</p></li> <li><p><strong>成本预测</strong>
根据近期销售和市场数据，预测成本，做出规划</p></li> <li><p><strong>气候预测</strong>
根据以往气象信息，预测近期气象变化，和推测之后气候异常</p></li> <li><p><strong>人工智能</strong>
无人汽车：百度、特斯拉、Google
智能助手：小爱、小度
物流机器人</p></li></ul> <h2 id="hadoop-的诞生"><a href="#hadoop-的诞生" class="header-anchor">#</a> Hadoop 的诞生</h2> <p>由 Apache 组织提供的一个开源的大数据解决方案。</p> <h3 id="hadoop-的起源"><a href="#hadoop-的起源" class="header-anchor">#</a> Hadoop 的起源</h3> <ul><li><p>2003-2004年，Google公布了部分GFS和MapReduce思想的细节，受此启发的Doug Cutting等人用2年的业余时间实现了DFS和MapReduce机制，使Nutch性能飙升。然后Yahoo招安Doug Gutting及其项目。</p></li> <li><p>2005年，Hadoop作为Lucene的子项目Nutch的一部分正式引入Apache基金会。</p></li> <li><p>2006年2月被分离出来，成为一套完整独立的软件，起名为Hadoop。Hadoop名字不是一个缩写，而是一个生造出来的词。是Hadoop之父Doug Cutting儿子毛绒玩具象命名的。</p></li> <li><p>Hadoop的成长过程
Lucene–&gt;Nutch—&gt;Hadoop</p></li> <li><p>总结起来，Hadoop起源于Google的三大论文</p> <ul><li>GFS：Google的分布式文件系统Google File System</li> <li>MapReduce：Google的MapReduce开源分布式并行计算框架</li> <li>BigTable：一个大型的分布式数据库</li></ul></li> <li><p>演变关系
GFS—-&gt;HDFS
Google MapReduce—-&gt;Hadoop MapReduce
BigTable—-&gt;HBase</p></li></ul> <p>狭义上来说，hadoop就是单独指代hadoop这个软件，
广义上来说，hadoop指代大数据的一个生态圈，包括很多其他的软件</p> <h3 id="hadoop-的历史版本"><a href="#hadoop-的历史版本" class="header-anchor">#</a> Hadoop 的历史版本</h3> <ul><li><strong>0.x系列版本</strong>：hadoop当中最早的一个开源版本，在此基础上演变而来的1.x以及2.x的版本</li> <li><strong>1.x版本系列</strong>：hadoop版本当中的第二代开源版本，主要修复0.x版本的一些bug等</li> <li><strong>2.x版本系列</strong>：架构产生重大变化，引入了yarn平台等许多新特性</li></ul> <h3 id="hadoop-生态圈"><a href="#hadoop-生态圈" class="header-anchor">#</a> Hadoop 生态圈</h3> <ul><li><strong>HDFS</strong>：Hadoop Distribute FileSystem</li> <li><strong>MapReduce</strong>：Hadoop中的分布式计算框架，实现对海量数据的并行分析和计算。</li> <li><strong>Hbase</strong>：基于HDFS的列式存储的 NoSQL 数据库。</li> <li><strong>Hive</strong>：简化大数据开发，可以将 SQL 语法翻译成 MR 任务。</li> <li><strong>Flume</strong>：分布式的日志收集系统，用于收集海量数据，将其存储到 FS 中。</li> <li><strong>Kafka</strong>：分布式的消息系统，实现分布式解耦和海量数据缓冲。</li> <li><strong>Zookeeper</strong>：分布式协调服务，用于服务注册中心、配置中心、集群选举、状态监测、分布式锁等。</li></ul> <h2 id="大数据解决方案"><a href="#大数据解决方案" class="header-anchor">#</a> 大数据解决方案</h2> <ul><li><strong>MR</strong>：代表基于<strong>磁盘</strong>的大数据离线批处理的解决方案 - 延迟较高</li> <li><strong>Spark</strong>：代表基于<strong>内存</strong>的大数据静态批处理的解决方案 - 几乎是MR的10倍以上</li> <li><strong>Storm/Spark Streaming/Flink/Kafka Streaming</strong>：实时流处理框架，达到对记录级别的数据显示和毫秒级处理</li></ul> <h2 id="hdfs-分布式系统配置"><a href="#hdfs-分布式系统配置" class="header-anchor">#</a> HDFS 分布式系统配置</h2> <p><strong>核心配置参数：</strong></p> <ul><li>指定 hadoop 的默认文件系统为：hdfs</li> <li>指定 hdfs 的 namenode 节点是哪台机器</li> <li>指定 namenode 软件存储元数据的本地目录</li> <li>指定 datanode 软件存储文件块的本地目录</li></ul> <ol><li><p>环境配置文件hadoop-env.sh</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># The java implementation to use.</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/opt/soft/jdk1.8.0_211
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_CONF_DIR</span><span class="token operator">=</span><span class="token variable">${HADOOP_CONF_DIR<span class="token operator">:-</span>$PWD}</span> <span class="token comment">#Hadoop配置文件的存放目录</span>
</code></pre></div></li> <li><p>核心配置文件 core-site.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- fs.defaultFS: 默认文件系统 hdfs  --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>fs.defaultFS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdfs://hdp-01:9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>HDFS配置文件hdfs-site.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- namenode 地址 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.http-address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdp-01:50070<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- secondary namenode 地址 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.http-address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdp-01:50090<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 指定 namenode 软件存储元数据的本地目录 格式化节点时会自动生成--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.name.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/root/hdpdata/name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 指定 datanode 软件存储文件块的本地目录 格式化节点时会自动生成   --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.datanode.data.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/root/hdpdata/data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置datanode集群节点文件 slaves</p> <div class="language-shell extra-class"><pre class="language-shell"><code>hdp-01
hdp-02
hdp-03
</code></pre></div></li> <li><p>配置好以上信息后，我们就可以将hadoop的包分发给其他的节点了</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">scp</span> -r hadoop-2.x.x root@hdp02:<span class="token punctuation">(</span>目标路径<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>启动集群</p> <p>在主节点上运行</p> <div class="language- extra-class"><pre class="language-text"><code>hadoop namenode -format
</code></pre></div><p>运行完成后，节点会自动生成刚刚配置的工作目录</p> <div class="language- extra-class"><pre class="language-text"><code>start-dfs.sh
</code></pre></div></li> <li><p>浏览器输入http://x.x.x.x:50070查看集群运行情况</p> <p><img src="/study/assets/img/namenode.f626aa82.png" alt="namenode"></p></li> <li><p>最终服务器分布：</p> <table><thead><tr><th>服务器地址</th> <th>端口</th> <th>服务</th></tr></thead> <tbody><tr><td>hdp-01</td> <td>50070<br>50090</td> <td>namenode<br>secondaryNamenode<br>datanode</td></tr> <tr><td>hdp-02</td> <td>50010/50075</td> <td>datanode</td></tr> <tr><td>hdp-03</td> <td>50010/50075</td> <td>datanode</td></tr></tbody></table></li> <li><p><strong>问题总结</strong></p> <ul><li>防火墙设置
为了防止发生一些奇怪的错误，请务必关闭所有节点的防火墙，他可能会导致浏览器无法获取集群信息和文件上传集群失败</li> <li>hosts文件配置和主机名
因为这是完全分布式的集群，所以配置hosts文件至关重要，不然你的私钥配置和以后节点的格式化都会出错，他将会提示你无法解析主机名</li> <li>请在关闭所有HDFS服务后在执行<code>-format</code>格式化命令
如果存在节点未关闭，而你运行了格式化命令，这可能导致该节点与其他节点的目录ID不一致，从而导致“网络分区”问题</li></ul></li></ol> <h2 id="hdfs-体系架构"><a href="#hdfs-体系架构" class="header-anchor">#</a> HDFS 体系架构</h2> <p><a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>HDFS 是一种能够运行在商业硬件上的分布式文件系统，与目前市面上文件系统有很多相似之处，但是又是不同的软件系统。在HDFS中，使用的架构主从架构（Active|Standby），针对的是<strong>NameNode</strong>的高可用。</p> <ol><li><p><strong>NameNode</strong></p> <ul><li>存储文件的元数据如<code>文件名、文件目录结构、文件属性(生成时间、福本数、文件权限) ，以及每个文件的块列表和块所在的DataNode映射</code></li> <li>负责管理 DataNode</li> <li>控制外界客户端对文件系统的访问。</li> <li>NameNode会启动一个（或者说一个集群中，只有一个NameNode节点运行）</li></ul></li> <li><p>**DataNode **
在本地文件系统存储文件块数据，以及块数据的校验和，负责响应客户端对块的读写请求。</p></li> <li><p><strong>Block</strong>
数据块，是对文件拆分的最小单元（默认情况下一个块大小128MB，每个数据块有3个副本）</p></li> <li><p><strong>rack</strong></p> <p>机架，使用机架对存储节点进行物理编排，用于优化存储和计算</p> <p><img src="/study/assets/img/HDFS.fa7eae62.png" alt="img"></p></li></ol> <h3 id="什么是block块"><a href="#什么是block块" class="header-anchor">#</a> 什么是Block块</h3> <ul><li><p>概述</p> <p>hadoop集群中文件的存储都是以块的形式存储在hdfs中，且一般默认都会有三个备份分别存储在集中中不同的datanode节点上。</p></li> <li><p>默认值</p> <p>从2.7.3版本开始 block size 默认值大小为 128M，之前版本默认值为64M</p></li> <li><p>如何修改 block 块的大小？</p> <p>可以通过修改 hdfs-site.xml中的 dfs.blocksize 对应的值</p> <p>注意: 在修改HDFS的数据块大小时，首先停掉集群hadoop的运行，修改完毕后重新启动。</p></li> <li><p>block块的大小设置规则</p> <p>在实际应用中，hdfs block块的大小设置为多少合适呢？为什么有的是64M，有个的是128M、256M、512M呢？</p> <p>首先我们先来了解几个概念：</p> <ol><li>寻址时间：HDFS 中找到目标文件block所花费的时间。</li> <li>原理：文件块越大，寻址时间越短，但磁盘传输时间越长；文件块越小，寻址时间越长，但磁盘传输时间越短。</li></ol></li> <li><p>block不能设置过大，也不能设置过小</p> <ol><li>如果设置过大，一方面从磁盘传输数据的时间会明显大于寻址时间，导致程序处理这块数据时，变得非常慢；另一方面，MapReduce 中map任务通常一次只处理一个块中的数据，如果过大运行速度也会很慢。</li> <li>如果设置过小，一方面存放大小小文件会占用NameNode中大量内存来存储元数据，而NameNode的内存是有限的，不可取；另一方面块过小，寻址时间增长，导致程序一直在找block的开始位置。因此，块适当设置大一些，减少寻址时间，那么传输一个有多个块组成的文件时间<strong>主要取决于磁盘的传输速度</strong>。</li></ol></li> <li><p>设置多大合适？</p> <ol><li><p>HDFS中平均寻址时间大概为 10ms；</p></li> <li><p>经过大量的测试发现，寻址时间为传输时间的1%时，为最佳状态，所以最佳的传输时间为：</p> <p>10ms/0.01 = 1000s = 1s</p></li> <li><p>目前磁盘的传输普遍为100MB/s，最佳block大小计算：</p> <p>100MB/s*1s=100MB</p> <p>所以我们设置block大小为 128MB。</p></li> <li><p>实际中，磁盘的传输速率为 200MB/s时，一般设定block块大小为256MB；磁盘传输速率为400MB/s时，一般设定block大小为512MB.</p></li></ol></li></ul> <h3 id="什么是机架感知"><a href="#什么是机架感知" class="header-anchor">#</a> 什么是机架感知？</h3> <ul><li><p>背景</p> <p>分布式的集群通常包含非常多的机器，由于受到机架槽位和交换机网口的限制，通常大型的分布式集群都会跨好多个机架，由多个机架上的机器共同组成分布式集群。机架内的机器之间的网络速度通常都会高于跨机架机器之间的网络速度，并且机架之间机器的网络通信通常受到上层交换机网络带宽的限制。</p></li> <li><p>存储策略</p> <p><strong>Hadoop在设计时考虑到数据的安全和高效，数据文件默认在HDFS上存放三份，存储策略为：</strong></p> <p>第一个block副本放在客户端所在的数据节点上（如果客户端不在集群范围内，则从整个集群中随机选择一个合适的数据节点来存放）。</p> <p>第二个副本放置在与第一个副本所在节点相同的机架内的其它数据节点上</p> <p>第三个副本放置在不同机架节点上</p> <p>如果副本数  &gt;= 4时：</p> <p>前三个副本按照上面原则存放，从第四个副本开始，随机选取dataNode节点存放（每个节点只保留一份副本，每个rack不超过两个副本）</p> <p>这样如果本地数据损坏，节点可以从同一机架内的相邻节点拿到数据，速度肯定比从跨机架节点上获取数据的速度快；</p> <p>同时，如果整个机架的网络出现异常，也能保障可以在其它机架节点上找到数据。</p> <p>为了降低整体的带宽消耗和读取延时，HDFS会尽量让读取程序读取离它最近的副本。</p> <p>如果在读取程序的同一个机架上有一个副本，那么就读取该副本。</p> <p>如果在一个HDFS集群跨越多个数据中心，那么客户端也将读取本地数据中心的副本。</p> <p>那么Hadoop是如何确定任意两个节点为于同一个机架，还是跨机架的呢？答案就是<strong>机架感知</strong>。</p> <p>默认情况下，hadoop的机架感知是没有被开启的。所有机器hadoop都默认同一个机架下，名为“、default-rack&quot;,这种情况下，任何一台 datanode 机器，不管物理上是否属于同一个机架，都会被认为在同一个机架下，此时，就很容易出现增添机架间网络负载的情况。因为此时hadoop集群的HDFS在选机器的时候，是随机选择的，也就是说，很可能在写数据的时候，hadoop将第一块数据的block1写在 rack1上，然后随机的选择将block2写入到rack2上。</p> <p>此时，两个rack之间产生了数据传输的流量，再接下来，在随机的情况下，又将block3重新又写回到rack2，此时，两个rack之间又产生了一次数据流量。</p> <p>在job处理的数据量非常大的时候，或者hadoop推送的数据量非常大的时候，这种情况会造成rack之间的网络流量成倍的上升，成为性能的瓶颈，进而影响作业的性能甚至于整个集群的服务。</p></li> <li><p>配置</p> <p>具体配置可参考：https://blog.csdn.net/zhongqi2513/article/details/73695229</p></li></ul> <h2 id="hdfs-核心工作原理"><a href="#hdfs-核心工作原理" class="header-anchor">#</a> HDFS 核心工作原理</h2> <h3 id="元数据管理"><a href="#元数据管理" class="header-anchor">#</a> 元数据管理</h3> <p>NameNode对数据的管理采用三种存储形式：</p> <ul><li>内存元数据（NameSystem）</li> <li>磁盘元数据镜像文件</li> <li>数据操作日志文件（可通过日志运算出元数据）</li></ul> <h3 id="元数据存储机制"><a href="#元数据存储机制" class="header-anchor">#</a> 元数据存储机制</h3> <ul><li><p>内存中有个一份完整的元数据（内存meta.data）</p></li> <li><p>磁盘有一个”准完整“的元数据镜像（fsimage）文件（在namenode的工作目录中）</p></li> <li><p>用于衔接内存meta.data和持久化元数据镜像fsimage之间的操作日志（edits文件）注：当客户端对hdfs中的文件进行新增或修改操作，操作记录首先被记入edits日志文件中，当客户端操作成功后，相应的元数据会被更新到内存meta.data中</p></li></ul> <h3 id="secondarynamenode-检查点"><a href="#secondarynamenode-检查点" class="header-anchor">#</a> SecondaryNameNode 检查点</h3> <p>NameNode 职责是管理元数据信息，DataNode的职责是负责数据具体存储，那么 SecondaryNameNode 的作用是什么？它为什么会出现在 HDFS 中。从它的名字上看，它给人的感觉就像是 NameNode的备份。但实际上却不是。</p> <p><strong>HDFS 集群运行一段时间后，可能会出现的问题：</strong></p> <ul><li>edits 文件会变的很大，怎么去管理这个文件是一个挑战。</li> <li>NameNode 重启会花费很长时间，因为有很多改动要合并到 fsimage 文件上。</li> <li>如果 NameNode 挂掉了，那就丢失了一些改动。因为此时的 fsimage 文件非常旧。</li></ul> <p>因此为了克服这个问题，我们需要一个易于管理的机制来帮助我们<code>减少 edits 文件的大小和得到一个最新的fsimage文件</code>，这样也会减少在 NameNode 上的压力。这跟windows的恢复点是非常像的，windows的恢复点机制允许我们对OS进行快照，这样当系统发生问题时，我们能够回滚到最新的一次恢复点上。</p> <p>SecondaryNameNode 就是来帮助我们解决上述问题的，它的职责是合并 NameNode 的 edits 到 fsimage文件中。</p> <p><strong>Checkpoint</strong></p> <p>每达到触发条件，会由 SecondaryNameNode 将 NameNode 上积累的所有 edits 和一个最新的 fsimage 下载到本地，并加载到内存进行 merge，而这个过程就称为：<strong>checkpoint</strong></p> <p><img src="/study/assets/img/checkpoint.924aeadc.png" alt="img"></p> <p><strong>详细步骤</strong></p> <ul><li><p>NameNode 管理着元数据信息，其中有两类持久化元数据文件：edits 操作日志文件和 fsImage 元数据镜像文件。新的操作日志不会立即与 fsimage 进行合并，也不会刷到 NameNode 内存中，而是会先写到 edits 中（因为合并需要消耗大量的资源）。</p></li> <li><p>有dfs.namenode.checkpoint.period和dfs.namenode.checkpoint.txns 两个配置，只要达到这两个条件任何一个，secondarynamenode就会执行checkpoint的操作。</p></li> <li><p>当触发 checkpoint 操作时，SecondaryNameNode 告诉 NameNode 滚动到它的 edits_inprogress 文件，这样新来的write操作就会放到一个这个新的 edits文件中。同时，Secondary 通过HTTP GET方式从 NameNode 获取到最新的 fsimage 和 edits 文件</p></li> <li><p>SecondaryNameNode 将下载下来的 fsimage 载入到内存，然后一条一条的执行 edits 文件中的各项操作，使得内存中的 fsimage 保持最新，这个过程就是 edits和fsimage文件合并，生成一个新的 fsimage文件，即上图的 fsimage.ckpt 文件。</p></li> <li><p>SecondaryNameNode 将新生成的 fsimage.ckpt文件复制到NameNode节点。</p></li> <li><p>在 NameNode 节点的 edits.new 文件和 fsimage.ckpt文件会替换掉原来的 edits 文件 和 fsimage 文件，至此刚好是一个轮回。</p></li> <li><p>等待下一次checkpoint触发SecondaryNameNode进行工作，一直这样循环操作。</p></li></ul> <p><strong>补充：</strong></p> <p>NameNode 和 Secondary NameNode 的工作目录存储结构是完全相同的，所以，当NameNode故障退出需要重新恢复时，可以从Secondary NameNode的工作目录中将fsimage拷贝到NameNode的工作目录，以恢复NameNode的元数据。</p> <p>chepoint检查时间参数设置：</p> <p>（1）通常情况下，SecondaryNameNode每个一小时执行一次。</p> <div class="language-xml extra-class"><pre class="language-xml"><code># hdfs-default.xml
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.checkpoint.period<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>3600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>（2）一分钟检查一次操作次数，当操作次数达到一百万时，SecondaryNameNode执行一次。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.checkpoint.txns<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>1000000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>操作动作次数<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.checkpoint.check.period<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>60<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span> 1分钟检查一次操作次数<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>从上面的描述我们可以看出，SecondaryNameNode 根本不是 NameNode 的一个热备，其只是将 fsimage 和 edits 合并。其拥有的 fsimage 不会最新的，因为它从 NameNode 下载 fsimage 和 edits 文件时候，新的更新操作已经写到 edit.new 文件中去了。而这些更新在 SecondaryNameNode 是没有同步到的。当然，如果 NameNode 中的 fsimage 真的出问题了，还是可以用 SecondaryNameNode 中的 fsimage 替换一下 NameNode 上的 fimage，虽然已经不是最新的 fsimage，但是我们可以将损失减少到最小！</p> <h3 id="hdfs-写数据流程"><a href="#hdfs-写数据流程" class="header-anchor">#</a> HDFS 写数据流程</h3> <p><img src="/study/assets/img/write.75a0eb48.png" alt=""></p> <h3 id="hdfs-读数据流程"><a href="#hdfs-读数据流程" class="header-anchor">#</a> HDFS 读数据流程</h3> <p><img src="/study/assets/img/read.fbff4e11.png" alt=""></p> <h3 id="安全模式"><a href="#安全模式" class="header-anchor">#</a> 安全模式</h3> <p><strong>安全模式的作用</strong></p> <p>Hadoop 的安全模式即只读模式，是指当前系统中数据的副本数比较少，在该阶段要对数据块进行复制操作，不允许外界对数据库进行修改和删除等操作。处于安全模式的NameNode是不会进行数据块的复制的。</p> <p>NameNode 启动时，首先将映像文件（fsimage）载入内存，并执行编辑日志（edits）中的各项操作。一旦在内中成功建立文件系统元数据的映像，则创建一个新的 fsimage 文件（这个操作不需要SecondaryNameNode）和一个空的编辑文件（edits_inprogress...）。此时，NameNode 开始监听 RPC 和 HTTP 请求。但此时，NameNode 运行在安全模式下，对于客户端来说是只读的。</p> <p>处于安全模式的NameNode是不会进行数据块的复制的。</p> <p><strong>何时进入安全模式</strong></p> <ul><li><p>NameNode在启动的时候首先进入安全模式</p></li> <li><p>满足最小复本数要求的数据块比例达不到dfs.safemode.threshold.pct</p> <p>如果datanode丢失的block达到一定的比例（1-dfs.safemode.threshold.pct），则系统会一直处于安全模式状态即只读状态。dfs.safemode.threshold.pct（缺省值0.999f）表示HDFS启动的时候，如果DataNode上报的block个数达到了元数据记录的block个数的0.999倍才可以离开安全模式，否则一直是这种只读模式。如果设为1则HDFS永远是处于SafeMode。</p></li></ul> <p><strong>何时退出安全模式</strong></p> <ul><li>如果满足“最小复本条件”namenode会在30秒之后退出安全模式。所谓的最小复本条件指的是文件系统中有99.9%的块满足最小复本级别（默认值是1，由dfs.replication.min属性设置）。</li> <li>手动退出</li></ul> <p><strong>安全模式的配置</strong></p> <p>https://www.iteblog.com/archives/977.html
https://www.cnblogs.com/admln/p/5821983.html</p> <div class="language-xml extra-class"><pre class="language-xml"><code>dfs.replication：设置数据块应该被复制的份数；
dfs.replication.min：所规定的数据块副本的最小份数；
dfs.replication.max：所规定的数据块副本的最大份数；
dfs.safemode.threshold.pct：指定应有多少比例的数据块满足最小副本数要求。
  (1)当小于这个比例， 那就将系统切换成安全模式，对数据块进行复制；
  (2)当大于该比例时，就离开安全模式，说明系统有足够的数据块副本数，可以对外提供服务。
  (3)小于等于0意味不进入安全模式，大于1意味一直处于安全模式。
</code></pre></div><p>副本数按dfs.replication设置，如果有失效节点导致某数据块副本数降低，当低于dfs.replication.min后，系统再在其他节点处复制新的副本。如果该数据块的副本经常丢失，导致在环境中太多的节点处复制了超过dfs.replication.max的副本数，那么就不再复制了。</p> <p><strong>手动操作安全模式</strong></p> <p>①查看namenode是否处于安全模式：hadoop dfsadmin –safemode get
②执行某条命令前namenode先退出安全模式：hadoop dfsadmin –safe wait
③进入安全模式：hadoop dfsadmin –safemode enter
④离开安全模式：hadoop dfsadmin –safemode leave</p> <h3 id="从一个-hdfs-edits-文件看到的一些问题"><a href="#从一个-hdfs-edits-文件看到的一些问题" class="header-anchor">#</a> 从一个 HDFS edits 文件看到的一些问题</h3> <div class="language- extra-class"><pre class="language-text"><code>-rw-r--r-- 1 root root      42 Mar 16 11:28 edits_0000000000000010479-0000000000000010480
-rw-r--r-- 1 root root      42 Mar 16 11:29 edits_0000000000000010481-0000000000000010482
-rw-r--r-- 1 root root      42 Mar 16 11:30 edits_0000000000000010483-0000000000000010484
-rw-r--r-- 1 root root      42 Mar 16 11:31 edits_0000000000000010485-0000000000000010486
-rw-r--r-- 1 root root      42 Mar 16 11:32 edits_0000000000000010487-0000000000000010488
-rw-r--r-- 1 root root      42 Mar 16 11:33 edits_0000000000000010489-0000000000000010490
-rw-r--r-- 1 root root      42 Mar 16 11:34 edits_0000000000000010491-0000000000000010492
-rw-r--r-- 1 root root      42 Mar 16 11:35 edits_0000000000000010493-0000000000000010494
-rw-r--r-- 1 root root      42 Mar 16 11:36 edits_0000000000000010495-0000000000000010496
-rw-r--r-- 1 root root      42 Mar 16 11:37 edits_0000000000000010497-0000000000000010498
-rw-r--r-- 1 root root      42 Mar 16 11:38 edits_0000000000000010499-0000000000000010500
-rw-r--r-- 1 root root      42 Mar 16 11:39 edits_0000000000000010501-0000000000000010502
-rw-r--r-- 1 root root      42 Mar 16 11:40 edits_0000000000000010503-0000000000000010504
-rw-r--r-- 1 root root      42 Mar 16 11:41 edits_0000000000000010505-0000000000000010506
-rw-r--r-- 1 root root      42 Mar 16 11:42 edits_0000000000000010507-0000000000000010508
-rw-r--r-- 1 root root      42 Mar 16 11:43 edits_0000000000000010509-0000000000000010510
-rw-r--r-- 1 root root      42 Mar 16 11:44 edits_0000000000000010511-0000000000000010512
-rw-r--r-- 1 root root      42 Mar 16 11:45 edits_0000000000000010513-0000000000000010514
-rw-r--r-- 1 root root      42 Mar 16 11:46 edits_0000000000000010515-0000000000000010516
-rw-r--r-- 1 root root      42 Mar 16 11:47 edits_0000000000000010517-0000000000000010518
-rw-r--r-- 1 root root      42 Mar 16 11:48 edits_0000000000000010519-0000000000000010520
-rw-r--r-- 1 root root      42 Mar 16 11:49 edits_0000000000000010521-0000000000000010522
-rw-r--r-- 1 root root      42 Mar 16 11:50 edits_0000000000000010523-0000000000000010524
-rw-r--r-- 1 root root      42 Mar 16 11:51 edits_0000000000000010525-0000000000000010526
-rw-r--r-- 1 root root      42 Mar 16 11:52 edits_0000000000000010527-0000000000000010528
-rw-r--r-- 1 root root      42 Mar 16 11:53 edits_0000000000000010529-0000000000000010530
-rw-r--r-- 1 root root      42 Mar 16 11:54 edits_0000000000000010531-0000000000000010532
-rw-r--r-- 1 root root      42 Mar 16 11:55 edits_0000000000000010533-0000000000000010534
-rw-r--r-- 1 root root      42 Mar 16 11:56 edits_0000000000000010535-0000000000000010536
-rw-r--r-- 1 root root 1048576 Mar 16 11:56 edits_inprogress_0000000000000010537
-rw-r--r-- 1 root root     322 Mar 12 20:05 fsimage_0000000000000000000
-rw-r--r-- 1 root root      62 Mar 12 20:05 fsimage_0000000000000000000.md5
-rw-r--r-- 1 root root       6 Mar 16 11:56 seen_txid
-rw-r--r-- 1 root root     214 Mar 12 20:05 VERSION
[root@thtf-01 current]# 
</code></pre></div><ol><li><p>为什么会有这么多 edits文件？</p> <p>这些edits 文件创建的时间都是间隔1个小时，这是因为每隔1小时，SecondaryNameNode 都会对 edits 和 fsimage 进行一次合并，合并之后，旧的 edits 并不会被删除，依旧被保留。</p></li> <li><p>edits_inprogress… 文件作用？</p> <p>最新的一个edtis文件，用来记录用户的上传、删除操作。</p></li> <li><p>那我们看 fsimage 只保留两个文件。</p> <p><strong>fsimage… .md5</strong>： 是对应文件的md5值文件，用来保证 fsimage的一致性的。</p> <p><strong>seen_txid</strong>：里面保存了最新的一个 edits 文件的名字 最后的三位：107.</p> <p>NameNode 格式化后 第一次启动时，会创建一个 edits 和 fsimage 文件，后面再次启动时，直接加载 每个 edits 和最新的 fsimage 文件。</p></li> <li><p>为什么要每个 edits 都加载呢？fsimage不是已经保存之前 edits日志当中转换后的 元数据了么？</p> <p>这是为了再做一次校验的工作，确保加载到内存当中的元数据是可靠的。</p></li> <li><p>Edits 文件是用来做什么的？为什么要保留这么多 edtis文件，像 fsimage一样保存一两个文件不就可以了么？</p> <p>1）edits是用来存放 用户的 上传、删除请求的日志的。当用户上传成功，这条记录会保存到 内存元数据当中。也就是说，edits是作为一个中间文件。</p> <p>2）当 secondarynamenode 对 edtis 和 fsimage 进行合并时，会创建一个新的 edits 文件，以接收在合并期间 来的新的 用户上传请求。所以，每次触发 Secondaryname 的 checkpoint（也就是对edits和 fsimage 合并），都会产生一个新的 edtis 文件。</p></li> <li><p>旧的 edtis 文件一直会保留，会不会有一天 edits把空间沾满了啊？还有 fsimage，它保留了所有 block块的信息，总有一天会很大吧？</p> <p>这个问题其实我们不用担心，因为 edtis 和 fsimage 只是保留了 每个文件的位置等的信息，这些信息经过很长时间也不会占用多少空间的。</p> <p>但也会遇到小文件太多的问题，比如下面场景：</p> <table><thead><tr><th>文件</th> <th>NameNode内存占用</th> <th>DataNode磁盘占用</th></tr></thead> <tbody><tr><td>128MB</td> <td>一个block块的元数据信息 1KB</td> <td>128MB</td></tr> <tr><td>128MB*10000个文件</td> <td>10000block块元数据信息：10MB</td> <td>128MB</td></tr></tbody></table> <p>HDFS最初是为流式访问大文件开发的，如果访问大量小文件，需要不断的从一个datanode跳到另一个datanode，严重影响性能。</p> <p>引申出问题：</p> <p>（1）NameNode所在的物理节点内存应该多给一点</p> <p>（2）理论上hdfs是可以无限扩充的，因此可以在横向上扩展无数个节点。但是因为NameNode实际只能有一个运行，所以hdfs的上限容量受制于NameNode的内存上限容量。</p></li></ol> <h2 id="hdfs-命令行客户端基本操作"><a href="#hdfs-命令行客户端基本操作" class="header-anchor">#</a> HDFS 命令行客户端基本操作</h2> <h3 id="客户端理解"><a href="#客户端理解" class="header-anchor">#</a> 客户端理解</h3> <p>HDFS 的客户端有多种形式：</p> <ul><li>网页形式</li> <li>命令行形式</li></ul> <p>客户端在哪里运行，没有约束，只要运行客户端的机器能够跟 HDFS 集群联网。</p> <blockquote><p>注意：文件的切块大小和存储的福本数量，都是由客户端决定的！</p></blockquote> <p>所谓客户端决定，是通过配置参数类定的。HDFS 的客户端会读取以下两个参数，来决定切块大小和副本数量：</p> <ul><li>切块大小参数：dfs.blocksize</li> <li>副本数量的参数：dfs.replication</li></ul> <p>上面两个参数在 hdfs-site.xml 中配置：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.blocksize<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>128m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.replication<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="hdfs-命令行客户端的常用操作命令"><a href="#hdfs-命令行客户端的常用操作命令" class="header-anchor">#</a> HDFS 命令行客户端的常用操作命令</h3> <ol><li><p>查看 HDFS 目录信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop fs -ls /hdfs目录
</code></pre></div></li> <li><p>在 HDFS 中创建文件夹</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -mkdir -p /aa/bb/cc
</code></pre></div></li> <li><p>移动 HDFS 中的文件（改名）</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -mv /hdfs路径	/hdfs另一个路径
</code></pre></div></li> <li><p>上传文件到 HDFS 中</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -put /本地文件 /hdfs目录
hadoop fs -copyFromLocal/本地文件	/hdfs目录   <span class="token comment">## copyFromLocak == put</span>
hadoop fs -moveFromLocal/本地文件	/hdfs目录		<span class="token comment">## 从本地移动到hdfs</span>
</code></pre></div></li> <li><p>下载文件到客户端本地</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -get /hdfs中的文件	/本地目录
hadoop fs -copyToLocal/hdfs中的文件	/本地目录	<span class="token comment">## copyToLocal == get</span>
hadoop fs -moveToLocal/hdfs中的文件 /本地目录	<span class="token comment">## 从 hdfs 中移动到本地</span>
</code></pre></div></li> <li><p>删除 HDFS 中的文件或文件夹</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs <span class="token function">rm</span> -r /hdfs目录或文件
</code></pre></div></li> <li><p>修改文件的权限</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -chown user:group /hdfs文件
hadoop fs -chmod <span class="token number">777</span> /hdfs文件
</code></pre></div></li> <li><p>追加内容到已有文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -appendToFile /本地文件	/hdfs文件
</code></pre></div></li> <li><p>显示文本文件内容</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hadoop fs -cat /hdfs文件
hadoop fs -tail /hdfs文件 
</code></pre></div></li></ol> <h2 id="hdfs-的-javaapi"><a href="#hdfs-的-javaapi" class="header-anchor">#</a> HDFS 的 JavaAPI</h2> <h3 id="开发环境准备"><a href="#开发环境准备" class="header-anchor">#</a> 开发环境准备</h3> <ol><li>在本地解压Hadoop安装包</li> <li>在环境变量中配置：HADOOP_HOME</li> <li>创建 SpringBoot 工程,引入 Hadoop 依赖包</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- hadoop-hdfs --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- hadoop-common --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">FSDataOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">After</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Before</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>
    <span class="token class-name">FileSystem</span> fs<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 手动设置连接信息</span>
        <span class="token comment">//configuration.set(&quot;fs.defaultFS&quot;, &quot;&quot;)</span>
        configuration<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;core-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs-site.xml &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        fs <span class="token operator">=</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@After</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upload1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">copyFromLocalFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/本地文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upload2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;/本地文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FSDataOutputStream</span> outputStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copyBytes</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>权限不足解决方案</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>security<span class="token punctuation">.</span><span class="token class-name">AccessControlException</span><span class="token operator">:</span> <span class="token class-name">Permission</span> denied<span class="token operator">:</span> user<span class="token operator">=</span>wolf<span class="token punctuation">,</span> access<span class="token operator">=</span>WRITE<span class="token punctuation">,</span> inode<span class="token operator">=</span><span class="token string">&quot;/&quot;</span><span class="token operator">:</span>root<span class="token operator">:</span>supergroup<span class="token operator">:</span>drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><ul><li><p>方案一：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>方案二：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>java -jar xxxx -DHADOOP_USER_NAME<span class="token operator">=</span>root
</code></pre></div></li> <li><p>方案三：</p> <blockquote><p>将权限检查机制关闭：ect/hadoop/hdfs-site.xml:</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.permissions.enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span>
	<span class="token attr-name">&lt;value</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h3 id="下载文件"><a href="#下载文件" class="header-anchor">#</a> 下载文件</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">download1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">copyToLocalFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/hdfs文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/本地目录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">download2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">FSDataOutputStream</span> outputStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/本地目录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copyBytes</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建文件夹"><a href="#创建文件夹" class="header-anchor">#</a> 创建文件夹</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/a/b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="删除文件"><a href="#删除文件" class="header-anchor">#</a> 删除文件</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 递归删除</span>
  <span class="token keyword">boolean</span> delete <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="递归查询目录下所有文件列表"><a href="#递归查询目录下所有文件列表" class="header-anchor">#</a> 递归查询目录下所有文件列表</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">RemoteIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">&gt;</span></span> remoteIterator <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>remoteIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LocatedFileStatus</span> fileStatus <span class="token operator">=</span> remoteIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> fileStatus<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="判断文件是否存在"><a href="#判断文件是否存在" class="header-anchor">#</a> 判断文件是否存在</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">boolean</span> exists <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="回收站"><a href="#回收站" class="header-anchor">#</a> 回收站</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">trash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">Trash</span> trash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Trash</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> b <span class="token operator">=</span> trash<span class="token punctuation">.</span><span class="token function">moveToTrash</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hdfs客户端编程应用场景-数据采集"><a href="#hdfs客户端编程应用场景-数据采集" class="header-anchor">#</a> HDFS客户端编程应用场景：数据采集</h3> <p><img src="/study/assets/img/1240.116f080e.png" alt=""></p> <h4 id="需求描述"><a href="#需求描述" class="header-anchor">#</a> 需求描述</h4> <p>在业务系统服务器上，业务程序会不断生成业务日志（比如网站的访问日志）</p> <p>业务日志是用log4j生成的，会不断的切出日志文件</p> <p>需要定期（如：每小时）从业务服务器上的日志文件中，探测需要采集的日志文件（access.log)，发往HDFS</p> <p>注意点：业务服务器可能有多台（hdfs上的文件名不能直接用日志服务器上的文件名）</p> <p>当天采集的日志要放在hdfs的当天目录中</p> <p>采集完成的日志文件，需要移动到日志服务器的一个备份目录中</p> <p>定期检查（一小时检查一次）备份目录，将备份时长超过24小时的日志文件清除</p> <h4 id="数据采集设计"><a href="#数据采集设计" class="header-anchor">#</a> 数据采集设计</h4> <p><strong>1、流程</strong></p> <p>启动一个定时任务</p> <ul><li>定时探测日志源目录</li> <li>获取需要采集的文件</li> <li>移动这些文件到一个待上传的临时目录</li> <li>遍历待上传目录中的各个文件，逐一传输到HDFS的目标路径，同时将传输完成的文件移动到备份目录</li></ul> <p>启动一个定时任务</p> <ul><li>探测备份目录中的备份数据，检查是否已超出最长备份时长，如果超出，则删除</li></ul> <p><strong>2、规划各种路径</strong></p> <p>日志源路径：/Users/wolf/logs/access</p> <p>待上传临时目录：/Users/wolf/logs /tmp</p> <p>备份目录：/Users/wolf/logs/backup/日期</p> <p>HDFS存储路径：/logs/日期</p> <p>HDFS文件前缀：access_log_</p> <p>HDFS文件后缀：.log</p> <h4 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h4> <p>配置文件：collect.properties</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">LOG_SOURCE_DIR</span><span class="token punctuation">=</span><span class="token attr-value">/logs/access/</span>
<span class="token attr-name">LOG_TMP_DIR</span><span class="token punctuation">=</span><span class="token attr-value">/logs/tmp/</span>
<span class="token attr-name">LOG_BACKUP_BASE_DIR</span><span class="token punctuation">=</span><span class="token attr-value">/logs/backup/</span>
<span class="token attr-name">LOG_BACKUP_TIMEOUT</span><span class="token punctuation">=</span><span class="token attr-value">24</span>

<span class="token attr-name">HDFS_DEST_BASE_DIR</span><span class="token punctuation">=</span><span class="token attr-value">/logs</span>
<span class="token attr-name">HDFS_FILE_PREFIX</span><span class="token punctuation">=</span><span class="token attr-value">access_log_</span>
<span class="token attr-name">HDFS_FILE_SUFFIX</span><span class="token punctuation">=</span><span class="token attr-value">.log</span>
</code></pre></div><p>配置常量池： Constants.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Constants</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOG_SOURCE_DIR <span class="token operator">=</span> <span class="token string">&quot;LOG_SOURCE_DIR&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOG_TMP_DIR <span class="token operator">=</span> <span class="token string">&quot;LOG_TMP_DIR&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOG_BACKUP_BASE_DIR <span class="token operator">=</span> <span class="token string">&quot;LOG_BACKUP_BASE_DIR&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOG_BACKUP_TIMEOUT <span class="token operator">=</span> <span class="token string">&quot;LOG_BACKUP_TIMEOUT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HDFS_DEST_BASE_DIR <span class="token operator">=</span> <span class="token string">&quot;HDFS_DEST_BASE_DIR&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HDFS_FILE_PREFIX <span class="token operator">=</span> <span class="token string">&quot;HDFS_FILE_PREFIX&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HDFS_FILE_SUFFIX <span class="token operator">=</span> <span class="token string">&quot;HDFS_FILE_SUFFIX&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>配置文件加载类：PropertyHolder.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertyHolder</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Properties</span> prop<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Properties</span> <span class="token function">getProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">PropertyHolder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    prop<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">PropertyHolder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;collect.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> prop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>日志收集task：CollectTask.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CollectTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CollectTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// - 定时探测日志源目录</span>
        <span class="token comment">// - 获取需要采集的文件</span>
        <span class="token comment">// - 移动这些文件到一个待上传的临时目录</span>
        <span class="token comment">// - 遍历待上传目录中的各个文件，逐一传输到HDFS的目标路径，同时将传输完成的文件移动到备份目录</span>

        <span class="token comment">// 获取本地采集是的日期</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd-HH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 构造一个HDFS的客户端对象</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token class-name">PropertyHolder</span><span class="token punctuation">.</span><span class="token function">getProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">File</span> srcDir  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOG_SOURCE_DIR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 列出日志源目录中需要采集的文件</span>
            <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> listFiles <span class="token operator">=</span> srcDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">File</span> dir<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;access.log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>listFiles<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;探测到如下文件需要采集为空！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;探测到如下文件需要采集：{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>listFiles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将要采集的文件移动到待上传临时目录</span>
            <span class="token class-name">File</span> tmpDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOG_TMP_DIR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> listFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">moveFileToDirectory</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> tmpDir<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 手动设置连接信息</span>
            <span class="token comment">//configuration.set(&quot;fs.defaultFS&quot;, &quot;&quot;)</span>
            configuration<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;core-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configuration<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs-site.xml &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 检查HDFS的日期目录是否存在，不存在就创建</span>
            <span class="token class-name">Path</span> hdfsDatePath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>HDFS_DEST_BASE_DIR<span class="token punctuation">)</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>hdfsDatePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span>hdfsDatePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> toUploadFiles <span class="token operator">=</span> tmpDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> toUploadFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Path</span> destPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>hdfsDatePath <span class="token operator">+</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>HDFS_FILE_PREFIX<span class="token punctuation">)</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>HDFS_FILE_SUFFIX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 传输文件到HDFS并修改名称</span>
                fs<span class="token punctuation">.</span><span class="token function">copyFromLocalFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> destPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;文件上传hdfs完成：{} --&gt; {}&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> destPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">File</span> backupDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOG_BACKUP_BASE_DIR<span class="token punctuation">)</span> <span class="token operator">+</span> date <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">moveFileToDirectory</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> backupDir<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;文件备份完成：{} --&gt; {}&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> backupDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>日志备份清理task：BackupCleanTask.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TimerTask</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackupCleanTask</span> <span class="token keyword">extends</span> <span class="token class-name">TimerTask</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">BackupCleanTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * The action to be performed by this timer task.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;定时清理任务开始执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取本地采集是的日期</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd-HH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 探测本地备份目录</span>
            <span class="token class-name">File</span> backupBaseDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;/Users/wolf/logs/backup/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateBackDir <span class="token operator">=</span> backupBaseDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 判断备份日期子目录是否已经超过24小时</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> dir <span class="token operator">:</span> dateBackDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">isHidden</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> time <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>now <span class="token operator">-</span> time<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">deleteDirectory</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;备份目录：{} 清理完毕！&quot;</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定时任务main函数：DataCollectMain.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Timer</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataCollectMain</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定时数据收集</span>
        timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CollectTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定时清理历史数据备份</span>
        timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BackupCleanTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hdfs版的wordcount"><a href="#hdfs版的wordcount" class="header-anchor">#</a> HDFS版的wordcount</h3> <p>HdfsWordCount.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStreamReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URI<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HdfsWordCount</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">HdfsWordCount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;job.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mapper_impl_class <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;MAPPER_IMPL_CLASS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mapper</span> mapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Mapper</span><span class="token punctuation">)</span> mapper_impl_class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 去hdfs中读取文件：一次读一行</span>
        <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">URI</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs://10.10.50.189:9000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RemoteIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/wordcount/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">LocatedFileStatus</span> file <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FSDataInputStream</span> in <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 调用一个方法对每一行进行业务处理</span>
                mapper<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> contextMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getContextMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Path</span> outPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/wordcount/output/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span>outPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">FSDataOutputStream</span> out <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/wordcount/output/res.dat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entrySet <span class="token operator">=</span> contextMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entrySet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据统计完成！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>job.properties</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">MAPPER_IMPL_CLASS</span><span class="token punctuation">=</span><span class="token attr-value">com.pyy.wordcount.WordCountMapper</span>
</code></pre></div><p>Mapper.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Mapper</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>WordCountMapper.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordCountMapper</span> <span class="token keyword">implements</span> <span class="token class-name">Mapper</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>value<span class="token punctuation">;</span>
                context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> v<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Context.java</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> contextMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contextMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> contextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getContextMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> contextMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>统计文件：</p> <p>a.txt:</p> <div class="language- extra-class"><pre class="language-text"><code>hello tom
hello jim
hello jeca
hello kata
hello wolf
</code></pre></div><p>b.txt</p> <div class="language- extra-class"><pre class="language-text"><code>hello tom
hello jim
hello jeca
hello kata
hello wolf
</code></pre></div><p>c.txt</p> <div class="language- extra-class"><pre class="language-text"><code>hello tom
hello jim
hello jeca
hello kata
hello wolf
</code></pre></div><p>d.txt</p> <div class="language- extra-class"><pre class="language-text"><code>hello tom
hello jim
hello jeca
hello kata
hello wolf
</code></pre></div><p>统计结果：</p> <p>rst.dat</p> <div class="language- extra-class"><pre class="language-text"><code>kata    4
tom     4
wolf    4
jeca    4
hello   20
jim     4
</code></pre></div><h2 id="mapreduce"><a href="#mapreduce" class="header-anchor">#</a> MapReduce</h2> <h3 id="mapreduce-是什么"><a href="#mapreduce-是什么" class="header-anchor">#</a> MapReduce 是什么？</h3> <blockquote><p>MapReduce是一种编程模型，用于大规模数据集（大于1TB）的并行运算。概念&quot;Map（映射）&quot;和&quot;Reduce（归约）&quot;，是它们的主要思想，都是从函数式编程语言里借来的，还有从矢量编程语言里借来的特性。它极大地方便了编程人员在不会分布式并行编程的情况下，将自己的程序运行在<a href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener noreferrer">分布式系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上。 当前的软件实现是指定一个Map（映射）函数，用来把一组键值对映射成一组新的键值对，指定并发的Reduce（归约）函数，用来保证所有映射的键值对中的每一个共享相同的键组。(摘自百度百科)</p></blockquote> <h3 id="为什么要使用mr"><a href="#为什么要使用mr" class="header-anchor">#</a> 为什么要使用MR？</h3> <p>上面我们写的HDFS版wordcount程序：统计hdfs的/wordcount/input/a.txt文件中的单词出现个数</p> <p>明白了一点：可以在任何地方运行程序，访问HDFS上的文件并进行统计运算，并且可以把统计结果写回HDFS的结果文件中。</p> <p>但是，进一步思考：如果文件又多又大，用上面的代码有什么弊端？</p> <p><strong>慢！因为只有一台机器在进行运算处理。</strong></p> <p>如何变的更快？</p> <p>核心思路：让我们的程序并行在多台机器上执行。</p> <h3 id="mapreduce-框架"><a href="#mapreduce-框架" class="header-anchor">#</a> MapReduce 框架</h3> <p>分两个阶段：</p> <ul><li>map阶段 -- 程序MapTask</li> <li>reduce阶段 -- 程序ReduceTask</li></ul> <h3 id="mapreduce具有的特点"><a href="#mapreduce具有的特点" class="header-anchor">#</a> MapReduce具有的特点</h3> <p>总所周知MapReduce是一种很受欢迎的软件框架，尤其是我们国家发展到现在互联网的浪潮愈演愈烈，那么它都有什么特点呢？</p> <ul><li><strong>易于编程</strong>：MapReduce通过相应的接口，程序员只需要简单的调用就可以完成对一个复杂的分布式程序的编写。</li> <li><strong>易扩展性</strong>：在计算资源不足时可以通过增加机器来增加计算能力。</li> <li><strong>高容错性</strong>：要知道MapReduce的提出就是为了运行在廉价的商用pc中，而商用pc得到问题也是颇多，经常会出现pc挂掉的情况，这时候就需要可以迅速的把计算任何和资源转移到另外的一个节点上运行，从而保证任务、作业的顺利运行。</li> <li><strong>海量PB级数据的离线处理</strong>：所谓离线处理即为它不具体毫秒级别的迅速反馈能力，在对反馈要求非常及时的场景下，自然是不可用的</li></ul> <p>那么MapReduce有哪些不适合的场景呢？</p> <ul><li><strong>实时计算</strong>：没有mysql等数据库的毫秒级反馈能力。</li> <li><strong>流式计算</strong>：流式计算的输入数据时动态的，而 MapReduce 的输入数据集是静态的，不能动态变化。这是因为 MapReduce 自身的设计特点决定了数据源必须是静态的。</li> <li><strong>DAG(有向图)模式</strong>：即每个作业或者任务之间都有很强的连接性，下一个作业的运行需要另外一个作业的运行结果的数据，这种情况下MapReduce的性能非常低，因为每个MapReduce的作业都会把计算写入到磁盘中，若如此做则会造成大量的磁盘IO,性能低下。</li></ul> <h3 id="mapreduce-实例"><a href="#mapreduce-实例" class="header-anchor">#</a> MapReduce 实例</h3> <p>为了分析 MapReduce 的编程模型，这里我们以 WordCount 为实例。就像 Java、C++等编程语言的入门程序 hello word 一样，WordCount 是 MapReduce 最简单的入门程序。下面我们就来逐步分析。</p> <p><strong>1. 场景</strong>：假如有大量的文件，里面存储的都是单词。</p> <p>类似应用场景：WordCount 虽然很简单，但它是很多重要应用的模型。</p> <ul><li>搜索引擎中，统计最流行的 K 个搜索词。</li> <li>统计搜索词频率，帮助优化搜索词提示。</li></ul> <p><strong>2. 任务</strong>：我们该如何统计每个单词出现的次数？</p> <p><strong>3. 将问题规范为</strong>：有一批文件（规模为 TB 级或者 PB 级），如何统计这些文件中所有单词出现的次数。</p> <p><strong>4. 解决方案</strong>：首先，分别统计每个文件中单词出现的次数；然后，累加不同文件中同一个单词出现次数。</p> <h3 id="mapreduce-版-wordcount-代码实现"><a href="#mapreduce-版-wordcount-代码实现" class="header-anchor">#</a> MapReduce 版 wordcount 代码实现</h3> <ul><li><p>第一步：导入maven依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- hadoop-client --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>第二步：编写WordcountMapper.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>mr</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">LongWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * KEYIN: 是一行的起始偏移量 Long
 * VALUEIN：是一行的内容 String
 *
 * KEYOUT：用户自定义map方法要返回的结果kv数据的key的类型，在wordcount中，我们需要返回的是单词 String
 * VALUEOUT： 用户自定义map方法要返回的结果kv数据的value的类型，在wordcount中，我们需要返回的是整数 Integer
 *
 * 但是，MapReduce中，map产生的数据要传输为 reduce，需要进行序列化和反序列化，而原生jdk序列化产生的数据量比较冗余
 * 就会导致数据在MapReduce运行过程效率低，所有，hadoop专门设计了自己的序列化机制，那么，mapreduce中传输的数据类型就必须
 * 要实现hadoop自己的序列化接口
 *
 * hadoop为jdk中的常用数据类型 Long String Integer Float等数据类型封装了自己的实现Hadoop序列化接口类型：LongWritable，Text，IntWritable, FloatWritable
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordcountMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LongWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">LongWritable</span> key<span class="token punctuation">,</span> <span class="token class-name">Text</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 切单词</span>
        <span class="token class-name">String</span> line <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>编写 WordcountReducer.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>mr</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Reducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WordcountReducer</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Text</span> key<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IntWritable</span> value <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count <span class="token operator">+=</span> value<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="mapreduce-执行流程"><a href="#mapreduce-执行流程" class="header-anchor">#</a> MapReduce 执行流程</h3> <p>通过上面的分析可知，它其实就是一个典型的 MapReduce 过程。下面我们通过示意图来分析 MapReduce 过程。</p> <p><img src="/study/assets/img/mapreduce.5726c0ba.png" alt=""></p> <p>上图流程大致分为以下几步：</p> <ul><li><p>第一步：假设一个文件有三行英文单词作为 MapReduce 的input（输入），这里经过 Splitting 过程把文件分割为3块。分割后的3块数据就可以并行处理，每一块交给一个 maptask 处理。</p></li> <li><p>第二步：每个 maptask 中，以每个单词为key，以1作为词频数value，然后输出。</p></li> <li><p>第三步：每个 maptask 的输出要经过 shuffling（混洗），将相同的单词key放在同一个桶里面，然后交给 reducetask 处理。</p></li> <li><p>第四步：reduce 接收到 shuffling 后的数据，会将相同单词进行合并，得到每个单词的词频数，最后将统计好的每个单词的词频数作为输出结果。</p></li></ul> <p>上述就是 MapReduce 的大致流程，前两步可以看做是 Map 阶段，后两步可以看成 Reduce阶段。</p> <p>具体如何执行，我们还需要借助于 YARN。</p> <h3 id="yarn简介"><a href="#yarn简介" class="header-anchor">#</a> YARN简介</h3> <blockquote><p>Apache Hadoop YARN （Yet Another Resource Negotiator，另一种资源协调者）是一种新的 Hadoop 资源管理器，它是一个通用资源管理系统，可为上层应用提供统一的资源管理和调度，它的引入为集群在利用率、资源统一管理和数据共享等方面带来了巨大好处。（摘自百度百科）</p></blockquote> <h3 id="yarn架构"><a href="#yarn架构" class="header-anchor">#</a> YARN架构</h3> <p><img src="https://hadoop.apache.org/docs/r2.9.1/hadoop-yarn/hadoop-yarn-site/yarn_architecture.gif" alt="MapReduce NextGen Architecture"></p> <p>yarn是一个分布式程序的<strong>运行调度平台</strong></p> <p>yarn中有<strong>两大核心角色</strong>：</p> <p><strong>1、Resource Manager</strong></p> <p>接受用户提交的分布式计算程序，并为其划分资源</p> <p>管理、监控各个Node Manager上的资源情况，以便于均衡负载</p> <p><strong>2、Node Manager</strong></p> <p>管理它所在机器的运算资源（cpu + 内存）</p> <p>负责接受Resource Manager分配的任务，创建容器、回收资源</p> <h3 id="yarn-的安装"><a href="#yarn-的安装" class="header-anchor">#</a> YARN 的安装</h3> <p>NodeManager 在物理上应该跟 DataNode 部署在一起（方便任务执行）通过slaves文件设置</p> <p>ResourceManager 最好单独部署在一台专门的机器上。</p> <ol><li><p>修改配置文件：yarn-site.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.hostname<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdp-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.nodemanager.aux-services<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>mapreduce_shuffle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.framework.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>yarn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>拷贝配置文件：mapred-site.xml.template mapred-site.xml 设置job提交到哪里运行</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;configuration&gt;
  &lt;property&gt;
  	&lt;name&gt;mapreduce.framework.name&lt;/name&gt;
  	&lt;value&gt;yarn&lt;/value&gt;
	&lt;/property&gt;
&lt;/configuration&gt;
</code></pre></div></li> <li><p>scp 这个 yarn-site.xml mapped-site.xml 到其它节点</p></li> <li><p>启动 yarn 集群：start-yarn.sh （注：该命令应该在 ResourceManager 所在的机器上执行,就会在该机器上启动 RM）</p></li> <li><p>用 <code>jps</code> 检查 yarn 的进程，用 web 浏览器查看 yarn 的 web 控制台。</p> <p>http://10.10.50.189:8088</p> <p><img src="/study/assets/img/yarn.a055ed6e.png" alt=""></p></li></ol> <h3 id="运行上面的-wordcount-mr程序"><a href="#运行上面的-wordcount-mr程序" class="header-anchor">#</a> 运行上面的 wordcount mr程序</h3> <ol><li><p>接着上面的 wordcount 工程，编写 JobSubmitter 客户端类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">FileSystem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">FileInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">FileOutputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 提交 mapreduce job 的客户端
 * 功能：
 *  1. 封装本次job运行时需要的必要参数
 *  2. 跟yarn进行校核，将mapreduce程序成功的启动、运行
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JobSubmitter</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;core-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;yarn-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token string">&quot;mapred-site.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果要从windows上运行这个job提交客户端程序，则需要加这个跨平台提交的参数</span>
        <span class="token comment">//conf.set(&quot;mapreduce.app-submission.cross-platform&quot;, &quot;true&quot;);</span>
        <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1.封装参数：jar包所在位置</span>
        <span class="token comment">// job.setJar(&quot;/wc.jar&quot;)</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">JobSubmitter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.封装参数：本地job所要调用的Mapper实现类、Reducer实现类</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">WordcountMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">WordcountReducer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.封装参数：本次job的Mapper实现类、Reducer实现类产生的结果数据的key、value类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">setOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Path</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/wordcount/output/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4.封装参数：本次job要处理的封装的输入数据集所在路径、最终结果的输出路径。</span>
        <span class="token class-name">FileInputFormat</span><span class="token punctuation">.</span><span class="token function">setInputPaths</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/wordcount/input/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意：必须保证路径不存在</span>

        <span class="token comment">// 5.封装参数：想要启动的 reducer task的数量（默认1） （map task 自己根据切片自动）</span>
        job<span class="token punctuation">.</span><span class="token function">setNumReduceTasks</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6.提交job给yarn</span>
        <span class="token keyword">boolean</span> res <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>res <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>运行方式</p> <ul><li><p><strong>远程jar包部署</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 设置jar类加载器，否则找不到Mapper和Reducer</span>
job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">JobSubmitter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>打包 mvn clean package
上传 jar 包到 linux 系统
保证 hdfs 和 <span class="token function">yarn</span> 都正常启动和运行

通过 hadoop jar 命令运行
hadoop jar wc-1.0-SNAPSHOT.jar com.pyy.mr.JobSubmitter
</code></pre></div></li> <li><p><strong>跨平台提交</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 如果要从非linux上运行这个job提交客户端程序，则需要加这个跨平台提交的参数</span>
conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.app-submission.cross-platform&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或配置 mapred-site.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
  		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.framework.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>yarn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.app-submission.cross-platform<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>设置jar包路径</p> <div class="language-java extra-class"><pre class="language-java"><code> job<span class="token punctuation">.</span><span class="token function">setJar</span><span class="token punctuation">(</span><span class="token string">&quot;/wc.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//系统会通过网络将jar删除到yarn</span>
</code></pre></div></li></ul></li> <li><p>去hdfs的输出目录查看结果。</p> <p><img src="/study/assets/img/wc_res.94dccd2d.png" alt=""></p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/fen-bu-shi/nao-lie-shi-shi-me-.html" class="prev">
        脑裂是什么？Zookeeper是如何解决的
      </a></span> <span class="next"><a href="/study/da-shu-ju/" class="router-link-active">
        介绍
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study/assets/js/app.7f558c8e.js" defer></script><script src="/study/assets/js/2.6c6da70f.js" defer></script><script src="/study/assets/js/10.c4e17556.js" defer></script>
  </body>
</html>
