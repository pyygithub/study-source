<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hive | PYY在线笔记文档</title>
    <meta name="description" content="PYY在线笔记文档">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/study/img/logo.png">
    
    <link rel="preload" href="/study/assets/css/0.styles.adf990bf.css" as="style"><link rel="preload" href="/study/assets/js/app.805d6976.js" as="script"><link rel="preload" href="/study/assets/js/2.d79867de.js" as="script"><link rel="preload" href="/study/assets/js/9.7fd67b26.js" as="script"><link rel="prefetch" href="/study/assets/js/10.8f6cc0bc.js"><link rel="prefetch" href="/study/assets/js/11.80afb327.js"><link rel="prefetch" href="/study/assets/js/12.202c1bb3.js"><link rel="prefetch" href="/study/assets/js/13.c0659ce7.js"><link rel="prefetch" href="/study/assets/js/14.2e675df6.js"><link rel="prefetch" href="/study/assets/js/15.478fef0f.js"><link rel="prefetch" href="/study/assets/js/16.e3882713.js"><link rel="prefetch" href="/study/assets/js/17.15b2bc97.js"><link rel="prefetch" href="/study/assets/js/18.e3f7e58b.js"><link rel="prefetch" href="/study/assets/js/19.7df53965.js"><link rel="prefetch" href="/study/assets/js/20.095604ea.js"><link rel="prefetch" href="/study/assets/js/21.025c2b93.js"><link rel="prefetch" href="/study/assets/js/3.373a8979.js"><link rel="prefetch" href="/study/assets/js/4.66dbe83c.js"><link rel="prefetch" href="/study/assets/js/5.f2f75567.js"><link rel="prefetch" href="/study/assets/js/6.40dc09d8.js"><link rel="prefetch" href="/study/assets/js/7.f16429f3.js"><link rel="prefetch" href="/study/assets/js/8.ace670df.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.adf990bf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记文档" class="logo"> <span class="site-name can-hide">PYY在线笔记文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/pyy-admin-x" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/pyy-admin-x" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dev Ops</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>大数据</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/大数据/Hadoop.html" class="sidebar-link">Hadoop</a></li><li><a href="/study/%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="sidebar-link">介绍</a></li><li><a href="/study/大数据/Azkaban.html" class="sidebar-link">Azkaban</a></li><li><a href="/study/大数据/ElasticSearch.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/study/大数据/Flume.html" class="sidebar-link">Flume</a></li><li><a href="/study/大数据/HBase.html" class="sidebar-link">HBase</a></li><li><a href="/study/大数据/Hive.html" class="active sidebar-link">Hive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#什么是数仓" class="sidebar-link">什么是数仓</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#主要特征" class="sidebar-link">主要特征</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#数据库与数据仓库的区别" class="sidebar-link">数据库与数据仓库的区别</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#数仓的分层架构" class="sidebar-link">数仓的分层架构</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#数仓的元数据管理" class="sidebar-link">数仓的元数据管理</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-的基本概念" class="sidebar-link">Hive 的基本概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-简介" class="sidebar-link">Hive 简介</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-架构" class="sidebar-link">Hive 架构</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-与-hadoop-的关系" class="sidebar-link">Hive 与 Hadoop 的关系</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-与传统数据库对比" class="sidebar-link">Hive 与传统数据库对比</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-安装和环境配置" class="sidebar-link">Hive 安装和环境配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-的三种连接方式" class="sidebar-link">Hive 的三种连接方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-数据库操作" class="sidebar-link">Hive 数据库操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#创建数据库" class="sidebar-link">创建数据库</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#创建数据库并指定位置" class="sidebar-link">创建数据库并指定位置</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#修改数据库" class="sidebar-link">修改数据库</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#查看数据库详细信息" class="sidebar-link">查看数据库详细信息</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#删除数据库" class="sidebar-link">删除数据库</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive表操作" class="sidebar-link">Hive表操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive表创建语法" class="sidebar-link">Hive表创建语法</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#管理表的操作" class="sidebar-link">管理表的操作</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#外部表的操作" class="sidebar-link">外部表的操作</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#分区表" class="sidebar-link">分区表</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#分桶表" class="sidebar-link">分桶表</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#修改表" class="sidebar-link">修改表</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#删除表" class="sidebar-link">删除表</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-表中加载数据" class="sidebar-link">hive 表中加载数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-查询语法" class="sidebar-link">Hive 查询语法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#select" class="sidebar-link">SELECT</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#查询语法" class="sidebar-link">查询语法</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#常用函数" class="sidebar-link">常用函数</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#limit-语句" class="sidebar-link">LIMIT 语句</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#where-语句" class="sidebar-link">WHERE 语句</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#分组" class="sidebar-link">分组</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#join-语句" class="sidebar-link">JOIN 语句</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#排序" class="sidebar-link">排序</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#hive-函数" class="sidebar-link">Hive 函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#内置函数" class="sidebar-link">内置函数</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#自定义函数" class="sidebar-link">自定义函数</a></li><li class="sidebar-sub-header"><a href="/study/大数据/Hive.html#udf-开发实例" class="sidebar-link">UDF 开发实例</a></li></ul></li></ul></li><li><a href="/study/大数据/Hue.html" class="sidebar-link">Hue</a></li><li><a href="/study/大数据/Kafka.html" class="sidebar-link">Kafka</a></li><li><a href="/study/大数据/Oozie.html" class="sidebar-link">Oozie</a></li><li><a href="/study/大数据/Sqoop.html" class="sidebar-link">Sqoop</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="hive"><a href="#hive" class="header-anchor">#</a> Hive</h1> <h2 id="什么是数仓"><a href="#什么是数仓" class="header-anchor">#</a> 什么是数仓</h2> <h3 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h3> <p>英文名称为Data Warehouse，可简写为 DW 或 DWH。数据仓库的目的是构建面向分析的集成化数据环境，为企业提供决策支持（Decision Support）。它出于分析性报告和决策支持的目的而创建。</p> <p>数据仓库本身并不“生产”任何数据，同时自身也不需要“消费”任何数据，数据来源于外界，并且开放给外部应用，这也是为什么叫“仓库&quot;，而不叫”工厂”的原因。</p> <h3 id="主要特征"><a href="#主要特征" class="header-anchor">#</a> 主要特征</h3> <p>数据仓库是面向主题的（Subject-Oriented）、集成的（Integrated）、非易失的（Non-Volatile）和时变的（Time-Variant）数据集合，用以支持管理决策。</p> <ul><li><p><strong>面向主题</strong></p> <p>面向主题性表示了数据仓库中数据组织的基本原则，数据仓库中的所有数据都是围绕着某一主题组织的。
确定主题以后，需要确定主题应该包含的数据。
不同的主题之间可能会出现相互重叠的信息。
主题在数据仓库中可以用多维数据库方式进行存储。
主题的划分中，必须保证每一个主题的独立性。</p> <p>一个主题领域的表来源于多个操作型应用（如：客户主题，来源于：定单处理、应收帐目、应付帐目…）；</p> <p>典型的主题领域：客户；产品；交易；帐目；
主题领域以一组相关的表来具体实现；
相关的表通过公共的键码联系起来（如：顾客标识号Customer ID）；
每个键码都有时间元素（从日期到日期；每月累积；单独日期…）；
主题内数据可以存储在不同介质上（综合级，细节级，多粒度）。</p></li> <li><p><strong>集成性</strong></p> <p>通过对分散、独立、异构的数据库数据进行抽取、清理、转换和汇总便得到了数据仓库的数据，这样保证了数据仓库内的数据关于整个企业的一性。</p> <p>数据仓库中的综合数据不能从原有的数据库系统直接得到。因此在数据进入数据仓库之前，必然要经过统一与综合，这一步是数据仓库建设中最关键、最复杂的一步，所要完成的工作有：</p> <ol><li><p>要统一源数据中所有矛盾之处，如字段的同名异义、异名同义、单位不统一、字长不一致，等等。</p></li> <li><p>进行数据综合和计算。数据仓库中的数据综合工作可以在从原有数据库抽取数据时生成，但许多是 在数据仓库内部生成的，即进入数据仓库以后进行综合生成的。</p></li></ol> <p>下图说明一个保险公司综合数据的简单处理过程，其中数据仓库中与“保险” 主题有关的数据来自于多个不同的操作型系统。这些系统内部数据的命名可能不同，数据格式也可能不同。把不同来源的数据存 储到数据仓库之前需要去除这些不一致。</p> <p><img src="/study/assets/img/etl.666295e1.png" alt=""></p> <blockquote><p>ETL分别代表：提取extraction、转换transformation、加载load。其中提取过程表示操作型数据库搜集指定数据，转换过程表示将数据转化为指定格式并进行数据清洗保证数据质量，加载过程表示将转换过后满足指定格式的数据加载进数据仓库。数据仓库会周期不断地从源数据库提取清洗好了的数据，因此也被称为&quot;目标系统&quot;；</p></blockquote></li> <li><p><strong>非易失性（不可更新性）</strong></p> <p>操作型数据库主要服务于日常的业务操作，使得数据库需要不断地对数据实时更新，以便迅速获得当前最新数据，不至于影响正常的业务运作。在数据仓库中只要保存过去的业务数据，不需要每一笔业务都实时更新数据仓库，而是根据商业需要每隔一段时间把一批较新的数据导入数据仓库。</p> <p>数据仓库的数据反映的是一段相当长的时间内历史数据的内容，是不同时点的数据库快照的集合，以及基于这些快照进行统计、综合和重组的导出数据。</p> <p>数据非易失性主要是针对应用而言。数据仓库的用户对数据的操作大多是数据查询或比较复杂的挖掘，一旦数据进入数据仓库以后，一般情况下被较长时间保留。数据仓库中一般有大量的查询操作，但修改和删除操作很少。因此，数据经加工和集成进入数据仓库后是极少更新的，通常只需要定期的加载和更新。</p></li> <li><p><strong>时变性</strong></p> <p>数据仓库包含各种粒度的历史数据。数据仓库中的数据可能与某个特定日期、星期、月份、季度或者年份有关。数据仓库的目的是通过分析企业过去一段时间业务的经营状况，挖掘其中隐藏的模式。虽然数据仓库的用户不能修改数据，但并不是说数据仓库的数据是永远不变的。分析的结果只能反映过去的情况，当业务变化后，挖掘出的模式会失去时效性。因此数据仓库的数据需要更新，以适应决策的需要。</p> <p>从这个角度讲，数据仓库建设是一个项目，更是一个过程 。数据仓库的数据随时间的变化表现在以下几个方面。</p> <ol><li><p>数据仓库的数据时限一般要远远长于操作型数据的数据时限。</p></li> <li><p>操作型系统存储的是当前数据，而数据仓库中的数据是历史数据。</p></li> <li><p>数据仓库中的数据是按照时间顺序追加的，它们都带有时间属性。</p></li></ol></li></ul> <h3 id="数据库与数据仓库的区别"><a href="#数据库与数据仓库的区别" class="header-anchor">#</a> 数据库与数据仓库的区别</h3> <p>数据库与数据仓库的区别实际讲的是 OLTP 与 OLAP 的区别。</p> <p>操作型处理，叫联机事务处理 OLTP（On-Line Transaction Processing，），也可以称面向交易的处理系统，它是针对具体业务在数据库联机的日常操作，通常对少数记录进行查询、修改。用户较为关心操作的响应时间、数据的安全性、完整性和并发支持的用户数等问题。传统的数据库系统作为数据管理的主要手段，主要用于操作型处理。</p> <p>分析型处理，叫联机分析处理 OLAP（On-Line Analytical Processing）一般针对某些主题的历史数据进行分析，支持管理决策</p> <p>首先要明白，数据仓库的出现，并不是要取代数据库。</p> <ul><li><p>数据库是面向事务的设计，数据仓库是面向主题设计的。</p></li> <li><p>数据库一般存储业务数据，数据仓库存储的一般是历史数据。</p></li> <li><p>数据库设计是尽量避免冗余，一般针对某一业务应用进行设计，比如一张简单的User表，记录用户名、密码等简单数据即可，符合业务应用，但是不符合分析。数据仓库在设计是有意引入冗余，依照分析需求，分析维度、分析指标进行设计。</p></li> <li><p>数据库是为<strong>捕获</strong>数据而设计，数据仓库是为<strong>分析</strong>数据而设计。</p></li></ul> <p>以银行业务为例。数据库是事务系统的数据平台，客户在银行做的每笔交易都会写入数据库，被记录下来，这里，可以简单地理解为用数据库记账。数据仓库是分析系统的数据平台，它从事务系统获取数据，并做汇总、加工，为决策者提供决策的依据。比如，某银行某分行一个月发生多少交易，该分行当前存款余额是多少。如果存款又多，消费交易又多，那么该地区就有必要设立ATM了。</p> <p>显然，银行的交易量是巨大的，通常以百万甚至千万次来计算。事务系统是实时的，这就要求时效性，客户存一笔钱需要几十秒是无法忍受的，这就要求数据库只能存储很短一段时间的数据。而分析系统是事后的，它要提供关注时间段内所有的有效数据。这些数据是海量的，汇总计算起来也要慢一些，但是，只要能够提供有效的分析数据就达到目的了。</p> <p><strong>数据仓库，是在数据库已经大量存在的情况下，为了进一步挖掘数据资源、为了决策需要而产生的，它决不是所谓的</strong>“<strong>大型数据库</strong>”。</p> <h3 id="数仓的分层架构"><a href="#数仓的分层架构" class="header-anchor">#</a> 数仓的分层架构</h3> <p>按照数据流入流出的过程，数据仓库架构可分为三层——源数据、数据仓库、数据应用。</p> <p><img src="/study/assets/img/shucangfenceng.83dc837e.png" alt=""></p> <p>数据仓库的数据来源于不同的源数据，并提供多样的数据应用，数据自下而上流入数据仓库后向上层开放应用，而数据仓库只是中间集成化数据管理的一个平台。</p> <ul><li>源数据层（ODS） ：此层数据无任何更改，直接沿用外围系统数据结构和数据，不对外开放；为临时存储层，是接口数据的临时存储区域，为后一步的数据处理做准备。</li> <li>数据仓库层（DW） ：也称为细节层，DW层的数据应该是一致的、准确的、干净的数据，即对源系统数据进行了清洗（去除了杂质）后的数据。</li> <li>数据应用层（DA或APP） ：前端应用直接读取的数据源；根据报表、专题分析需求而计算生成的数据。</li></ul> <p>数据仓库从各数据源获取数据及在数据仓库内的数据转换和流动都可以认为是ETL（抽取Extra, 转化 Transfer, 装载Load）的过程，ETL是数据仓库的流水线，也可以认为是数据仓库的血液，它维系着数据仓库中数据的新陈代谢，而数据仓库日常的管理和维护工作的大部分精力就是保持ETL的正常和稳定。</p> <h4 id="为什么要对数据仓库分层？"><a href="#为什么要对数据仓库分层？" class="header-anchor">#</a> 为什么要对数据仓库分层？</h4> <p>用空间换时间，通过大量的预处理来提升应用系统的用户体验（效率），因此数据仓库会存在大量冗余的数据；不分层的话，如果源业务系统的业务规则发生变化将会影响整个数据清洗过程，工作量巨大。</p> <p>通过数据分层管理可以简化数据清洗的过程，因为把原来一步的工作分到了多个步骤去完成，相当于把一个复杂的工作拆成了多个简单的工作，把一个大的黑盒变成了一个白盒，每一层的处理逻辑都相对简单和容易理解，这样我们比较容易保证每一个步骤的正确性，当数据发生错误的时候，往往我们只需要局部调整某个步骤即可。</p> <h3 id="数仓的元数据管理"><a href="#数仓的元数据管理" class="header-anchor">#</a> 数仓的元数据管理</h3> <p>元数据（Meta Date），主要记录数据仓库中模型的定义、各层级间的映射关系、监控数据仓库的数据状态及ETL的任务运行状态。一般会通过元数据资料库（Metadata Repository）来统一地存储和管理元数据，其主要目的是使数据仓库的设计、部署、操作和管理能达成协同和一致。</p> <p>元数据是数据仓库管理系统的重要组成部分，元数据管理是企业级数据仓库中的关键组件，贯穿数据仓库构建的整个过程，直接影响着数据仓库的构建、使用和维护。</p> <ul><li><p>构建数据仓库的主要步骤之一是ETL。这时元数据将发挥重要的作用，它定义了源数据系统到数据仓库的映射、数据转换的规则、数据仓库的逻辑结构、数据更新的规则、数据导入历史记录以及装载周期等相关内容。数据抽取和转换的专家以及数据仓库管理员正是通过元数据高效地构建数据仓库。</p></li> <li><p>用户在使用数据仓库时，通过元数据访问数据，明确数据项的含义以及定制报表。</p></li> <li><p>数据仓库的规模及其复杂性离不开正确的元数据管理，包括增加或移除外部数据源，改变数据清洗方法，控制出错的查询以及安排备份等。</p></li></ul> <p><img src="/study/assets/img/dm.9fce0583.png" alt=""></p> <p>元数据可分为<strong>技术元数据</strong>和<strong>业务元数据</strong>。</p> <p>技术元数据为开发和管理数据仓库的IT 人员使用，它描述了与数据仓库开发、管理和维护相关的数据，包括数据源信息、数据转换描述、数据仓库模型、数据清洗与更新规则、数据映射和访问权限等。</p> <p>而业务元数据为管理层和业务分析人员服务，从业务角度描述数 据，包括商务术语、数据仓库中有什么数据、数据的位置和数据的可用性等，帮助业务人员更好地理解数据仓库中哪些数据是可用的以及如何使用。</p> <p>由上可见，元数据不仅定义了数据仓库中数据的模式、来源、抽取和转换规则等，而且是整个数据仓库系统运行的基础，元数据把数据仓库系统中各个松散的组件联系起来，组成了一个有机的整体。</p> <h2 id="hive-的基本概念"><a href="#hive-的基本概念" class="header-anchor">#</a> <strong>Hive</strong> 的基本概念</h2> <h3 id="hive-简介"><a href="#hive-简介" class="header-anchor">#</a> Hive 简介</h3> <h4 id="什么是-hive-？"><a href="#什么是-hive-？" class="header-anchor">#</a> 什么是 <strong>Hive</strong> ？</h4> <p>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。</p> <p>其本质是将SQL转换为MapReduce的任务进行运算，底层由HDFS来提供数据的存储，说白了hive可以 理解为一个将SQL转换为MapReduce的任务的工具，甚至更进一步可以说hive就是一个MapReduce的 客户端。</p> <p><img src="/study/assets/img/hive1.c1404c02.png" alt=""></p> <h4 id="为什么使用-hive-？"><a href="#为什么使用-hive-？" class="header-anchor">#</a> 为什么使用 Hive ？</h4> <ul><li><p>直接使用hadoop所面临的问题</p> <ul><li>人员学习成本太高</li> <li>项目周期要求太短</li> <li>MapReduce实现复杂查询逻辑开发难度太大</li></ul></li> <li><p>为什么要使用Hive</p> <ul><li>操作接口采用类SQL语法，提供快速开发的能力。</li> <li>避免了去写MapReduce，减少开发人员的学习成本。</li> <li>功能扩展很方便。</li></ul></li></ul> <h4 id="hive的特点"><a href="#hive的特点" class="header-anchor">#</a> Hive的特点</h4> <ul><li><p>可扩展</p> <p>Hive 可以自由的扩展集群的规模，一般情况下不需要重启服务。</p></li> <li><p>延展性</p> <p>Hive 支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。</p></li> <li><p>容错</p> <p>良好的容错性，节点出现问题SQL仍可完成执行。</p></li></ul> <h3 id="hive-架构"><a href="#hive-架构" class="header-anchor">#</a> Hive 架构</h3> <p><img src="/study/assets/img/hive_jiagou.680e7908.png" alt=""></p> <ul><li><strong>用户接口</strong>： 包括CLI、JDBC/ODBC。其中，CLI(command line interface)为shell命令行；JDBC/ODBC是Hive的JAVA实现，与传统数据库JDBC类似；</li> <li><strong>元数据存储</strong>： 通常是存储在关系数据库如mysql/derby中。Hive 将元数据存储在数据库中。Hive中的元数据包括表的名字，表的列和分区及其属性，表的属性（是否为外部表等），表的数据所在目录等。</li> <li><strong>解释器、编译器、优化器、执行器</strong>: 完成HQL 查询语句从词法分析、语法分析、编译、优化以及查询计划的生成。生成的查询计划存储在HDFS 中，并在随后有MapReduce 调用执行。</li></ul> <p><strong>工作原理</strong>：</p> <ol><li><p>用户创建数据库、表信息，存储在hive的元数据库中；</p></li> <li><p>向表中加载数据，元数据记录hdfs文件路径与表之间的映射关系；</p></li> <li><p>执行查询语句，首先经过解析器、编译器、优化器、执行器，将指令翻译成MapReduce，提交到Yarn上执行，最后将执行返回的结果输出到用户交互接口。</p></li></ol> <h3 id="hive-与-hadoop-的关系"><a href="#hive-与-hadoop-的关系" class="header-anchor">#</a> Hive 与 Hadoop 的关系</h3> <p>Hive利用HDFS存储数据，利用MapReduce查询分析数据</p> <p><img src="/study/assets/img/hive_hadoop.3d42d1ea.png" alt=""></p> <h3 id="hive-与传统数据库对比"><a href="#hive-与传统数据库对比" class="header-anchor">#</a> **Hive **与传统数据库对比</h3> <p>hive 用于海量数据的离线数据分析</p> <p><img src="/study/assets/img/hive_sql.47201f34.png" alt=""></p> <p>总结：hive具有sql数据库的外表，但应用场景完全不同，hive只适合用来做批量数据统计分析 。</p> <h2 id="hive-安装和环境配置"><a href="#hive-安装和环境配置" class="header-anchor">#</a> Hive 安装和环境配置</h2> <ol><li>手动安装：自行Google</li> <li>CDH安装：自行Google</li></ol> <h3 id="hive-的三种连接方式"><a href="#hive-的三种连接方式" class="header-anchor">#</a> Hive 的三种连接方式</h3> <ol><li><p>第一种交互方式 <strong>bin/hive</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#/bin/hive</span>
</code></pre></div><p>通过hive shell来操作hive，但是至多只能存在一个hive shell，启动第二个会被阻塞，也就是说hive shell不支持并发操作。</p></li> <li><p>第二种交互方式 <strong>HiveServer2</strong></p> <p>基于JDBC等协议：启动hiveserver2，通过jdbc协议可以访问hive，hiveserver2支持高并发。</p> <p>简而言之，hiveserver2是Hive启动了一个server，客户端可以使用JDBC协议，通过IP+ Port的方式对其进行访问，达到并发访问的目的。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#启动服务端（前台启动命令如下）</span>
<span class="token comment">#/bin/hive --service hiveserver2</span>
</code></pre></div><p>在装了相同版本Hive的其他主机(启动hiveserver2的主机也可以)上启动beeline，可以连接到Hive的server上。执行命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#/bin/beeline -u jdbc:hive2://node-00:10000</span>
</code></pre></div></li> <li><p>第三种交互方式：使用<strong>sql</strong>语句或者<strong>sql</strong>脚本进行交互</p> <p>不进入hive的客户端直接执行hive的hql语句</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#/bin/hive -e &quot;create database if not exists mytest;&quot;</span>
</code></pre></div><p>或者我们可以将我们的hql语句写成一个sql脚本然后执行</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#vim hive.sql</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> mytest<span class="token punctuation">;</span> 
<span class="token keyword">use</span> mytest<span class="token punctuation">;</span> 
<span class="token keyword">create</span> <span class="token keyword">table</span> stu<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">,</span>name string<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过hive -f 来执行我们的sql脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#/bin/hive -f hive.sql</span>
</code></pre></div></li></ol> <h2 id="hive-数据库操作"><a href="#hive-数据库操作" class="header-anchor">#</a> <strong>Hive</strong> 数据库操作</h2> <h3 id="创建数据库"><a href="#创建数据库" class="header-anchor">#</a> 创建数据库</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> myhive<span class="token punctuation">;</span> 
<span class="token keyword">use</span> myhive<span class="token punctuation">;</span>
</code></pre></div><p>hive的表存放位置模式是由hive-site.xml当中的一个属性指定的</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hive.metastore.warehouse.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span>
    <span class="token attr-name">&lt;value</span><span class="token punctuation">&gt;</span></span>/user/hive/warehouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="创建数据库并指定位置"><a href="#创建数据库并指定位置" class="header-anchor">#</a> 创建数据库并指定位置</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> myhive2 location <span class="token string">'/myhive2'</span>
</code></pre></div><h3 id="修改数据库"><a href="#修改数据库" class="header-anchor">#</a> 修改数据库</h3> <p>可以使用alter database 命令来修改数据库的一些属性。但是数据库的元数据信息是不可更改的，包括</p> <p>数据库的名称以及数据库所在的位置</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">database</span> myhive2 <span class="token keyword">set</span> dbproperties<span class="token punctuation">(</span><span class="token string">'createtime'</span><span class="token operator">=</span><span class="token string">'20180611'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="查看数据库详细信息"><a href="#查看数据库详细信息" class="header-anchor">#</a> 查看数据库详细信息</h3> <p>查看数据库基本信息</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">desc</span> <span class="token keyword">database</span> myhive2<span class="token punctuation">;</span>
</code></pre></div><p>查看数据库更多详细信息</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">desc</span> <span class="token keyword">database</span> <span class="token keyword">extended</span> myhive2<span class="token punctuation">;</span>
</code></pre></div><h3 id="删除数据库"><a href="#删除数据库" class="header-anchor">#</a> 删除数据库</h3> <p>删除一个空数据库，如果数据库下面有数据表，那么就会报错</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span> myhive2<span class="token punctuation">;</span>
</code></pre></div><p>强制删除数据库，包含数据库下面的表一起删除</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span> myhive <span class="token keyword">cascade</span><span class="token punctuation">;</span> <span class="token comment"># 不要执行了</span>
</code></pre></div><h2 id="hive表操作"><a href="#hive表操作" class="header-anchor">#</a> Hive表操作</h2> <h3 id="hive表创建语法"><a href="#hive表创建语法" class="header-anchor">#</a> Hive表创建语法</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token punctuation">[</span>external<span class="token punctuation">]</span> <span class="token keyword">table</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> table_name <span class="token punctuation">(</span>
    col_name data_type <span class="token punctuation">[</span><span class="token keyword">comment</span> <span class="token string">'字段描述信息'</span><span class="token punctuation">]</span>
    col_name data_type <span class="token punctuation">[</span><span class="token keyword">comment</span> <span class="token string">'字段描述信息'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token keyword">comment</span> <span class="token string">'表的描述信息'</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>location <span class="token string">'指定表的路径'</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span>col_name data_type<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token keyword">clustered</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>col_name<span class="token punctuation">,</span>col_name<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>sorted <span class="token keyword">by</span> <span class="token punctuation">(</span>col_name <span class="token punctuation">[</span><span class="token keyword">asc</span><span class="token operator">|</span><span class="token keyword">desc</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">into</span> num_buckets buckets<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token keyword">row</span> format row_format<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>location location_path<span class="token punctuation">]</span>
</code></pre></div><p>说明：</p> <ol><li><p>CREATE TABLE 创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用IF NOT EXISTS 选项来忽略这个异常。</p></li> <li><p>EXTERNAL 关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径 （LOCATION），Hive 创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</p></li> <li><p>LIKE 允许用户复制现有的表结构，但是不复制数据。</p></li> <li><p>ROW FORMAT DELIMITED [FIELDS TERMINATED BY char] [COLLECTION ITEMS TERMINATED BY char] [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char] | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</p> <p>用户在建表的时候可以自定义 SerDe 或者使用自带的 SerDe。如果没有指定 ROW FORMAT 或者 ROW FORMAT DELIMITED，将会使用自带的 SerDe。在建表的时候，用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的 SerDe，Hive通过 SerDe 确定表的具体的列的数据。</p> <p>hive 默认的字段分隔符为ascii码的控制符\001,建表的时候用fields terminated by '\001',如果要测试的话，造数据在vi 打开文件里面，用ctrl+v然后再ctrl+a可以输入这个控制符\001。按顺序，\002的输入方式为ctrl+v,ctrl+b。以此类推。</p></li> <li><p>STORED AS</p> <p>SEQUENCEFILE|TEXTFILE|RCFILE</p> <p>如果文件数据是纯文本，可以使用 STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE。</p></li> <li><p>PARTITIONED BY</p> <p>分区，一个表可以拥有一个或者多个分区，每个分区以文件夹的形式单独存在表文件夹的目录下。</p></li> <li><p>CLUSTERED BY</p> <p>对于每一个表（table）或者分区， Hive可以进一步组织成桶，也就是说桶是更为细粒度的数据范</p> <p>围划分。Hive也是 针对某一列进行桶的组织。Hive采用对列值哈希，然后除以桶的个数求余的方</p> <p>式决定该条记录存放在哪个桶当中。</p> <p>把表（或者分区）组织成桶（Bucket）有两个理由：</p> <ol><li><p>获得更高的查询处理效率。桶为表加上了额外的结构，Hive 在处理有些查询时能利用这个结构。具体而言，连接两个在（包含连接列的）相同列上划分了桶的表，可以使用 Map 端连接 （Map-side join）高效的实现。比如JOIN操作。对于JOIN操作两个表有一个相同的列，如果对这两个表都进行了桶操作。那么将保存相同列值的桶进行JOIN操作就可以，可以大大较少JOIN的数据量。</p></li> <li><p>使取样（sampling）更高效。在处理大规模数据集时，在开发和修改查询的阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便。</p></li></ol></li></ol> <h3 id="管理表的操作"><a href="#管理表的操作" class="header-anchor">#</a> 管理表的操作</h3> <h4 id="建表初体验"><a href="#建表初体验" class="header-anchor">#</a> 建表初体验</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">use</span> myhive<span class="token punctuation">;</span> 
<span class="token keyword">create</span> <span class="token keyword">table</span> stu<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">,</span>name string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> stu <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu<span class="token punctuation">;</span>
</code></pre></div><p><strong>Hive</strong>建表时候的字段类型</p> <p>https://cwiki.apache.org/conflfluence/display/Hive/LanguageManual+Types</p> <p>基本数据类型</p> <table><thead><tr><th>Hive数据类型</th> <th>Java数据类型</th> <th>长度</th> <th>例子</th></tr></thead> <tbody><tr><td>TINYINT</td> <td>byte</td> <td>1byte有符号整数</td> <td>20</td></tr> <tr><td>SMALINT</td> <td>short</td> <td>2byte有符号整数</td> <td>20</td></tr> <tr><td>INT</td> <td>int</td> <td>4byte有符号整数</td> <td>20</td></tr> <tr><td>BIGINT</td> <td>long</td> <td>8byte有符号整数</td> <td>20</td></tr> <tr><td>BOOLEAN</td> <td>boolean</td> <td>布尔类型，true或者false</td> <td>TRUE FALSE</td></tr> <tr><td>FLOAT</td> <td>float</td> <td>单精度浮点数</td> <td>3.14159</td></tr> <tr><td>DOUBLE</td> <td>double</td> <td>双精度浮点数</td> <td>3.14159</td></tr> <tr><td>STRING</td> <td>string</td> <td>字符系列。可以指定字符集。可以使用单引号或者双引号。</td> <td>‘now is the time’ “for all good men”</td></tr> <tr><td>TIMESTAMP</td> <td></td> <td>时间类型</td> <td></td></tr> <tr><td>BINARY</td> <td></td> <td>字节数组</td> <td></td></tr></tbody></table> <p>【注】：对于Hive的string类型就相当于数据库中的varchar类型，该类型是一个可变的字符串，但是它不能声明存储字符长度的限制，理论上它可以存储2GB的字符数。</p> <p>集合数据类型</p> <table><thead><tr><th>数据类型</th> <th>描述</th> <th>语法示例</th></tr></thead> <tbody><tr><td>STRUCT</td> <td>和c语言中的struct类似，都可以通过“点”符号访问元素内容。例如，如果某个列的数据类型是STRUCT{first STRING, last STRING},那么第1个元素可以通过字段.first来引用。</td> <td>struct()</td></tr> <tr><td>MAP</td> <td>MAP是一组键-值对元组集合，使用数组表示法可以访问数据。例如，如果某个列的数据类型是MAP，其中键-&gt;值对是’first’-&gt;’John’和’last’-&gt;’Doe’，那么可以通过字段名[‘last’]获取最后一个元素</td> <td>map()</td></tr> <tr><td>ARRAY</td> <td>数组是一组具有相同类型和名称的变量的集合。这些变量称为数组的元素，每个数组元素都有一个编号，编号从零开始。例如，数组值为[‘John’, ‘Doe’]，那么第2个元素可以通过数组名[1]进行引用。</td> <td>Array()</td></tr></tbody></table> <p>【注】：Array、Map和Java中的Array、Map类似；Struct和C语言中的Struct类似，它封装了一个命名字段集合，复杂数据类型允许任意层次 的嵌套。</p> <p>【案例】：</p> <p>假设某表有如下一行，我们用JSON格式来表示其数据结构。在Hive下访问的格式为</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;songsong&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;friends&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bingbing&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;lili&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">,</span>       <span class="token comment">//列表Array,</span>
    <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>                      <span class="token comment">//键值Map,</span>
        <span class="token property">&quot;xiao song&quot;</span><span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">,</span>
        <span class="token property">&quot;xiaoxiao song&quot;</span><span class="token operator">:</span> <span class="token number">19</span>
    <span class="token punctuation">}</span>
    <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>                      <span class="token comment">//结构Struct,</span>
        <span class="token property">&quot;street&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hui long guan&quot;</span> <span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="创建表并指定字段之间的分隔符"><a href="#创建表并指定字段之间的分隔符" class="header-anchor">#</a> 创建表并指定字段之间的分隔符</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> stu2<span class="token punctuation">(</span>id <span class="token keyword">int</span> <span class="token punctuation">,</span>name string<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div><h4 id="根据查询结果创建表"><a href="#根据查询结果创建表" class="header-anchor">#</a> 根据查询结果创建表</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> stu3 <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu2<span class="token punctuation">;</span> <span class="token comment"># 通过复制表结构和表内容创建新表</span>
</code></pre></div><h4 id="根据已经存在的表结构创建表"><a href="#根据已经存在的表结构创建表" class="header-anchor">#</a> 根据已经存在的表结构创建表</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> stu4 <span class="token operator">like</span> stu2<span class="token punctuation">;</span>
</code></pre></div><h4 id="查询表的类型"><a href="#查询表的类型" class="header-anchor">#</a> 查询表的类型</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">desc</span> formatted stu2<span class="token punctuation">;</span>
</code></pre></div><h3 id="外部表的操作"><a href="#外部表的操作" class="header-anchor">#</a> 外部表的操作</h3> <h4 id="外部表说明"><a href="#外部表说明" class="header-anchor">#</a> 外部表说明</h4> <p>外部表因为是指定其他的hdfs路径的数据加载到表当中来，所以hive表会认为自己不完全独占这份数据，所以删除hive表的时候，数据仍然存放在hdfs当中，不会删掉</p> <h4 id="管理表和外部表的使用场景"><a href="#管理表和外部表的使用场景" class="header-anchor">#</a> 管理表和外部表的使用场景</h4> <p>每天将收集到的网站日志定期流入HDFS文本文件。在外部表（原始日志表）的基础上做大量的统计分析，用到的中间表、结果表使用内部表存储，数据通过SELECT+INSERT进入内部表</p> <h4 id="操作案例"><a href="#操作案例" class="header-anchor">#</a> 操作案例</h4> <p>分别创建老师与学生表外部表，并向表中加载数据</p> <ul><li><p>创建老师表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> external <span class="token keyword">table</span> teacher <span class="token punctuation">(</span>t_id string<span class="token punctuation">,</span>t_name string<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div></li> <li><p>创建学生表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> external <span class="token keyword">table</span> student <span class="token punctuation">(</span>s_id string<span class="token punctuation">,</span>s_name string<span class="token punctuation">,</span>s_birth string <span class="token punctuation">,</span> s_sex string <span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div></li> <li><p>加载数据(本地)</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/student.csv'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> student<span class="token punctuation">;</span>
</code></pre></div><p>student.csv</p> <div class="language- extra-class"><pre class="language-text"><code>01	赵雷	1990-01-01	男
02	钱电	1990-12-21	男
03	孙风	1990-05-20	男
04	李云	1990-08-06	男
05	周梅	1991-12-01	女
06	吴兰	1992-03-01	女
07	郑竹	1989-07-01	女
08	王菊	1990-01-20	女
</code></pre></div></li> <li><p>加载数据并覆盖已有数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/student.csv'</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> student<span class="token punctuation">;</span>
</code></pre></div><p>注：执行完load 后，本地 的/hivedatas/teacher.csv文件会被复制到hive数据库目录中。</p></li> <li><p>从<strong>hdfs</strong>文件系统向表中加载数据（需要提前将数据上传到<strong>hdfs</strong>文件系统）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">#cd /export/servers/hivedatas </span>
<span class="token comment">#hdfs dfs -mkdir -p /hivedatas </span>
<span class="token comment">#hdfs dfs -put techer.csv /hivedatas/ </span>
<span class="token comment">#hive&gt; load data inpath '/hivedatas/techer.csv' into table teacher; </span>
</code></pre></div><p>注：执行完load 后，hdfs 的/hivedatas/teacher.csv文件会被移动（剪切）到hive数据库目录中。</p> <p>teacher.csv</p> <div class="language- extra-class"><pre class="language-text"><code>01	张三
02	李四
03	王五
</code></pre></div></li></ul> <h3 id="分区表"><a href="#分区表" class="header-anchor">#</a> 分区表</h3> <p>在大数据中，最常用的一种思想就是分治，我们可以把大的文件切割划分成一个个的小的文件，这样每次操作一个小的文件就会很容易了，同样的道理，在hive当中也是支持这种思想的，就是我们可以把大的数据，按照每天，或者每小时进行切分成一个个的小的文件，这样去操作小的文件就会容易得多了 。</p> <h4 id="创建分区表语法"><a href="#创建分区表语法" class="header-anchor">#</a> 创建分区表语法</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> score<span class="token punctuation">(</span>s_id string<span class="token punctuation">,</span>c_id string<span class="token punctuation">,</span> s_score <span class="token keyword">int</span><span class="token punctuation">)</span> partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">month</span> string<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div><h4 id="创建一个表带多个分区"><a href="#创建一个表带多个分区" class="header-anchor">#</a> 创建一个表带多个分区</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> score2 <span class="token punctuation">(</span>s_id string<span class="token punctuation">,</span>c_id string<span class="token punctuation">,</span> s_score <span class="token keyword">int</span><span class="token punctuation">)</span> partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">year</span> string<span class="token punctuation">,</span><span class="token keyword">month</span> string<span class="token punctuation">,</span><span class="token keyword">day</span> string<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div><h4 id="加载数据到分区表中"><a href="#加载数据到分区表中" class="header-anchor">#</a> 加载数据到分区表中</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/score.csv'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> score <span class="token keyword">partition</span> <span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token string">'202003'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注：上面操作会将表文件数据加载到hive数据库目录 <code>month=202003</code>文件夹中</p> <p>score.csv</p> <div class="language- extra-class"><pre class="language-text"><code>01	01	80
01	02	90
01	03	99
02	01	70
02	02	60
02	03	80
03	01	80
03	02	80
03	03	80
04	01	50
04	02	30
04	03	20
05	01	76
05	02	87
06	01	31
06	03	34
07	02	89
07	03	98
</code></pre></div><h4 id="加载数据到多分区表中"><a href="#加载数据到多分区表中" class="header-anchor">#</a> 加载数据到多分区表中</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/score.csv'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> score2 <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">year</span><span class="token operator">=</span><span class="token string">'2020'</span><span class="token punctuation">,</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token string">'03'</span><span class="token punctuation">,</span><span class="token keyword">day</span><span class="token operator">=</span><span class="token string">'01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注：上面操作会将表文件数据加载  <code>/year=2020/month=03/day=01</code>文件夹中</p> <p>多分区表联合查询(使用 union all )</p> <h4 id="多分区表联合查询-使用-union-all"><a href="#多分区表联合查询-使用-union-all" class="header-anchor">#</a> 多分区表联合查询(使用 union all )</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'202002'</span> <span class="token keyword">union</span> <span class="token keyword">all</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'202003'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="查看分区"><a href="#查看分区" class="header-anchor">#</a> 查看分区</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> partitions score<span class="token punctuation">;</span>
</code></pre></div><h4 id="添加一个分区"><a href="#添加一个分区" class="header-anchor">#</a> 添加一个分区</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> score <span class="token keyword">add</span> <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token operator">=</span><span class="token string">'202003'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h4 id="删除分区"><a href="#删除分区" class="header-anchor">#</a> 删除分区</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> score <span class="token keyword">drop</span> <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'202003'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="分桶表"><a href="#分桶表" class="header-anchor">#</a> 分桶表</h3> <p>将数据按照指定的字段进行分成多个桶中去，说白了就是将数据按照字段进行划分，可以将数据按照字段划分到多个文件当中去 。</p> <h4 id="开启-hive-的分桶功能"><a href="#开启-hive-的分桶功能" class="header-anchor">#</a> 开启 Hive 的分桶功能</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">set</span> hive.enforce.bucketing<span class="token operator">=</span>true<span class="token punctuation">;</span> 
</code></pre></div><h4 id="设置-reduce-个数"><a href="#设置-reduce-个数" class="header-anchor">#</a> 设置 Reduce 个数</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">set</span> mapreduce.job.reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment"># 默认-1：不限制</span>
</code></pre></div><h4 id="创建桶表"><a href="#创建桶表" class="header-anchor">#</a> 创建桶表</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> course <span class="token punctuation">(</span>c_id string<span class="token punctuation">,</span>c_name string<span class="token punctuation">,</span>t_id string<span class="token punctuation">)</span> <span class="token keyword">clustered</span> <span class="token keyword">by</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token number">3</span> buckets <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div><p>桶表的数据加载，由于通标的数据加载通过 hdfs dfs -put 文件或者通过 load data 均不好使，只能通过 insert overwrite</p> <p>创建普通表，并通过insert overwrite的方式将普通表的数据通过查询的方式加载到桶表当中去</p> <p>创建普通表（中间表）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> course_common <span class="token punctuation">(</span>c_id string<span class="token punctuation">,</span>c_name string<span class="token punctuation">,</span>t_id string<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
</code></pre></div><p>普通表中加载数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/course.csv'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> course_common<span class="token punctuation">;</span>
</code></pre></div><p>course.csv</p> <div class="language- extra-class"><pre class="language-text"><code>01	语文	02
02	数学	01
03	英语	03
</code></pre></div><p>通过insert overwrite给桶表中加载数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> course <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course_common cluster <span class="token keyword">by</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注：最终在hive数据库目录中文件会被分割为三份</p> <p><img src="/study/assets/img/cluste.61480ef1.jpg" alt=""></p> <h3 id="修改表"><a href="#修改表" class="header-anchor">#</a> 修改表</h3> <h4 id="重命名"><a href="#重命名" class="header-anchor">#</a> 重命名</h4> <p>基本语法：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> old_table_name <span class="token keyword">rename</span> <span class="token keyword">to</span> new_table_name<span class="token punctuation">;</span> 
</code></pre></div><p>把表score4修改成score5</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> score4 <span class="token keyword">rename</span> <span class="token keyword">to</span> score5
</code></pre></div><h4 id="增加-修改列信息"><a href="#增加-修改列信息" class="header-anchor">#</a> 增加**/**修改列信息</h4> <ul><li><p>查询表结构</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">desc</span> score5<span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>添加列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> score5 <span class="token keyword">add</span> <span class="token keyword">columns</span> <span class="token punctuation">(</span>mycol string<span class="token punctuation">,</span> mysco string<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>更新列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> score5 change <span class="token keyword">column</span> mysco mysconew <span class="token keyword">int</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="删除表"><a href="#删除表" class="header-anchor">#</a> 删除表</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">table</span> score5<span class="token punctuation">;</span>
</code></pre></div><h3 id="hive-表中加载数据"><a href="#hive-表中加载数据" class="header-anchor">#</a> **hive **表中加载数据</h3> <h4 id="直接向分区表中插入数据"><a href="#直接向分区表中插入数据" class="header-anchor">#</a> 直接向分区表中插入数据</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> score3 <span class="token operator">like</span> score<span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> score3 <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">month</span> <span class="token operator">=</span><span class="token string">'202003'</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'001'</span><span class="token punctuation">,</span><span class="token string">'002'</span><span class="token punctuation">,</span><span class="token string">'100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="通过查询插入数据"><a href="#通过查询插入数据" class="header-anchor">#</a> 通过查询插入数据</h4> <p>通过load方式加载数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/export/servers/hivedatas/score.csv'</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> score <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">month</span> <span class="token operator">=</span><span class="token string">'202003'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过查询方式加载数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> score4 <span class="token operator">like</span> score<span class="token punctuation">;</span> <span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> score4 <span class="token keyword">partition</span><span class="token punctuation">(</span><span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'202003'</span><span class="token punctuation">)</span> <span class="token keyword">select</span> s_id<span class="token punctuation">,</span>c_id<span class="token punctuation">,</span>s_score <span class="token keyword">from</span> score<span class="token punctuation">;</span>
</code></pre></div><h2 id="hive-查询语法"><a href="#hive-查询语法" class="header-anchor">#</a> <strong>Hive</strong> 查询语法</h2> <h3 id="select"><a href="#select" class="header-anchor">#</a> <strong>SELECT</strong></h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span> <span class="token operator">|</span> <span class="token keyword">DISTINCT</span><span class="token punctuation">]</span> select_expr<span class="token punctuation">,</span> select_expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
    <span class="token keyword">FROM</span> table_reference 
    <span class="token punctuation">[</span><span class="token keyword">WHERE</span> where_condition<span class="token punctuation">]</span> 
    <span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> col_list <span class="token punctuation">[</span><span class="token keyword">HAVING</span> condition<span class="token punctuation">]</span><span class="token punctuation">]</span> 
    <span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span> col_list <span class="token operator">|</span> <span class="token punctuation">[</span>DISTRIBUTE <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> 
    <span class="token punctuation">[</span>SORT <span class="token keyword">BY</span><span class="token operator">|</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> 
    <span class="token keyword">LIMIT</span> number<span class="token punctuation">]</span>
</code></pre></div><ol><li><p>order by 会对输入做<strong>全局排序</strong>，因此只有一个reducer，会导致当输入规模较大时，需要较长的计算时间。</p></li> <li><p>sort by <strong>不是全局排序</strong>，其在数据进入reducer前完成排序。因此，如果用sort by进行排序，并且设置 mapred.reduce.tasks&gt;1，则sort by只保证每个reducer的输出有序，不保证全局有序。</p></li> <li><p>distribute by(字段)根据指定的字段将数据分到不同的reducer，且分发算法是hash散列。</p></li> <li><p>cluster by(字段) 除了具有distribute by的功能外，还会对该字段进行排序。 ---&gt; distribute by + sort by 因此，如果分桶和sort字段是同一个时，此时， cluster by = distribute by + sort b</p></li></ol> <p>分桶表的作用：最大的作用是用来提高join操作的效率；</p> <p>思考这个问题： select a.id,a.name,b.addr from a join b on a.id = b.id;</p> <p>如果a表和b表已经是分桶表，而且分桶的字段是id字段 做这个join操作时，还需要全表做笛卡尔积吗?</p> <h3 id="查询语法"><a href="#查询语法" class="header-anchor">#</a> 查询语法</h3> <h4 id="全表查询"><a href="#全表查询" class="header-anchor">#</a> 全表查询</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h4 id="选择特定列"><a href="#选择特定列" class="header-anchor">#</a> 选择特定列</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span>c_id <span class="token keyword">from</span> score<span class="token punctuation">;</span>
</code></pre></div><h4 id="列别名"><a href="#列别名" class="header-anchor">#</a> 列别名</h4> <p>1）重命名一个列。</p> <p>2）便于计算。</p> <p>3）紧跟列名，也可以在列名和别名之间加入关键字‘AS</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token keyword">as</span> myid <span class="token punctuation">,</span>c_id <span class="token keyword">from</span> score<span class="token punctuation">;</span>
</code></pre></div><h3 id="常用函数"><a href="#常用函数" class="header-anchor">#</a> 常用函数</h3> <h4 id="求总行数（count）"><a href="#求总行数（count）" class="header-anchor">#</a> 求总行数（count）</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h4 id="求分数的最大值（max）"><a href="#求分数的最大值（max）" class="header-anchor">#</a> 求分数的最大值（max）</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h4 id="求分数的最小值（min）"><a href="#求分数的最小值（min）" class="header-anchor">#</a> 求分数的最小值（min）</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h4 id="求分数的总和（sum）"><a href="#求分数的总和（sum）" class="header-anchor">#</a> 求分数的总和（sum）</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h4 id="求分数的平均值（avg）"><a href="#求分数的平均值（avg）" class="header-anchor">#</a> 求分数的平均值（avg）</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score<span class="token punctuation">;</span> 
</code></pre></div><h3 id="limit-语句"><a href="#limit-语句" class="header-anchor">#</a> LIMIT 语句</h3> <p>典型的查询会返回多行数据。LIMIT子句用于限制返回的行数。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="where-语句"><a href="#where-语句" class="header-anchor">#</a> WHERE 语句</h3> <ol><li><p>使用WHERE 子句，将不满足条件的行过滤掉。</p></li> <li><p>WHERE 子句紧随 FROM 子句。</p></li> <li><p>案例实操</p> <p>查询出分数大于60的数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <h4 id="关系运算符"><a href="#关系运算符" class="header-anchor">#</a> 关系运算符</h4> <table><thead><tr><th style="text-align:left;">运算符</th> <th style="text-align:left;">操作</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">A = B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">如果表达A等于表达B，结果TRUE ，否则FALSE。</td></tr> <tr><td style="text-align:left;">A != B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">如果A不等于表达式B表达返回TRUE ，否则FALSE。</td></tr> <tr><td style="text-align:left;">A &lt; B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">TRUE，如果表达式A小于表达式B，否则FALSE。</td></tr> <tr><td style="text-align:left;">A &lt;= B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">TRUE，如果表达式A小于或等于表达式B，否则FALSE。</td></tr> <tr><td style="text-align:left;">A &gt; B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">TRUE，如果表达式A大于表达式B，否则FALSE。</td></tr> <tr><td style="text-align:left;">A &gt;= B</td> <td style="text-align:left;">所有基本类型</td> <td style="text-align:left;">TRUE，如果表达式A大于或等于表达式B，否则FALSE。</td></tr> <tr><td style="text-align:left;">A IS NULL</td> <td style="text-align:left;">所有类型</td> <td style="text-align:left;">TRUE，如果表达式的计算结果为NULL，否则FALSE。</td></tr> <tr><td style="text-align:left;">A IS NOT NULL</td> <td style="text-align:left;">所有类型</td> <td style="text-align:left;">FALSE，如果表达式A的计算结果为NULL，否则TRUE。</td></tr> <tr><td style="text-align:left;">A LIKE B</td> <td style="text-align:left;">字符串</td> <td style="text-align:left;">TRUE，如果字符串模式A匹配到B，否则FALSE。</td></tr> <tr><td style="text-align:left;">A RLIKE B</td> <td style="text-align:left;">字符串</td> <td style="text-align:left;">NULL，如果A或B为NULL；TRUE，如果A任何子字符串匹配Java正则表达式B；否则FALSE。</td></tr> <tr><td style="text-align:left;">A REGEXP B</td> <td style="text-align:left;">字符串</td> <td style="text-align:left;">等同于RLIKE.</td></tr></tbody></table> <ul><li><p>查询分数等于80的所有的数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查询分数在80到100的所有数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">between</span> <span class="token number">80</span> <span class="token operator">and</span> <span class="token number">100</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查询成绩为空的所有数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>查询成绩是80和90的数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">in</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h4 id="like-和-rlike"><a href="#like-和-rlike" class="header-anchor">#</a> <strong>LIKE</strong> 和 <strong>RLIKE</strong></h4> <ul><li><p>使用LIKE运算选择类似的值</p></li> <li><p>选择条件可以包含字符或数字:</p> <p>% 代表零个或多个字符(任意个字符)。</p> <p>_ 代表一个字符。</p></li> <li><p>RLIKE 子句是Hive中这个功能的一个扩展，其可以通过Java的正则表达式这个更强大的语言来指定匹配条件。</p></li></ul> <p>案例实操 :</p> <ol><li><p>查找以8开头的所有成绩</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">like</span> <span class="token string">'8%'</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查找第二个数值为9的所有成绩数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">like</span> <span class="token string">'_9%'</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查找成绩中含9的所有成绩数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">rlike</span> <span class="token string">'[9]'</span><span class="token punctuation">;</span> <span class="token comment">#等价于like '%9%'</span>
</code></pre></div></li></ol> <h4 id="逻辑运算符"><a href="#逻辑运算符" class="header-anchor">#</a> 逻辑运算符</h4> <table><thead><tr><th style="text-align:left;">运算符</th> <th style="text-align:left;">操作</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">A AND B</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">TRUE，如果A和B都是TRUE，否则FALSE。</td></tr> <tr><td style="text-align:left;">A &amp;&amp; B</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">类似于 A AND B.</td></tr> <tr><td style="text-align:left;">A OR B</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">TRUE，如果A或B或两者都是TRUE，否则FALSE。</td></tr> <tr><td style="text-align:left;">A || B</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">类似于 A OR B.</td></tr> <tr><td style="text-align:left;">NOT A</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">TRUE，如果A是FALSE，否则FALSE。</td></tr> <tr><td style="text-align:left;">!A</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">类似于 NOT A.</td></tr></tbody></table> <ul><li><p>查询成绩大于80，并且s_id是01的数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">&gt;</span><span class="token number">80</span> <span class="token operator">and</span> s_id <span class="token operator">=</span> <span class="token string">'01'</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查询成绩大于80，或者s_id 是01的数</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_score <span class="token operator">&gt;</span> <span class="token number">80</span> <span class="token operator">or</span> s_id <span class="token operator">=</span> <span class="token string">'01'</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查询s_id 不是 01和02的学生</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score <span class="token keyword">where</span> s_id <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'01'</span><span class="token punctuation">,</span><span class="token string">'02'</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="分组"><a href="#分组" class="header-anchor">#</a> 分组</h3> <h4 id="group-by-语句"><a href="#group-by-语句" class="header-anchor">#</a> <strong>GROUP BY</strong> 语句</h4> <p>GROUP BY语句通常会和聚合函数一起使用，按照一个或者多个列队结果进行分组，然后对每个组执行聚合操作。</p> <p>案例实操：</p> <ul><li><p>计算每个学生的平均分数</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id<span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>计算每个学生最高成绩</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id<span class="token punctuation">;</span> 
</code></pre></div></li></ul> <h4 id="having-语句"><a href="#having-语句" class="header-anchor">#</a> <strong>HAVING</strong> 语句</h4> <ul><li><p>having 与 where不同点</p> <ol><li><p>where针对表中的列发挥作用，查询数据；having针对查询结果中的列发挥作用，筛选数据。</p></li> <li><p>where后面不能写分组函数，而having后面可以使用分组函数。</p></li> <li><p>having只用于group by分组统计语句。</p></li></ol></li> <li><p>案例实操：</p> <ul><li><p>求每个学生的平均分数</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>求每个学生平均分数大于85的人</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> avgscore <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id <span class="token keyword">having</span> avgscore <span class="token operator">&gt;</span> <span class="token number">85</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></li></ul> <h3 id="join-语句"><a href="#join-语句" class="header-anchor">#</a> <strong>JOIN</strong> 语句</h3> <h4 id="等值-join"><a href="#等值-join" class="header-anchor">#</a> 等值 <strong>JOIN</strong></h4> <p>Hive支持通常的SQL JOIN语句，但是只支持等值连接，不支持非等值连接。</p> <p>案例操作: 查询分数对应的姓名</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> s<span class="token punctuation">.</span>s_id<span class="token punctuation">,</span>s<span class="token punctuation">.</span>s_score<span class="token punctuation">,</span>stu<span class="token punctuation">.</span>s_name<span class="token punctuation">,</span>stu<span class="token punctuation">.</span>s_birth <span class="token keyword">FROM</span> score s <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> student stu <span class="token keyword">ON</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> stu<span class="token punctuation">.</span>s_id<span class="token punctuation">;</span>
</code></pre></div><h4 id="内连接"><a href="#内连接" class="header-anchor">#</a> 内连接</h4> <p>内连接：只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> techer t <span class="token keyword">inner</span> <span class="token keyword">join</span> course c <span class="token keyword">on</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id<span class="token punctuation">;</span>
</code></pre></div><h4 id="左外连接"><a href="#左外连接" class="header-anchor">#</a> 左外连接</h4> <p>左外连接：JOIN操作符左边表中符合WHERE子句的所有记录将会被返回。 查询老师对应的课程</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> techer t <span class="token keyword">left</span> <span class="token keyword">join</span> course c <span class="token keyword">on</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id<span class="token punctuation">;</span>
</code></pre></div><h4 id="右外连接"><a href="#右外连接" class="header-anchor">#</a> 右外连接</h4> <p>右外连接：JOIN操作符右边表中符合WHERE子句的所有记录将会被返回。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> teacher t <span class="token keyword">right</span> <span class="token keyword">join</span> course c <span class="token keyword">on</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id<span class="token punctuation">;</span> 
</code></pre></div><h4 id="多表连接"><a href="#多表连接" class="header-anchor">#</a> 多表连接</h4> <p>注意：连接 n个表，至少需要n-1个连接条件。例如：连接三个表，至少需要两个连接条件。</p> <p>多表连接查询，查询老师对应的课程，以及对应的分数，对应的学生</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> teacher t 
<span class="token keyword">left</span> <span class="token keyword">join</span> course c <span class="token keyword">on</span> t<span class="token punctuation">.</span>t_id <span class="token operator">=</span> c<span class="token punctuation">.</span>t_id 
<span class="token keyword">left</span> <span class="token keyword">join</span> score s <span class="token keyword">on</span> s<span class="token punctuation">.</span>c_id <span class="token operator">=</span> c<span class="token punctuation">.</span>c_id 
<span class="token keyword">left</span> <span class="token keyword">join</span> student stu <span class="token keyword">on</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> stu<span class="token punctuation">.</span>s_id<span class="token punctuation">;</span>
</code></pre></div><p>大多数情况下，Hive会对每对JOIN连接对象启动一个MapReduce任务。本例中会首先启动一个MapReduce job对表 techer和表course进行连接操作，然后会再启动一个MapReduce job将第一个MapReduce job的输出和score;进行连接操作。</p> <h3 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h3> <h4 id="全局排序"><a href="#全局排序" class="header-anchor">#</a> 全局排序</h4> <p>Order By：全局排序，只能有一个reduce</p> <ol><li><p>使用 ORDER BY 子句排序</p> <p>ASC（ascend）: 升序（默认）</p> <p>DESC（descend）: 降序</p></li> <li><p>ORDER BY 子句在SELECT语句的结尾。</p></li></ol> <p>案例实操</p> <ol><li><p>查询学生的成绩，并按照分数降序排列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student s <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> score sco <span class="token keyword">ON</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> sco<span class="token punctuation">.</span>s_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sco<span class="token punctuation">.</span>s_score <span class="token keyword">DESC</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>查询学生的成绩，并按照分数升序排列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student s <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> score sco <span class="token keyword">ON</span> s<span class="token punctuation">.</span>s_id <span class="token operator">=</span> sco<span class="token punctuation">.</span>s_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sco<span class="token punctuation">.</span>s_score <span class="token keyword">asc</span><span class="token punctuation">;</span> 
</code></pre></div></li></ol> <h4 id="按照别名排序"><a href="#按照别名排序" class="header-anchor">#</a> 按照别名排序</h4> <p>按照分数的平均值排序</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> avg <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id <span class="token keyword">order</span> <span class="token keyword">by</span> avg<span class="token punctuation">;</span>
</code></pre></div><h4 id="多个列排序"><a href="#多个列排序" class="header-anchor">#</a> 多个列排序</h4> <p>按照学生id和平均成绩进行排序</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> s_id <span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>s_score<span class="token punctuation">)</span> avg <span class="token keyword">from</span> score <span class="token keyword">group</span> <span class="token keyword">by</span> s_id <span class="token keyword">order</span> <span class="token keyword">by</span> s_id<span class="token punctuation">,</span>avg<span class="token punctuation">;</span> 
</code></pre></div><h4 id="每个mapreduce内部排序（sort-by）局部排序"><a href="#每个mapreduce内部排序（sort-by）局部排序" class="header-anchor">#</a> 每个<strong>MapReduce</strong>内部排序（<strong>Sort By</strong>）局部排序</h4> <p>Sort By：每个MapReduce内部进行排序，对全局结果集来说不是排序。</p> <ol><li><p>设置reduce个数</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; set mapreduce.job.reduces=3; </span>
</code></pre></div></li> <li><p>查看设置reduce个数</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; set mapreduce.job.reduces;</span>
</code></pre></div></li> <li><p>查询成绩按照成绩降序排列</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score sort <span class="token keyword">by</span> s_score<span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>将查询结果导入到文件中（按照成绩降序排列）</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">'/export/servers/hivedatas/sort'</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score sort <span class="token keyword">by</span> s_score<span class="token punctuation">;</span>
</code></pre></div></li></ol> <h4 id="分区排序（distribute-by）"><a href="#分区排序（distribute-by）" class="header-anchor">#</a> 分区排序（<strong>DISTRIBUTE BY</strong>）</h4> <p>Distribute By：类似MR中partition，进行分区，结合sort by使用。</p> <p>注意，Hive要求DISTRIBUTE BY语句要写在SORT BY语句之前。</p> <p>对于distribute by进行测试，一定要分配多reduce进行处理，否则无法看到distribute by的效果。</p> <p>案例实操：先按照学生id进行分区，再按照学生成绩进行排序。</p> <ol><li><p>设置reduce的个数，将我们对应的s_id划分到对应的reduce当中去</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; set mapreduce.job.reduces=7; </span>
</code></pre></div></li> <li><p>通过distribute by 进行数据的分区</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">'/export/servers/hivedatas/sort'</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score distribute <span class="token keyword">by</span> s_id sort <span class="token keyword">by</span> s_score<span class="token punctuation">;</span>
</code></pre></div></li></ol> <h4 id="分桶排序（cluster-by-）"><a href="#分桶排序（cluster-by-）" class="header-anchor">#</a> 分桶排序（<strong>CLUSTER BY</strong> ）</h4> <p>当distribute by和sort by字段相同时，可以使用cluster by方式。cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是倒序排序，不能指定排序规则为ASC 或者DESC。</p> <p>以下两种写法等价</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score cluster <span class="token keyword">by</span> s_id<span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> score distribute <span class="token keyword">by</span> s_id sort <span class="token keyword">by</span> s_id<span class="token punctuation">;</span> 
</code></pre></div><h2 id="hive-函数"><a href="#hive-函数" class="header-anchor">#</a> <strong>Hive</strong> 函数</h2> <h3 id="内置函数"><a href="#内置函数" class="header-anchor">#</a> 内置函数</h3> <p>内容较多，见《Hive官方文档》 https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</p> <h4 id="查看系统自带的函数"><a href="#查看系统自带的函数" class="header-anchor">#</a> 查看系统自带的函数</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; show functions; </span>
</code></pre></div><h4 id="显示自带的函数的用法"><a href="#显示自带的函数的用法" class="header-anchor">#</a> 显示自带的函数的用法</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; desc function upper; </span>
</code></pre></div><h4 id="详细显示自带的函数的用法"><a href="#详细显示自带的函数的用法" class="header-anchor">#</a> 详细显示自带的函数的用法</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; desc function extended upper; </span>
</code></pre></div><h4 id="常用内置函数"><a href="#常用内置函数" class="header-anchor">#</a> 常用内置函数</h4> <ul><li><p>字符串连接函数： concat</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span><span class="token string">'def’,'</span>gh'<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div></li> <li><p>带分隔符字符串连接函数： concat_ws</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">,</span><span class="token string">'def'</span><span class="token punctuation">,</span><span class="token string">'gh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>cast类型转换</p></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token keyword">as</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>get_json_object(json 解析函数，用来处理json，必须是json格式)</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> get_json_object<span class="token punctuation">(</span><span class="token string">'{&quot;name&quot;:&quot;jack&quot;,&quot;age&quot;:&quot;20&quot;}'</span><span class="token punctuation">,</span><span class="token string">'$.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>URL解析函数</p></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> parse_url<span class="token punctuation">(</span><span class="token string">'http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1'</span><span class="token punctuation">,</span> <span class="token string">'HOST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">#结果：facebook.com</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> parse_url<span class="token punctuation">(</span><span class="token string">'http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1'</span><span class="token punctuation">,</span> <span class="token string">'PATH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">#结果：/path1/p.php</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> parse_url<span class="token punctuation">(</span><span class="token string">'http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1'</span><span class="token punctuation">,</span> <span class="token string">'QUERY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">#结果：K1=V1&amp;K2=V2</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> parse_url<span class="token punctuation">(</span><span class="token string">'http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1'</span><span class="token punctuation">,</span> <span class="token string">'QUERY'</span><span class="token punctuation">,</span><span class="token string">'k1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">#结果：V1</span>
</code></pre></div><h3 id="自定义函数"><a href="#自定义函数" class="header-anchor">#</a> 自定义函数</h3> <ol><li><p>Hive 自带了一些函数，比如：max/min等，但是数量有限，自己可以通过自定义UDF来方便的扩展。</p></li> <li><p>当Hive提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（UDF：user-defifined function）。</p></li> <li><p>根据用户自定义函数类别分为以下三种：upper --&gt;my_upper</p> <ul><li><p>UDF（User-Defifined-Function）</p> <ul><li>一进一出</li></ul></li> <li><p>UDAF（User-Defifined Aggregation Function）</p> <ul><li><p>聚集函数，多进一出</p></li> <li><p>类似于： count / max / min</p></li></ul></li> <li><p>UDTF（User-Defifined Table-Generating Functions）</p> <ul><li><p>一进多出</p></li> <li><p>如 lateral view explore()</p></li></ul></li></ul></li> <li><p>官方文档地址 https://cwiki.apache.org/confluence/display/Hive/HivePlugins</p></li> <li><p>编程步骤：
1）继承org.apache.hadoop.hive.ql.UDF</p> <p>2）需要实现evaluate函数；evaluate函数支持重载；</p></li> <li><p>注意事项</p> <p>1）UDF必须要有返回类型，可以返回null，但是返回类型不能为void；</p> <p>2）UDF中常用Text/LongWritable等类型，不推荐使用java类型；</p></li></ol> <h3 id="udf-开发实例"><a href="#udf-开发实例" class="header-anchor">#</a> <strong>UDF</strong> 开发实例</h3> <h4 id="step-1-创建-maven-工程"><a href="#step-1-创建-maven-工程" class="header-anchor">#</a> <strong>Step 1</strong> 创建 <strong>Maven</strong> 工程</h4> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.hive/hive-exec --&gt;</span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.hadoop/hadoop-common --&gt;</span> 	
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><h4 id="step-2-开发-java-类集成-udf"><a href="#step-2-开发-java-类集成-udf" class="header-anchor">#</a> <strong>Step 2</strong> 开发 <strong>Java</strong> 类集成 <strong>UDF</strong></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUDF</span> <span class="token keyword">extends</span> UDF<span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token class-name">Text</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Text</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token class-name">String</span> tmp_str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>str <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tmp_str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token class-name">String</span> str_ret <span class="token operator">=</span> tmp_str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>tmp_str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>str_ret<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><h4 id="step-3-项目打包，并上传到hive的lib目录下"><a href="#step-3-项目打包，并上传到hive的lib目录下" class="header-anchor">#</a> <strong>Step 3</strong> 项目打包，并上传到<strong>hive</strong>的<strong>lib</strong>目录下</h4> <p><img src="/study/assets/img/udf.b638a458.png" alt=""></p> <h4 id="step-4添加jar包"><a href="#step-4添加jar包" class="header-anchor">#</a> Step 4添加<strong>jar</strong>包</h4> <p>重命名我们的jar包名称</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#cd /export/servers/apache-hive-3.1.1-bin/lib </span>
<span class="token comment">#mv original-day_05_hive_udf-1.0-SNAPSHOT.jar myudf.jar </span>
</code></pre></div><p>hive的客户端添加我们的jar包</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#hive&gt; add jar /export/servers/apache-hive-3.1.1-bin/lib/udf.jar;</span>
</code></pre></div><h4 id="step-5-设置函数与我们的自定义函数关联"><a href="#step-5-设置函数与我们的自定义函数关联" class="header-anchor">#</a> <strong>Step 5</strong> 设置函数与我们的自定义函数关联</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">function</span> my_upper <span class="token keyword">as</span> <span class="token string">'cn.itcast.udf.ItcastUDF'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="step-6-使用自定义函数"><a href="#step-6-使用自定义函数" class="header-anchor">#</a> <strong>Step 6</strong> 使用自定义函数</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token keyword">select</span> my_upper<span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/大数据/HBase.html" class="prev">
        HBase
      </a></span> <span class="next"><a href="/study/大数据/Hue.html">
        Hue
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study/assets/js/app.805d6976.js" defer></script><script src="/study/assets/js/2.d79867de.js" defer></script><script src="/study/assets/js/9.7fd67b26.js" defer></script>
  </body>
</html>
