<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes-2 | PYY在线笔记文档</title>
    <meta name="generator" content="VuePress 1.7.0">
    <link rel="icon" href="/study/img/logo.png">
    <meta name="description" content="PYY在线笔记文档">
    
    <link rel="preload" href="/study/assets/css/0.styles.ba26750f.css" as="style"><link rel="preload" href="/study/assets/js/app.fc789024.js" as="script"><link rel="preload" href="/study/assets/js/2.45ac72bb.js" as="script"><link rel="preload" href="/study/assets/js/11.8110839e.js" as="script"><link rel="prefetch" href="/study/assets/js/10.fad6e4ef.js"><link rel="prefetch" href="/study/assets/js/12.93e677b2.js"><link rel="prefetch" href="/study/assets/js/13.203505c2.js"><link rel="prefetch" href="/study/assets/js/14.b772a1c6.js"><link rel="prefetch" href="/study/assets/js/15.09337c4f.js"><link rel="prefetch" href="/study/assets/js/16.4fafab2c.js"><link rel="prefetch" href="/study/assets/js/17.247347c7.js"><link rel="prefetch" href="/study/assets/js/18.dae9cc96.js"><link rel="prefetch" href="/study/assets/js/19.1b891438.js"><link rel="prefetch" href="/study/assets/js/20.7699f3da.js"><link rel="prefetch" href="/study/assets/js/21.9102359b.js"><link rel="prefetch" href="/study/assets/js/22.c992f789.js"><link rel="prefetch" href="/study/assets/js/23.5af2f891.js"><link rel="prefetch" href="/study/assets/js/24.0e603edd.js"><link rel="prefetch" href="/study/assets/js/25.fd061c30.js"><link rel="prefetch" href="/study/assets/js/26.ed77dbbc.js"><link rel="prefetch" href="/study/assets/js/3.5a9a9054.js"><link rel="prefetch" href="/study/assets/js/4.7779a8fc.js"><link rel="prefetch" href="/study/assets/js/5.9e8ba7eb.js"><link rel="prefetch" href="/study/assets/js/6.fb8987ac.js"><link rel="prefetch" href="/study/assets/js/7.646225a9.js"><link rel="prefetch" href="/study/assets/js/8.a31536bc.js"><link rel="prefetch" href="/study/assets/js/9.8a170b7b.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.ba26750f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记文档" class="logo"> <span class="site-name can-hide">PYY在线笔记文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dev Ops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/devops/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/study/devops/docker.html" class="sidebar-link">Docker</a></li><li><a href="/study/devops/dockercompose.html" class="sidebar-link">Docker Compose</a></li><li><a href="/study/devops/jenkins-yudocker-de-zi-dong-huacicd-shi-zhan.html" class="sidebar-link">Jenkins与Docker的自动化CICD实战</a></li><li><a href="/study/devops/kubernetes-1.html" class="sidebar-link">Kubernetes-1</a></li><li><a href="/study/devops/kubernetes-2.html" aria-current="page" class="active sidebar-link">Kubernetes-2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#第-6-章-环境搭建-二进制" class="sidebar-link">第 6 章 环境搭建（二进制）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-1-准备环境" class="sidebar-link">6.1 准备环境</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-2-dns-服务初始化" class="sidebar-link">6.2 DNS 服务初始化</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-3-准备签发证书环境" class="sidebar-link">6.3 准备签发证书环境</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-4-部署-docker" class="sidebar-link">6.4 部署 docker</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-5-部署私有仓库-harbor" class="sidebar-link">6.5 部署私有仓库 harbor</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-6-部署-master-节点" class="sidebar-link">6.6 部署 master 节点</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-7-部署-node-节点" class="sidebar-link">6.7 部署 node 节点</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_6-8-验证-kubernetes-集群" class="sidebar-link">6.8 验证 kubernetes 集群</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#第-7-章-环境搭建-kubeadm" class="sidebar-link">第 7 章 环境搭建（kubeadm）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-1-环境要求" class="sidebar-link">7.1 环境要求</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-2-环境准备" class="sidebar-link">7.2 环境准备</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-3-所有节点安装-docker-kubeadm-kubelet" class="sidebar-link">7.3 所有节点安装 Docker/kubeadm/kubelet</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-4-部署-kubernetes-master" class="sidebar-link">7.4 部署 Kubernetes Master</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-5-安装-pod-网络插件-cni" class="sidebar-link">7.5 安装 Pod 网络插件（CNI）</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-6-加入-kubernetes-node" class="sidebar-link">7.6 加入 Kubernetes Node</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-7-测试kubernetes集群" class="sidebar-link">7.7 测试kubernetes集群</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_7-8-部署-dashboard" class="sidebar-link">7.8 部署 Dashboard</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#第-8-章-k8s-的核心资源管理方法" class="sidebar-link">第 8 章 K8S 的核心资源管理方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_8-1-陈述式资源管理方法" class="sidebar-link">8.1 陈述式资源管理方法</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-2.html#_8-2-声明式资源管理方法" class="sidebar-link">8.2 声明式资源管理方法</a></li></ul></li></ul></li><li><a href="/study/devops/nginx.html" class="sidebar-link">Nginx</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes-2"><a href="#kubernetes-2" class="header-anchor">#</a> Kubernetes-2</h1> <h2 id="第-6-章-环境搭建-二进制"><a href="#第-6-章-环境搭建-二进制" class="header-anchor">#</a> 第 6 章 环境搭建（二进制）</h2> <h3 id="_6-1-准备环境"><a href="#_6-1-准备环境" class="header-anchor">#</a> 6.1 准备环境</h3> <table><thead><tr><th>主机</th> <th>服务</th> <th>备注</th></tr></thead> <tbody><tr><td>node-01</td> <td></td> <td></td></tr> <tr><td>node-02</td> <td></td> <td></td></tr> <tr><td>node-03</td> <td></td> <td></td></tr> <tr><td>node-04</td> <td></td> <td></td></tr> <tr><td>node-05</td> <td></td> <td></td></tr></tbody></table> <ol><li><p>关闭 SELinux 和 firewalld</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl stop firewalld               <span class="token comment">#临时关闭</span>

systemctl disable firewalld            <span class="token comment">#永久关闭,即设置开机的时候不自动启动</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）
</code></pre></div><p>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）</p></li> <li><p>为全部服务器安装 epel-release 源</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> epel-release -y
</code></pre></div></li> <li><p>为全部服务器安装常用工具</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">wget</span> telnet net-tools tree nmap sysstat lrzsz dos2unix bind-utils -y
</code></pre></div></li></ol> <h3 id="_6-2-dns-服务初始化"><a href="#_6-2-dns-服务初始化" class="header-anchor">#</a> 6.2 DNS 服务初始化</h3> <h4 id="_6-2-1-安装-bind9-软件"><a href="#_6-2-1-安装-bind9-软件" class="header-anchor">#</a> 6.2.1 安装 bind9 软件</h4> <p>在 node-01 上执行命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token builtin class-name">bind</span> -y
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa bind</span>
bind-9.11.4-9.P2.el7.x86_64
</code></pre></div><h4 id="_6-2-2-配置-bind9"><a href="#_6-2-2-配置-bind9" class="header-anchor">#</a> 6.2.2 配置 bind9</h4> <ul><li><p>主配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/named.conf
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>listen-on port <span class="token number">53</span> <span class="token punctuation">{</span> <span class="token number">10.10</span>.50.50<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
allow-query     <span class="token punctuation">{</span> any<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
forwarders      <span class="token punctuation">{</span> <span class="token number">10.10</span>.50.1<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
dnssec-enable no<span class="token punctuation">;</span>
dnssec-validation no<span class="token punctuation">;</span>
</code></pre></div><p>​	检查配置, 没有保存就是 OK</p> <div class="language-shell extra-class"><pre class="language-shell"><code>name-checkconf
</code></pre></div></li> <li><p>区域配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/named.rfc1912.zones 
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>zone &quot;host.com&quot; IN {
        type master;
        file &quot;host.com.zone&quot;;
        allow-update { 10.10.50.50; };
};

zone &quot;thtf.com&quot; IN {
        type master;
        file &quot;thtf.com.zone&quot;;
        allow-update { 10.10.50.50; };
};
</code></pre></div></li> <li><p>区域数据文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span>  /var/named/host.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN host.com.
$TTL 600    ; 10 minutes
@       IN SOA  dns.host.com. dnsadmin.host.com. (
                2020032001 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
            NS   dns.host.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
node-01            A    10.10.50.50           
node-02            A    10.10.50.20
node-03            A    10.10.50.233
node-04            A    10.10.50.99
node-05            A    10.10.50.40
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span>  /var/named/thtf.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN thtf.com.
$TTL 600    ; 10 minutes
@           IN SOA  dns.thtf.com. dnsadmin.thtf.com. (
                2020032001 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
                NS   dns.thtf.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
</code></pre></div><p>检查配置, 没有保存就是 OK</p> <div class="language-shell extra-class"><pre class="language-shell"><code>named-checkconf
</code></pre></div></li></ul> <h4 id="_6-2-3-启动-bind9"><a href="#_6-2-3-启动-bind9" class="header-anchor">#</a> 6.2.3 启动 bind9</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start named</span>
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntup|grep 53</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.50:53          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">26226</span>/named         
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:953           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">26226</span>/named         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::53                   :::*                    LISTEN      <span class="token number">26226</span>/named         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> ::1:953                 :::*                    LISTEN      <span class="token number">26226</span>/named         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.50:53          <span class="token number">0.0</span>.0.0:*                           <span class="token number">26226</span>/named         
udp6       <span class="token number">0</span>      <span class="token number">0</span> :::53                   :::*                                <span class="token number">26226</span>/named 
</code></pre></div><h4 id="_6-2-4-检查-dns-服务"><a href="#_6-2-4-检查-dns-服务" class="header-anchor">#</a> 6.2.4 检查 DNS 服务</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-01.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.50
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-02.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.20
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-03.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.233
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-04.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.99
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-05.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.40
</code></pre></div><h4 id="_6-2-5-配置-dns-客户端"><a href="#_6-2-5-配置-dns-客户端" class="header-anchor">#</a> 6.2.5 配置 DNS 客户端</h4> <p>全部主机执行下面操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token number">10.10</span>.50.50
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/resolv.conf
search host.com
nameserver <span class="token number">10.10</span>.50.50
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>systemctl restart network
</code></pre></div><h3 id="_6-3-准备签发证书环境"><a href="#_6-3-准备签发证书环境" class="header-anchor">#</a> 6.3 准备签发证书环境</h3> <p>在 node-05 上</p> <h4 id="_6-3-1-安装-cfssl"><a href="#_6-3-1-安装-cfssl" class="header-anchor">#</a> 6.3.1 安装 cfssl</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
<span class="token function">chmod</span> +x /usr/bin/cfssl*
</code></pre></div><h4 id="_6-3-2-创建生成ca证书csr的json配置文件"><a href="#_6-3-2-创建生成ca证书csr的json配置文件" class="header-anchor">#</a> 6.3.2 创建生成ca证书csr的json配置文件</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /opt/certs
<span class="token function">vi</span>  /opt/certs/ca-csr.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hosts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ca&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;expiry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;175200h&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>CN：Common Name, 浏览器使用该字段验证网站是否合法, 一般写的是域名。非常重要。</p> <p>C：Country, 国家</p> <p>ST：State, 州, 省</p> <p>L：Locality 地区 城市</p> <p>O： Organization Name 组织名称 公司名称</p> <p>OU：Organization Unit Name 组织单位名称 公司部门</p></blockquote> <h4 id="_6-3-3-生成ca证书文件"><a href="#_6-3-3-生成ca证书文件" class="header-anchor">#</a> 6.3.3 生成ca证书文件</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/certs</span>

<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span>
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">35390055852589240424773939585539235500209661940</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">16</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">989</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">325</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1338</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca.pem
</code></pre></div><h3 id="_6-4-部署-docker"><a href="#_6-4-部署-docker" class="header-anchor">#</a> 6.4 部署 docker</h3> <p>node-03 node-04 node-05上</p> <h4 id="_6-4-1-安装"><a href="#_6-4-1-安装" class="header-anchor">#</a> 6.4.1 安装</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -fsSL https://get.docker.com <span class="token operator">|</span> <span class="token function">bash</span> -s docker --mirror Aliyun
</code></pre></div><h4 id="_6-4-2-配置"><a href="#_6-4-2-配置" class="header-anchor">#</a> 6.4.2 配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span>  /etc/docker
<span class="token function">vi</span>  /etc/docker/daemon.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;graph&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/data/docker&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;storage-driver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;overlay2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;insecure-registries&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;registry.access.redhat.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;quay.io&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;harbor.thtf.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;bip&quot;</span><span class="token operator">:</span> <span class="token string">&quot;172.7.21.1/24&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exec-opts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;live-restore&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
##########
bip要根据宿主机ip变化 
</code></pre></div><h4 id="_6-4-3-启动"><a href="#_6-4-3-启动" class="header-anchor">#</a> 6.4.3 启动</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /data/docker
systemctl start docker
systemctl <span class="token builtin class-name">enable</span> docker
l
</code></pre></div><h3 id="_6-5-部署私有仓库-harbor"><a href="#_6-5-部署私有仓库-harbor" class="header-anchor">#</a> 6.5 部署私有仓库 harbor</h3> <p>在 node-05 上</p> <h4 id="_6-5-1-下载软件并解压"><a href="#_6-5-1-下载软件并解压" class="header-anchor">#</a> 6.5.1 下载软件并解压</h4> <p>harbor官网github地址 https://github.com/goharbor/harbor</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> xf harbor-offline-installer-v1.8.3.tgz -C /opt/
<span class="token function">mv</span> harbor/ harbor-v1.8.3
<span class="token function">ln</span> -s /opt/harbor-v1.8.3/ /opt/harbor
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>lrwxrwxrwx 1 root root  19 4月  14 12:13 harbor -&gt; /opt/harbor-v1.8.3/
drwxr-xr-x 2 root root 100 4月  14 12:12 harbor-v1.8.3
drwxr-xr-x 2 root root  49 4月  14 12:13 install_package
</code></pre></div><h4 id="_6-5-2-配置"><a href="#_6-5-2-配置" class="header-anchor">#</a> 6.5.2 配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /data/harbor/logs
<span class="token function">vi</span> /opt/harbor/harbor.yml
</code></pre></div><p>修改配置：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">hostname</span><span class="token punctuation">:</span> harbor.thtf.com
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">180</span>
 harbor_admin_password<span class="token punctuation">:</span>Harbor12345
<span class="token key atrule">data_volume</span><span class="token punctuation">:</span> /data/harbor
<span class="token key atrule">log</span><span class="token punctuation">:</span>
    <span class="token key atrule">level</span><span class="token punctuation">:</span>  info
    <span class="token key atrule">rotate_count</span><span class="token punctuation">:</span>  <span class="token number">50</span>
    rotate_size<span class="token punctuation">:</span>200M
    <span class="token key atrule">location</span><span class="token punctuation">:</span> /data/harbor/logs
</code></pre></div><h4 id="_6-5-3-安装-docker-compose"><a href="#_6-5-3-安装-docker-compose" class="header-anchor">#</a> 6.5.3 安装 docker-compose</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> docker-compose -y
</code></pre></div><h4 id="_6-5-4-安装-harbor"><a href="#_6-5-4-安装-harbor" class="header-anchor">#</a> 6.5.4 安装 harbor</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 进入 harbor 根目录</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">569632</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">583269670</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> harbor.v1.8.3.tar.gz
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">4528</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">12</span>:19 harbor.yml
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">5088</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> install.sh
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">11347</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> LICENSE
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">1654</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> prepare
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># ./install.sh </span>
</code></pre></div><h4 id="_6-5-5-检查-harbor-启动情况"><a href="#_6-5-5-检查-harbor-启动情况" class="header-anchor">#</a> 6.5.5 检查 harbor 启动情况</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose ps</span>
      Name                     Command               State             Ports          
--------------------------------------------------------------------------------------
harbor-core         /harbor/start.sh                 Up                               
harbor-db           /entrypoint.sh postgres          Up      <span class="token number">5432</span>/tcp                 
harbor-jobservice   /harbor/start.sh                 Up                               
harbor-log          /bin/sh -c /usr/local/bin/ <span class="token punctuation">..</span>.   Up      <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp
harbor-portal       nginx -g daemon off<span class="token punctuation">;</span>             Up      <span class="token number">80</span>/tcp                   
nginx               nginx -g daemon off<span class="token punctuation">;</span>             Up      <span class="token number">0.0</span>.0.0:180-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp      
redis               docker-entrypoint.sh redis <span class="token punctuation">..</span>.   Up      <span class="token number">6379</span>/tcp                 
registry            /entrypoint.sh /etc/regist <span class="token punctuation">..</span>.   Up      <span class="token number">5000</span>/tcp                 
registryctl         /harbor/start.sh                 Up                               
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker ps -a</span>
CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS                             PORTS                       NAMES
118479faae3c        goharbor/nginx-photon:v1.8.3                        <span class="token string">&quot;nginx -g 'daemon of…&quot;</span>   <span class="token number">27</span> seconds ago      Up <span class="token number">25</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:180-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp         nginx
a01be83050a8        goharbor/harbor-portal:v1.8.3                       <span class="token string">&quot;nginx -g 'daemon of…&quot;</span>   <span class="token number">28</span> seconds ago      Up <span class="token number">26</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp                      harbor-portal
bd00d3fa85cc        goharbor/harbor-jobservice:v1.8.3                   <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">28</span> seconds ago      Up <span class="token number">26</span> seconds                                                  harbor-jobservice
30e39e116f97        goharbor/harbor-core:v1.8.3                         <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">29</span> seconds ago      Up <span class="token number">27</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>                               harbor-core
3ecf74bd9a7b        goharbor/redis-photon:v1.8.3                        <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds                      <span class="token number">6379</span>/tcp                    redis
9acf04233a0d        goharbor/harbor-db:v1.8.3                           <span class="token string">&quot;/entrypoint.sh post…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">5432</span>/tcp                    harbor-db
0795ebef5a5d        goharbor/harbor-registryctl:v1.8.3                  <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>                               registryctl
e36367cf43e8        goharbor/registry-photon:v2.7.1-patch-2819-v1.8.3   <span class="token string">&quot;/entrypoint.sh /etc…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">5000</span>/tcp                    registry
33d5234e3edf        goharbor/harbor-log:v1.8.3                          <span class="token string">&quot;/bin/sh -c /usr/loc…&quot;</span>   <span class="token number">31</span> seconds ago      Up <span class="token number">29</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp   harbor-log

</code></pre></div><h4 id="_6-5-6-配置-harbor-的-dns-内网解析"><a href="#_6-5-6-配置-harbor-的-dns-内网解析" class="header-anchor">#</a> 6.5.6 配置 harbor 的 dns 内网解析</h4> <p>在 node-01 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /var/named/thtf.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN thtf.com.
$TTL 600    ; 10 minutes
@           IN SOA  dns.thtf.com. dnsadmin.thtf.com. (
                2020032002 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
                NS   dns.thtf.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
harbor             A    10.10.50.40
</code></pre></div><blockquote><p>2020032002 ; serial 前滚一个序号</p> <p>harbor             A    10.10.50.40</p></blockquote> <p>重启 named</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl restart named
</code></pre></div><p>检查</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A harbor.thtf.com +short</span>
<span class="token number">10.10</span>.50.40
</code></pre></div><h4 id="_6-5-6-安装-nginx-并配置"><a href="#_6-5-6-安装-nginx-并配置" class="header-anchor">#</a> 6.5.6 安装 Nginx 并配置</h4> <p>在 node-05 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> nginx -y
</code></pre></div><p>修改配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/nginx/conf.d/harbor.thtf.com.conf
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>server {
    listen       80;
    server_name  harbor.thtf.com;

    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># systemctl start nginx</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># systemctl enable nginx</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.
</code></pre></div><h4 id="_6-5-7-测试"><a href="#_6-5-7-测试" class="header-anchor">#</a> 6.5.7 测试</h4> <ol><li>浏览器输入：harbor.thtf.com</li></ol> <p><img src="/study/assets/img/harbor.d0279e60.png" alt=""></p> <ol start="2"><li><p>输入用户名：admin 密码：Harbor12345</p> <p><img src="/study/assets/img/harbor_admin.1639de8c.png" alt=""></p></li> <li><p>新建项目：public 访问级别：公开</p> <p><img src="/study/assets/img/harbor_public.15703d1a.png" alt=""></p> <p><img src="/study/assets/img/harbor_public_list.5dbf2b26.png" alt=""></p></li> <li><p>下载镜像并给镜像打 tag</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker pull nginx:1.7.9</span>
<span class="token number">1.7</span>.9: Pulling from library/nginx
Image docker.io/library/nginx:1.7.9 uses outdated schema1 manifest format. Please upgrade to a schema2 image <span class="token keyword">for</span> better future compatibility. More information at https://docs.docker.com/registry/spec/deprecated-schema-v1/
a3ed95caeb02: Pull complete 
6f5424ebd796: Pull complete 
d15444df170a: Pull complete 
e83f073daa67: Pull complete 
a4d93e421023: Pull complete 
084adbca2647: Pull complete 
c9cec474c523: Pull complete 
Digest: sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
Status: Downloaded newer image <span class="token keyword">for</span> nginx:1.7.9
docker.io/library/nginx:1.7.9
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker images|grep nginx</span>
goharbor/nginx-photon           v1.8.3                     3a016e0dc7de        <span class="token number">7</span> months ago        37MB
nginx                           <span class="token number">1.7</span>.9                      84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker tag 84581e99d807 harbor.thtf.com/public/nginx:v1.7.9</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker images|grep nginx</span>
goharbor/nginx-photon           v1.8.3           <span class="token function">vi</span> <span class="token function">vi</span>           3a016e0dc7de        <span class="token number">7</span> months ago        37MB
nginx                           <span class="token number">1.7</span>.9                      84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB
harbor.thtf.com/public/nginx     v1.7.9                     84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB

</code></pre></div></li> <li><p>登录 harbor 并上传仓库</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker login harbor.thtf.com</span>
Authenticating with existing credentials<span class="token punctuation">..</span>.
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span> /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-store</span>

Login Succeeded

<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker push harbor.thtf.com/public/nginx:v1.7.9</span>
The push refers to repository <span class="token punctuation">[</span>harbor.thtf.com/public/nginx<span class="token punctuation">]</span>
5f70bf18a086: Pushed 
4b26ab29a475: Pushed 
ccb1d68e3fb7: Pushed 
e387107e2065: Pushed 
63bf84221cce: Pushed 
e02dce553481: Pushed 
dea2e4984e29: Pushed 
v1.7.9: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: <span class="token number">3012</span>

</code></pre></div><p>可以看到NGINX镜像已经上传到public下</p> <p><img src="/study/assets/img/harbor_push.c26f187c.png" alt=""></p></li></ol> <h3 id="_6-6-部署-master-节点"><a href="#_6-6-部署-master-节点" class="header-anchor">#</a> 6.6 部署 master 节点</h3> <h4 id="_6-6-1-部署-etch-集群"><a href="#_6-6-1-部署-etch-集群" class="header-anchor">#</a> 6.6.1 部署 etch 集群</h4> <h5 id="_1-集群架构"><a href="#_1-集群架构" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP</th></tr></thead> <tbody><tr><td>node-02</td> <td>lead</td> <td>10.10.50.20</td></tr> <tr><td>node-03</td> <td>follow</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>follow</td> <td>10.10.50.99</td></tr></tbody></table> <h5 id="_2-创建基于根证书的config配置文件"><a href="#_2-创建基于根证书的config配置文件" class="header-anchor">#</a> 2）创建基于根证书的config配置文件</h5> <p>在 node-05 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /opt/certs/ca-config.json
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>{
    &quot;signing&quot;: {
        &quot;default&quot;: {
            &quot;expiry&quot;: &quot;175200h&quot;
        },
        &quot;profiles&quot;: {
            &quot;server&quot;: {
                &quot;expiry&quot;: &quot;175200h&quot;,
                &quot;usages&quot;: [
                    &quot;signing&quot;,
                    &quot;key encipherment&quot;,
                    &quot;server auth&quot;
                ]
            },
            &quot;client&quot;: {
                &quot;expiry&quot;: &quot;175200h&quot;,
                &quot;usages&quot;: [
                    &quot;signing&quot;,
                    &quot;key encipherment&quot;,
                    &quot;client auth&quot;
                ]
            },
            &quot;peer&quot;: {
                &quot;expiry&quot;: &quot;175200h&quot;,
                &quot;usages&quot;: [
                    &quot;signing&quot;,
                    &quot;key encipherment&quot;,
                    &quot;server auth&quot;,
                    &quot;client auth&quot;
                ]
            }
        }
    }
} 
</code></pre></div><h5 id="_3-创建生成自签发证书的csr的json配置文件"><a href="#_3-创建生成自签发证书的csr的json配置文件" class="header-anchor">#</a> 3）创建生成自签发证书的csr的json配置文件</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /opt/certs/etcd-peer-csr.json
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>{
    &quot;CN&quot;: &quot;k8s-etcd&quot;,
    &quot;hosts&quot;: [
        &quot;10.10.50.50&quot;,
        &quot;10.10.50.20&quot;,
        &quot;10.10.50.233&quot;,
        &quot;10.10.50.99&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;ST&quot;: &quot;beijing&quot;,
            &quot;L&quot;: &quot;beijing&quot;,
            &quot;O&quot;: &quot;thtf&quot;,
            &quot;OU&quot;: &quot;ops&quot;
        }
    ]
}
</code></pre></div><h5 id="_4-生成-etch-证书文件"><a href="#_4-生成-etch-证书文件" class="header-anchor">#</a> 4）生成 etch 证书文件</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/certs/</span>
<span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-pee</span>
</code></pre></div><h5 id="_5-检查生成的证书"><a href="#_5-检查生成的证书" class="header-anchor">#</a> 5）检查生成的证书</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">36</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">837</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">15</span>:56 ca-config.json
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">989</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">15</span>:54 ca.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">325</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">15</span>:54 ca-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">15</span>:54 ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1338</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">15</span>:54 ca.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1066</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">16</span>:02 etcd-peer.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">374</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">16</span>:01 etcd-peer-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">16</span>:02 etcd-peer-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1428</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">16</span>:02 etcd-peer.pem
</code></pre></div><h5 id="_6-创建-etch-用户"><a href="#_6-创建-etch-用户" class="header-anchor">#</a> 6）创建 etch 用户</h5> <p>在 node-02 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># useradd -s /sbin/nologin -M etcd</span>
</code></pre></div><h5 id="_7-下载-etcd-软件-解压-做软连接"><a href="#_7-下载-etcd-软件-解压-做软连接" class="header-anchor">#</a> 7）下载 etcd 软件, 解压, 做软连接</h5> <p>下载地址：https://github.com/etcd-io/etcd/tags 这里选择 3.1.20 版本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># tar -zxvf etcd-v3.1.20-linux-amd64.tar.gz -C /opt</span>
<span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20</span>
<span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># ln -s /opt/etcd-v3.1.20/ /opt/etcd</span>
<span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">0</span>
drwxr-xr-x <span class="token number">2</span> root   root   <span class="token number">71</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 certs
lrwxrwxrwx <span class="token number">1</span> root   root   <span class="token number">18</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">17</span>:05 etcd -<span class="token operator">&gt;</span> /opt/etcd-v3.1.20/
drwxr-xr-x <span class="token number">3</span> <span class="token number">478493</span> <span class="token number">89939</span> <span class="token number">123</span> <span class="token number">10</span>月 <span class="token number">11</span> <span class="token number">2018</span> etcd-v3.1.20
drwxr-xr-x <span class="token number">2</span> root   root    <span class="token number">6</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:32 soft
</code></pre></div><h5 id="_8-创建目录-拷贝证书文件"><a href="#_8-创建目录-拷贝证书文件" class="header-anchor">#</a> 8）创建目录, 拷贝证书文件</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 opt<span class="token punctuation">]</span><span class="token comment"># cd etcd/certs/</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/ca.pem .</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/etcd-peer.pem .</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/etcd-peer-key.pem .</span>
</code></pre></div><h5 id="_9-创建-etcd-服务启动脚本"><a href="#_9-创建-etcd-服务启动脚本" class="header-anchor">#</a> 9）创建 etcd 服务启动脚本</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /opt/etcd/etcd-server-startup.sh
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/bin/sh</span>
./etcd --name etcd-server-node-02 <span class="token punctuation">\</span>
       --data-dir /data/etcd/etcd-server <span class="token punctuation">\</span>
       --listen-peer-urls https://10.10.50.20:2380 <span class="token punctuation">\</span>
       --listen-client-urls https://10.10.50.20:2379,http://127.0.0.1:2379 <span class="token punctuation">\</span>
       --quota-backend-bytes <span class="token number">8000000000</span> <span class="token punctuation">\</span>
       --initial-advertise-peer-urls https://10.10.50.20:2380 <span class="token punctuation">\</span>
       --advertise-client-urls https://10.10.50.20:2379,http://127.0.0.1:2379 <span class="token punctuation">\</span>
       --initial-cluster  etcd-server-node-02<span class="token operator">=</span>https://10.10.50.20:2380,etcd-server-node-03<span class="token operator">=</span>https://10.10.50.233:2380,etcd-server-node-04<span class="token operator">=</span>https://10.10.50.99:2380 <span class="token punctuation">\</span>
       --ca-file ./certs/ca.pem <span class="token punctuation">\</span>
       --cert-file ./certs/etcd-peer.pem <span class="token punctuation">\</span>
       --key-file ./certs/etcd-peer-key.pem <span class="token punctuation">\</span>
       --client-cert-auth  <span class="token punctuation">\</span>
       --trusted-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
       --peer-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
       --peer-cert-file ./certs/etcd-peer.pem <span class="token punctuation">\</span>
       --peer-key-file ./certs/etcd-peer-key.pem <span class="token punctuation">\</span>
       --peer-client-cert-auth <span class="token punctuation">\</span>
       --peer-trusted-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
       --log-output stdout

</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /opt/etcd/etcd-server-startup.sh</span>
</code></pre></div><h5 id="_10-授权目录权限"><a href="#_10-授权目录权限" class="header-anchor">#</a> 10）授权目录权限</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># chown -R etcd.etcd /opt/etcd-v3.1.20/ /data/etcd/ /data/logs/etcd-server/</span>
</code></pre></div><h5 id="_11-安装-supervisor-软件"><a href="#_11-安装-supervisor-软件" class="header-anchor">#</a> 11）安装 supervisor 软件</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># yum install supervisor -y</span>
<span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start supervisord</span>
<span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable supervisord</span>
</code></pre></div><h5 id="_12-创建-supervisor-配置"><a href="#_12-创建-supervisor-配置" class="header-anchor">#</a> 12）创建 supervisor 配置</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/supervisord.d/etcd-server.ini</span>
</code></pre></div><div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[program:etcd-server-node-02]</span>
<span class="token constant">command</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span>
<span class="token constant">numprocs</span><span class="token attr-value"><span class="token punctuation">=</span>1                                                      ; number of processes copies to start (def 1)</span>
<span class="token constant">directory</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span>
<span class="token constant">autostart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                  ; start at supervisord start (default: true)</span>
<span class="token constant">autorestart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                ; retstart at unexpected quit (default: true)</span>
<span class="token constant">startsecs</span><span class="token attr-value"><span class="token punctuation">=</span>30                                                    ; number of secs prog must stay running (def. 1)</span>
<span class="token constant">startretries</span><span class="token attr-value"><span class="token punctuation">=</span>3                                                  ; max # of serial start failures (default 3)</span>
<span class="token constant">exitcodes</span><span class="token attr-value"><span class="token punctuation">=</span>0,2                                                   ; 'expected' exit codes for process (default 0,2)</span>
<span class="token constant">stopsignal</span><span class="token attr-value"><span class="token punctuation">=</span>QUIT                                                 ; signal used to kill process (default TERM)</span>
<span class="token constant">stopwaitsecs</span><span class="token attr-value"><span class="token punctuation">=</span>10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="token constant">user</span><span class="token attr-value"><span class="token punctuation">=</span>etcd                                                       ; setuid to this UNIX account to run the program</span>
<span class="token constant">redirect_stderr</span><span class="token attr-value"><span class="token punctuation">=</span>true                                            ; redirect proc stderr to stdout (default false)</span>
<span class="token constant">stdout_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span>
<span class="token constant">stdout_logfile_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="token constant">stdout_logfile_backups</span><span class="token attr-value"><span class="token punctuation">=</span>4                                        ; # of stdout logfile backups (default 10)</span>
<span class="token constant">stdout_capture_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>1MB                                     ; number of bytes in 'capturemode' (default 0)</span>
<span class="token constant">stdout_events_enabled</span><span class="token attr-value"><span class="token punctuation">=</span>false                                     ; emit events on stdout writes (default false)</span>
</code></pre></div><h5 id="_13-启动-etcd-服务"><a href="#_13-启动-etcd-服务" class="header-anchor">#</a> 13）启动 etcd 服务</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># supervisorctl update</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># supervisorctl status</span>
etcd-server-node-02              RUNNING   pid <span class="token number">5488</span>, <span class="token function">uptime</span> <span class="token number">0</span>:01:03
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># netstat -lntup|grep etcd</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.99:2379        <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">27058</span>/./etcd        
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:2379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">27058</span>/./etcd        
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.99:2380        <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">27058</span>/./etcd
</code></pre></div><h5 id="同理-在-node-03-node-04-上安装-etcd"><a href="#同理-在-node-03-node-04-上安装-etcd" class="header-anchor">#</a> 同理：在 node-03 node-04 上安装 etcd</h5> <p>重复 6~ 13 步骤。</p> <p>不同的地方：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>opt/etcd/etcd-server-startup.sh
<span class="token comment">##########</span>
--name
--listen-peer-urls
--listen-client-urls
--initial-advertise-peer-urls
--advertise-client-urls
<span class="token comment">##########</span>
/etc/supervisord.d/etcd-server.ini
<span class="token punctuation">[</span>program:etcd-server-node-xx<span class="token punctuation">]</span>
</code></pre></div><h5 id="检查集群状态"><a href="#检查集群状态" class="header-anchor">#</a> 检查集群状态</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 etcd<span class="token punctuation">]</span><span class="token comment"># ./etcdctl  cluster-health</span>
member 7d027ad4e297952d is healthy: got healthy result from http://127.0.0.1:2379
member 804d7a56c0ba452b is healthy: got healthy result from http://127.0.0.1:2379
member a9bfb00ec3d05a41 is healthy: got healthy result from http://127.0.0.1:2379
cluster is healthy
<span class="token punctuation">[</span>root@node-03 etcd<span class="token punctuation">]</span><span class="token comment"># ./etcdctl member list</span>
7d027ad4e297952d: <span class="token assign-left variable">name</span><span class="token operator">=</span>etcd-server-node-02 <span class="token assign-left variable">peerURLs</span><span class="token operator">=</span>https://10.10.50.20:2380 <span class="token assign-left variable">clientURLs</span><span class="token operator">=</span>http://127.0.0.1:2379,https://10.10.50.20:2379 <span class="token assign-left variable">isLeader</span><span class="token operator">=</span>false
804d7a56c0ba452b: <span class="token assign-left variable">name</span><span class="token operator">=</span>etcd-server-node-03 <span class="token assign-left variable">peerURLs</span><span class="token operator">=</span>https://10.10.50.233:2380 <span class="token assign-left variable">clientURLs</span><span class="token operator">=</span>http://127.0.0.1:2379,https://10.10.50.233:2379 <span class="token assign-left variable">isLeader</span><span class="token operator">=</span>false
a9bfb00ec3d05a41: <span class="token assign-left variable">name</span><span class="token operator">=</span>etcd-server-node-04 <span class="token assign-left variable">peerURLs</span><span class="token operator">=</span>https://10.10.50.99:2380 <span class="token assign-left variable">clientURLs</span><span class="token operator">=</span>http://127.0.0.1:2379,https://10.10.50.99:2379 <span class="token assign-left variable">isLeader</span><span class="token operator">=</span>true
</code></pre></div><h4 id="_6-6-2-部署-kube-apiserver-集群"><a href="#_6-6-2-部署-kube-apiserver-集群" class="header-anchor">#</a> 6.6.2 部署 kube-apiserver 集群</h4> <h5 id="_1-集群架构-2"><a href="#_1-集群架构-2" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP</th></tr></thead> <tbody><tr><td>node-03</td> <td>kube-apiserver</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>kube-apiserver</td> <td>10.10.50.99</td></tr></tbody></table> <h5 id="_2-下载-kube-apiserver-软件-解压-做软连接"><a href="#_2-下载-kube-apiserver-软件-解压-做软连接" class="header-anchor">#</a> 2）下载 kube-apiserver 软件, 解压, 做软连接</h5> <p>下载地址：https://github.com/kubernetes/kubernetes/releases/tag/v1.15.2</p> <p>备用地址：https://storage.googleapis.com/kubernetes-release/release/v1.15.2/kubernetes-server-linux-amd64.tar.gzclear</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf kubernetes-server-linux-amd64.tar.gz -C /opt</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/</span>
<span class="token punctuation">[</span>root@node-03 opt<span class="token punctuation">]</span><span class="token comment"># mv kubernetes/ kubernetes-v1.15.2</span>
<span class="token punctuation">[</span>root@node-03 opt<span class="token punctuation">]</span><span class="token comment"># ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes</span>
<span class="token punctuation">[</span>root@node-03 opt<span class="token punctuation">]</span><span class="token comment"># cd kubernetes</span>
<span class="token punctuation">[</span>root@node-03 kubernetes<span class="token punctuation">]</span><span class="token comment"># rm -rf kubernetes-src.tar.gz </span>
<span class="token punctuation">[</span>root@node-03 kubernetes<span class="token punctuation">]</span><span class="token comment"># cd server/bin/</span>
<span class="token punctuation">[</span>root@node-03 bin<span class="token punctuation">]</span><span class="token comment"># rm -rf *.tar</span>
<span class="token punctuation">[</span>root@node-03 bin<span class="token punctuation">]</span><span class="token comment"># rm -rf *_tag</span>
</code></pre></div><h5 id="_3-签发-client-证书"><a href="#_3-签发-client-证书" class="header-anchor">#</a> 3）签发 client 证书</h5> <p>在 node-05 上</p> <ol><li>创建生成证书 csr 的 json 配置文件</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /opt/certs/client-csr.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;k8s-node&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hosts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li><p>生成 client 证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client</span>
</code></pre></div></li> <li><p>检查生成的证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">997</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:00 client.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">282</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">18</span>:59 client-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:00 client-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1363</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:00 client.pem
</code></pre></div></li></ol> <h5 id="_4-签发-kube-apiserver-证书"><a href="#_4-签发-kube-apiserver-证书" class="header-anchor">#</a> 4）签发 kube-apiserver 证书</h5> <p>在 node-05 上</p> <ol><li><p>创建生成证书 csr 的 json 配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /opt/certs/apiserver-csr.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;k8s-apiserver&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hosts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;192.168.0.1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;kubernetes.default&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;kubernetes.default.svc&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;kubernetes.default.svc.cluster&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;kubernetes.default.svc.cluster.local&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;10.10.50.50&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;10.10.50.233&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;10.10.50.99&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;10.10.50.10&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <div class="language- extra-class"><pre class="language-text"><code>   
2. 生成 kube-apiserver 证书文件
   
      ```shell
      [root@node-05 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver
</code></pre></div><ol start="3"><li><p>检查证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">68</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1245</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:13 apiserver.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">554</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:12 apiserver-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:13 apiserver-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1590</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">19</span>:13 apiserver.pem
</code></pre></div></li></ol> <h5 id="_5-拷贝证书文件到各个节点-并创建配置"><a href="#_5-拷贝证书文件到各个节点-并创建配置" class="header-anchor">#</a> 5）拷贝证书文件到各个节点, 并创建配置</h5> <ol><li><p>拷贝证书文件到 /opt/kubernetes/server/bin/certs 目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># mkdir certs</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/ca.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/ca-key.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/client.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/client-key.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/apiserver.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/apiserver-key.pem .</span>

</code></pre></div></li> <li><p>创建配置</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># mkdir conf</span>
<span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># cd conf/</span>
<span class="token punctuation">[</span>root@node-04 conf<span class="token punctuation">]</span><span class="token comment"># vi audit.yaml</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> audit.k8s.io/v1beta1 <span class="token comment"># This is required.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Policy
<span class="token comment"># Don't generate audit events for all requests in RequestReceived stage.</span>
<span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># Log pod changes at RequestResponse level</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> RequestResponse
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token comment"># Resource &quot;pods&quot; doesn't match requests to any subresource of pods,</span>
      <span class="token comment"># which is consistent with the RBAC policy.</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods/log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pods/status&quot;</span><span class="token punctuation">]</span>

  <span class="token comment"># Don't log requests to a configmap called &quot;controller-leader&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;controller-leader&quot;</span><span class="token punctuation">]</span>

  <span class="token comment"># Don't log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;system:kube-proxy&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;endpoints&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;services&quot;</span><span class="token punctuation">]</span>

  <span class="token comment"># Don't log authenticated requests to certain non-resource URL paths.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> None
    <span class="token key atrule">userGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;system:authenticated&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;/api*&quot;</span> <span class="token comment"># Wildcard matching.</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;/version&quot;</span>

  <span class="token comment"># Log the request body of configmap changes in kube-system.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
    <span class="token comment"># This rule only applies to resources in the &quot;kube-system&quot; namespace.</span>
    <span class="token comment"># The empty string &quot;&quot; can be used to select non-namespaced resources.</span>
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;kube-system&quot;</span><span class="token punctuation">]</span>

  <span class="token comment"># Log configmap and secret changes in all other namespaces at the Metadata level.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>

  <span class="token comment"># Log all other resources in core and extensions at the Request level.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Request
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># core API group</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">&quot;extensions&quot;</span> <span class="token comment"># Version of group should NOT be included.</span>

  <span class="token comment"># A catch-all rule to log all other requests at the Metadata level.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">level</span><span class="token punctuation">:</span> Metadata
    <span class="token comment"># Long-running requests like watches that fall under this rule will not</span>
    <span class="token comment"># generate an audit event in RequestReceived.</span>
    <span class="token key atrule">omitStages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;RequestReceived&quot;</span>
</code></pre></div><h5 id="_5-创建-apiserver-启动脚本"><a href="#_5-创建-apiserver-启动脚本" class="header-anchor">#</a> 5）创建 apiserver 启动脚本</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># vi /opt/kubernetes/server/bin/kube-apiserver.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
./kube-apiserver <span class="token punctuation">\</span>
  --apiserver-count <span class="token number">2</span> <span class="token punctuation">\</span>
  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log <span class="token punctuation">\</span>
  --audit-policy-file ./conf/audit.yaml <span class="token punctuation">\</span>
  --authorization-mode RBAC <span class="token punctuation">\</span>
  --client-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
  --requestheader-client-ca-file ./cert/ca.pem <span class="token punctuation">\</span>
  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota <span class="token punctuation">\</span>
  --etcd-cafile ./certs/ca.pem <span class="token punctuation">\</span>
  --etcd-certfile ./certs/client.pem <span class="token punctuation">\</span>
  --etcd-keyfile ./certs/client-key.pem <span class="token punctuation">\</span>
  --etcd-servers https://10.10.50.20:2379,https://10.10.50.233:2379,https://10.10.50.99:2379 <span class="token punctuation">\</span>
  --service-account-key-file ./certs/ca-key.pem <span class="token punctuation">\</span>
  --service-cluster-ip-range <span class="token number">192.168</span>.0.0/16 <span class="token punctuation">\</span>
  --service-node-port-range <span class="token number">3000</span>-29999 <span class="token punctuation">\</span>
  --target-ram-mb<span class="token operator">=</span><span class="token number">1024</span> <span class="token punctuation">\</span>
  --kubelet-client-certificate ./certs/client.pem <span class="token punctuation">\</span>
  --kubelet-client-key ./certs/client-key.pem <span class="token punctuation">\</span>
  --log-dir  /data/logs/kubernetes/kube-apiserver <span class="token punctuation">\</span>
  --tls-cert-file ./certs/apiserver.pem <span class="token punctuation">\</span>
  --tls-private-key-file ./certs/apiserver-key.pem <span class="token punctuation">\</span>
  --v <span class="token number">2</span>
</code></pre></div></li></ol> <h5 id="_6-授权和创建目录"><a href="#_6-授权和创建目录" class="header-anchor">#</a> 6）授权和创建目录</h5> <div class="language- extra-class"><pre><code>  ```shell
  [root@node-04 bin]# chmod +x kube-apiserver.sh
  [root@node-04 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver
  ```
</code></pre></div><h5 id="_7-创建-supervisor-配置"><a href="#_7-创建-supervisor-配置" class="header-anchor">#</a> 7）创建 supervisor 配置</h5> <div class="language- extra-class"><pre><code>  ```shell
</code></pre></div><p>vi /etc/supervisord.d/kube-apiserver.ini
```</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[program:kube-apiserver-7-21]</span>
<span class="token constant">command</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span>
<span class="token constant">numprocs</span><span class="token attr-value"><span class="token punctuation">=</span>1                                                      ; number of processes copies to start (def 1)</span>
<span class="token constant">directory</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)</span>
<span class="token constant">autostart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                  ; start at supervisord start (default: true)</span>
<span class="token constant">autorestart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                ; retstart at unexpected quit (default: true)</span>
<span class="token constant">startsecs</span><span class="token attr-value"><span class="token punctuation">=</span>30                                                    ; number of secs prog must stay running (def. 1)</span>
<span class="token constant">startretries</span><span class="token attr-value"><span class="token punctuation">=</span>3                                                  ; max # of serial start failures (default 3)</span>
<span class="token constant">exitcodes</span><span class="token attr-value"><span class="token punctuation">=</span>0,2                                                   ; 'expected' exit codes for process (default 0,2)</span>
<span class="token constant">stopsignal</span><span class="token attr-value"><span class="token punctuation">=</span>QUIT                                                 ; signal used to kill process (default TERM)</span>
<span class="token constant">stopwaitsecs</span><span class="token attr-value"><span class="token punctuation">=</span>10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="token constant">user</span><span class="token attr-value"><span class="token punctuation">=</span>root                                                       ; setuid to this UNIX account to run the program</span>
<span class="token constant">redirect_stderr</span><span class="token attr-value"><span class="token punctuation">=</span>true                                            ; redirect proc stderr to stdout (default false)</span>
<span class="token constant">stdout_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO</span>
<span class="token constant">stdout_logfile_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="token constant">stdout_logfile_backups</span><span class="token attr-value"><span class="token punctuation">=</span>4                                        ; # of stdout logfile backups (default 10)</span>
<span class="token constant">stdout_capture_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>1MB                                     ; number of bytes in 'capturemode' (default 0)</span>
<span class="token constant">stdout_events_enabled</span><span class="token attr-value"><span class="token punctuation">=</span>false                                     ; emit events on stdout writes (default false)</span>
</code></pre></div><h5 id="_8-启动服务并检测"><a href="#_8-启动服务并检测" class="header-anchor">#</a> 8）启动服务并检测</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># supervisorctl update</span>
kube-apiserver-node-04: added process group
<span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># supervisorctl status</span>
etcd-server-node-04              RUNNING   pid <span class="token number">27057</span>, <span class="token function">uptime</span> <span class="token number">1</span>:34:08
kube-apiserver-node-04           STARTING  
<span class="token punctuation">[</span>root@node-04 bin<span class="token punctuation">]</span><span class="token comment"># netstat -nltup|grep kube-api</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:8080          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">32456</span>/./kube-apiser 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::6443                 :::*                    LISTEN      <span class="token number">32456</span>/./kube-apiser 

</code></pre></div><h5 id="同理-在-node-03-上完成-2-8-步骤"><a href="#同理-在-node-03-上完成-2-8-步骤" class="header-anchor">#</a> 同理, 在 node-03 上完成 2~8 步骤</h5> <p>不同的地方：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/supervisord.d/kube-apiserver.ini
<span class="token punctuation">[</span>program:kube-apiserver-node-03<span class="token punctuation">]</span>
</code></pre></div><h4 id="_6-6-3-部署四层反向代理"><a href="#_6-6-3-部署四层反向代理" class="header-anchor">#</a> 6.6.3 部署四层反向代理</h4> <h5 id="_1-集群架构-3"><a href="#_1-集群架构-3" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP 地址</th> <th>VIP 地址</th></tr></thead> <tbody><tr><td>node-01</td> <td>L4</td> <td>10.10.50.50</td> <td>10.50.50.xx</td></tr> <tr><td>node-02</td> <td>L4</td> <td>10.10.50.20</td> <td>10.10.50.xx</td></tr></tbody></table> <h5 id="_2-安装-nginx-和-keepalived"><a href="#_2-安装-nginx-和-keepalived" class="header-anchor">#</a> 2）安装 Nginx 和 Keepalived</h5> <p>在 node-01 和 node-02 上都安装 Nginx 和 Keepalived</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> nginx keepalived -y
</code></pre></div><p>在 node-01 和 node-02 上配置 Nginx</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/nginx/nginx.conf
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code># 加在配置文件末尾
stream {
    upstream kube-apiserver {
        server 10.10.50.233:6443     max_fails=3 fail_timeout=30s;
        server 10.10.50.99:6443     max_fails=3 fail_timeout=30s;
    }
    server {
        listen 7443;
        proxy_connect_timeout 2s;
        proxy_timeout 900s;
        proxy_pass kube-apiserver;
    }
}
</code></pre></div><p>在 node-01 和 node-02 上配置 keepalived</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 检测脚本</span>
<span class="token function">vi</span> /etc/keepalived/check_port.sh
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#keepalived 监控端口脚本</span>
<span class="token comment">#使用方法：</span>
<span class="token comment">#在keepalived的配置文件中</span>
<span class="token comment">#vrrp_script check_port {#创建一个vrrp_script脚本,检查配置</span>
<span class="token comment">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span>
<span class="token comment">#    interval 2 #检查脚本的频率,单位（秒）</span>
<span class="token comment">#}</span>
<span class="token assign-left variable">CHK_PORT</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">&quot;<span class="token variable">$CHK_PORT</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token assign-left variable">PORT_PROCESS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>ss -lnt<span class="token operator">|</span><span class="token function">grep</span> $CHK_PORT<span class="token operator">|</span><span class="token function">wc</span> -l<span class="token variable">`</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$PORT_PROCESS</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
                <span class="token builtin class-name">echo</span> <span class="token string">&quot;Port <span class="token variable">$CHK_PORT</span> Is Not Used,End.&quot;</span>
                <span class="token builtin class-name">exit</span> <span class="token number">1</span>
        <span class="token keyword">fi</span>
<span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Check Port Cant Be Empty!&quot;</span>
<span class="token keyword">fi</span>
</code></pre></div><p>修改执行权限</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> +x /etc/keepalived/check_port.sh
</code></pre></div><p>keepalived 主配置 node-01</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>! Configuration File for keepalived

global_defs {
   router_id 10.10.50.50

}

vrrp_script chk_nginx {
    script &quot;/etc/keepalived/check_port.sh 7443&quot;
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 251
    priority 100
    advert_int 1
    mcast_src_ip 10.10.50.50
    nopreempt

    authentication {
        auth_type PASS
        auth_pass 11111111
    }
    track_script {
         chk_nginx
    }
    virtual_ipaddress {
        10.10.50.10
    }
}
</code></pre></div><p>keepalived 从配置 node-02</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf </span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>! Configuration File for keepalived
global_defs {
    router_id 10.10.50.20
}
vrrp_script chk_nginx {
    script &quot;/etc/keepalived/check_port.sh 7443&quot;
    interval 2
    weight -20
}
vrrp_instance VI_1 {
    state BACKUP
    interface eth0 #### 这里的网卡名称需要和主机保持一致
    virtual_router_id 251
    mcast_src_ip 10.10.50.20
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 11111111
    }
    track_script {
        chk_nginx
    }
    virtual_ipaddress {
        10.10.50.10
    }
}
</code></pre></div><h5 id="_3-启动代理并检查"><a href="#_3-启动代理并检查" class="header-anchor">#</a> 3）启动代理并检查</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl start nginx keepalived
systemctl <span class="token builtin class-name">enable</span> nginx keepalived
<span class="token function">netstat</span> -lntup<span class="token operator">|</span><span class="token function">grep</span> nginx
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># ip addr</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span> 
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: enp0s3: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 08:00:27:1c:87:23 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.10</span>.50.50/24 brd <span class="token number">10.10</span>.50.255 scope global noprefixroute dynamic enp0s3
       valid_lft 83981sec preferred_lft 83981sec
    inet <span class="token number">10.10</span>.50.10/32 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::311e:9caf:bb5:e825/64 scope <span class="token function">link</span> noprefixroute 
       valid_lft forever preferred_lft forever
</code></pre></div><h4 id="_6-6-4-部署-controller-manager-集群"><a href="#_6-6-4-部署-controller-manager-集群" class="header-anchor">#</a> 6.6.4 部署 controller-manager 集群</h4> <h5 id="_1-集群架构-4"><a href="#_1-集群架构-4" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP地址</th></tr></thead> <tbody><tr><td>node-03</td> <td>controller-manager</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>controller-manager</td> <td>10.10.50.99</td></tr></tbody></table> <p>接下来, 以 node-03 为例</p> <h5 id="_2-创建启动脚本"><a href="#_2-创建启动脚本" class="header-anchor">#</a> 2）创建启动脚本</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /opt/kubernetes/server/bin/kube-controller-manager.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>
./kube-controller-manager <span class="token punctuation">\</span>
  --cluster-cidr <span class="token number">172.7</span>.0.0/16 <span class="token punctuation">\</span>
  --leader-elect <span class="token boolean">true</span> <span class="token punctuation">\</span>
  --log-dir /data/logs/kubernetes/kube-controller-manager <span class="token punctuation">\</span>
  --master http://127.0.0.1:8080 <span class="token punctuation">\</span>
  --service-account-private-key-file ./certs/ca-key.pem <span class="token punctuation">\</span>
  --service-cluster-ip-range <span class="token number">192.168</span>.0.0/16 <span class="token punctuation">\</span>
  --root-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
  --v <span class="token number">2</span> 
</code></pre></div><h5 id="_3-授权文件权限-创建目录"><a href="#_3-授权文件权限-创建目录" class="header-anchor">#</a> 3）授权文件权限, 创建目录</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh </span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/logs/kubernetes/kube-controller-manager</span>
</code></pre></div><h5 id="_4-创建-supervisor-配置"><a href="#_4-创建-supervisor-配置" class="header-anchor">#</a> 4）创建 supervisor 配置</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/supervisord.d/kube-conntroller-manager.ini</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>program:kube-controller-manager-node-03<span class="token punctuation">]</span>
<span class="token assign-left variable">command</span><span class="token operator">=</span>/opt/kubernetes/server/bin/kube-controller-manager.sh                     <span class="token punctuation">;</span> the program <span class="token punctuation">(</span>relative uses <span class="token environment constant">PATH</span>, can take args<span class="token punctuation">)</span>
<span class="token assign-left variable">numprocs</span><span class="token operator">=</span><span class="token number">1</span>                                                                        <span class="token punctuation">;</span> number of processes copies to start <span class="token punctuation">(</span>def <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token assign-left variable">directory</span><span class="token operator">=</span>/opt/kubernetes/server/bin                                              <span class="token punctuation">;</span> directory to cwd to before <span class="token builtin class-name">exec</span> <span class="token punctuation">(</span>def no cwd<span class="token punctuation">)</span>
<span class="token assign-left variable">autostart</span><span class="token operator">=</span>true                                                                    <span class="token punctuation">;</span> start at supervisord start <span class="token punctuation">(</span>default: <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token assign-left variable">autorestart</span><span class="token operator">=</span>true                                                                  <span class="token punctuation">;</span> retstart at unexpected quit <span class="token punctuation">(</span>default: <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token assign-left variable">startsecs</span><span class="token operator">=</span><span class="token number">30</span>                                                                      <span class="token punctuation">;</span> number of secs prog must stay running <span class="token punctuation">(</span>def. <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token assign-left variable">startretries</span><span class="token operator">=</span><span class="token number">3</span>                                                                    <span class="token punctuation">;</span> max <span class="token comment"># of serial start failures (default 3)</span>
<span class="token assign-left variable">exitcodes</span><span class="token operator">=</span><span class="token number">0,2</span>                                                                     <span class="token punctuation">;</span> <span class="token string">'expected'</span> <span class="token builtin class-name">exit</span> codes <span class="token keyword">for</span> process <span class="token punctuation">(</span>default <span class="token number">0,2</span><span class="token punctuation">)</span>
<span class="token assign-left variable">stopsignal</span><span class="token operator">=</span>QUIT                                                                   <span class="token punctuation">;</span> signal used to <span class="token function">kill</span> process <span class="token punctuation">(</span>default <span class="token environment constant">TERM</span><span class="token punctuation">)</span>
<span class="token assign-left variable">stopwaitsecs</span><span class="token operator">=</span><span class="token number">10</span>                                                                   <span class="token punctuation">;</span> max num secs to <span class="token function">wait</span> b4 SIGKILL <span class="token punctuation">(</span>default <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>root                                                                         <span class="token punctuation">;</span> setuid to this UNIX account to run the program
<span class="token assign-left variable">redirect_stderr</span><span class="token operator">=</span>true                                                              <span class="token punctuation">;</span> redirect proc stderr to stdout <span class="token punctuation">(</span>default <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token assign-left variable">stdout_logfile</span><span class="token operator">=</span>/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  <span class="token punctuation">;</span> stderr log path, NONE <span class="token keyword">for</span> none<span class="token punctuation">;</span> default AUTO
<span class="token assign-left variable">stdout_logfile_maxbytes</span><span class="token operator">=</span>64MB                                                      <span class="token punctuation">;</span> max <span class="token comment"># logfile bytes b4 rotation (default 50MB)</span>
<span class="token assign-left variable">stdout_logfile_backups</span><span class="token operator">=</span><span class="token number">4</span>                                                          <span class="token punctuation">;</span> <span class="token comment"># of stdout logfile backups (default 10)</span>
<span class="token assign-left variable">stdout_capture_maxbytes</span><span class="token operator">=</span>1MB                                                       <span class="token punctuation">;</span> number of bytes <span class="token keyword">in</span> <span class="token string">'capturemode'</span> <span class="token punctuation">(</span>default <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token assign-left variable">stdout_events_enabled</span><span class="token operator">=</span>false                                                       <span class="token punctuation">;</span> emit events on stdout writes <span class="token punctuation">(</span>default <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_5-启动服务并检查"><a href="#_5-启动服务并检查" class="header-anchor">#</a> 5）启动服务并检查</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl update</span>
kube-controller-manager-node-03: added process group
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl status</span>
etcd-server-node-03               RUNNING   pid <span class="token number">4912</span>, <span class="token function">uptime</span> <span class="token number">2</span>:33:03
kube-apiserver-node-03            RUNNING   pid <span class="token number">4913</span>, <span class="token function">uptime</span> <span class="token number">2</span>:33:03
kube-controller-manager-node-03   STARTING 
</code></pre></div><h5 id="同理-另一台按照-2-5-步骤执行"><a href="#同理-另一台按照-2-5-步骤执行" class="header-anchor">#</a> 同理, 另一台按照 2~5 步骤执行</h5> <p>不同的地方</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/supervisord.d/kube-conntroller-manager.ini
<span class="token punctuation">[</span>program:kube-controller-manager-node-04<span class="token punctuation">]</span>
</code></pre></div><h4 id="_6-6-5-部署-kube-scheduler-集群"><a href="#_6-6-5-部署-kube-scheduler-集群" class="header-anchor">#</a> 6.6.5 部署 kube-scheduler 集群</h4> <h5 id="_1-集群架构-5"><a href="#_1-集群架构-5" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP地址</th></tr></thead> <tbody><tr><td>node-03</td> <td>kube-scheduler</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>kube-scheduler</td> <td>10.10.50.99</td></tr></tbody></table> <p>接下来, 以 node-03 为例</p> <h5 id="_2-创建启动脚本-2"><a href="#_2-创建启动脚本-2" class="header-anchor">#</a> 2）创建启动脚本</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment">#vi /opt/kubernetes/server/bin/kube-scheduler.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>
./kube-scheduler <span class="token punctuation">\</span>
  --leader-elect  <span class="token punctuation">\</span>
  --log-dir /data/logs/kubernetes/kube-scheduler <span class="token punctuation">\</span>
  --master http://127.0.0.1:8080 <span class="token punctuation">\</span>
  --v <span class="token number">2</span>
</code></pre></div><h5 id="_3-授权文件权限-创建目录-2"><a href="#_3-授权文件权限-创建目录-2" class="header-anchor">#</a> 3）授权文件权限, 创建目录</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x  /opt/kubernetes/server/bin/kube-scheduler.sh</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/logs/kubernetes/kube-scheduler</span>
</code></pre></div><h5 id="_4-创建-supervisor-配置-2"><a href="#_4-创建-supervisor-配置-2" class="header-anchor">#</a> 4）创建 supervisor 配置</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/supervisord.d/kube-scheduler.ini</span>
</code></pre></div><div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[program:kube-scheduler-node-03]</span>
<span class="token constant">command</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span>
<span class="token constant">numprocs</span><span class="token attr-value"><span class="token punctuation">=</span>1                                                               ; number of processes copies to start (def 1)</span>
<span class="token constant">directory</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span>
<span class="token constant">autostart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                           ; start at supervisord start (default: true)</span>
<span class="token constant">autorestart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                         ; retstart at unexpected quit (default: true)</span>
<span class="token constant">startsecs</span><span class="token attr-value"><span class="token punctuation">=</span>30                                                             ; number of secs prog must stay running (def. 1)</span>
<span class="token constant">startretries</span><span class="token attr-value"><span class="token punctuation">=</span>3                                                           ; max # of serial start failures (default 3)</span>
<span class="token constant">exitcodes</span><span class="token attr-value"><span class="token punctuation">=</span>0,2                                                            ; 'expected' exit codes for process (default 0,2)</span>
<span class="token constant">stopsignal</span><span class="token attr-value"><span class="token punctuation">=</span>QUIT                                                          ; signal used to kill process (default TERM)</span>
<span class="token constant">stopwaitsecs</span><span class="token attr-value"><span class="token punctuation">=</span>10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="token constant">user</span><span class="token attr-value"><span class="token punctuation">=</span>root                                                                ; setuid to this UNIX account to run the program</span>
<span class="token constant">redirect_stderr</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                     ; redirect proc stderr to stdout (default false)</span>
<span class="token constant">stdout_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span>
<span class="token constant">stdout_logfile_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="token constant">stdout_logfile_backups</span><span class="token attr-value"><span class="token punctuation">=</span>4                                                 ; # of stdout logfile backups (default 10)</span>
<span class="token constant">stdout_capture_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>1MB                                              ; number of bytes in 'capturemode' (default 0)</span>
<span class="token constant">stdout_events_enabled</span><span class="token attr-value"><span class="token punctuation">=</span>false                                              ; emit events on stdout writes (default false)</span>
</code></pre></div><h5 id="_5-启动服务并检查-2"><a href="#_5-启动服务并检查-2" class="header-anchor">#</a> 5）启动服务并检查</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl update</span>
kube-scheduler-node-03: added process group
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl status</span>
etcd-server-node-03               RUNNING   pid <span class="token number">4912</span>, <span class="token function">uptime</span> <span class="token number">2</span>:43:36
kube-apiserver-node-03            RUNNING   pid <span class="token number">4913</span>, <span class="token function">uptime</span> <span class="token number">2</span>:43:36
kube-controller-manager-node-03   STARTING  
kube-scheduler-node-03            STARTING 
</code></pre></div><h5 id="同理-另一台按照-2-5-步骤执行-2"><a href="#同理-另一台按照-2-5-步骤执行-2" class="header-anchor">#</a> 同理, 另一台按照 2~5 步骤执行</h5> <p>不同的地方</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/etc/supervisord.d/kube-scheduler.ini
<span class="token punctuation">[</span>program:kube-scheduler-node-04<span class="token punctuation">]</span>
</code></pre></div><h4 id="_6-6-6-检查-master节点"><a href="#_6-6-6-检查-master节点" class="header-anchor">#</a> 6.6.6 检查 master节点</h4> <h5 id="建立-kubectl-软连接"><a href="#建立-kubectl-软连接" class="header-anchor">#</a> 建立 kubectl 软连接</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span>
</code></pre></div><h5 id="检查-master-节点"><a href="#检查-master-节点" class="header-anchor">#</a> 检查 master 节点</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cs</span>
NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok                   
controller-manager   Healthy   ok                   
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>   
etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span> 
</code></pre></div><h3 id="_6-7-部署-node-节点"><a href="#_6-7-部署-node-节点" class="header-anchor">#</a> 6.7 部署 node 节点</h3> <h4 id="_6-7-1-部署-kubelet"><a href="#_6-7-1-部署-kubelet" class="header-anchor">#</a> 6.7.1 部署 kubelet</h4> <h5 id="_1-集群架构-6"><a href="#_1-集群架构-6" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP地址</th></tr></thead> <tbody><tr><td>node-03</td> <td>kubelet</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>kubelet</td> <td>10.10.50.99</td></tr></tbody></table> <p>以 node-03 为例</p> <h5 id="_2-签发-kubelet-证书"><a href="#_2-签发-kubelet-证书" class="header-anchor">#</a> 2）签发 kubelet 证书</h5> <p>在 node-05 上</p> <ol><li><p>创建生成证书 crs 的 json 配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># vi /opt/certs/kubelet-csr.json</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;k8s-kubelet&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hosts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;10.10.50.50&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;10.10.50.20&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;10.10.50.40&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;10.10.50.233&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;10.10.50.99&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>生成 kubelet 证书</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span>
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">602300016453030103556289231370796933909552612578</span>
<span class="token number">2020</span>/04/15 09:38:02 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre></div><ol start="3"><li>检查生成的证书文件</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1086</span> <span class="token number">4</span>月  <span class="token number">15</span> 09:38 kubelet.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">397</span> <span class="token number">4</span>月  <span class="token number">15</span> 09:33 kubelet-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>月  <span class="token number">15</span> 09:38 kubelet-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1432</span> <span class="token number">4</span>月  <span class="token number">15</span> 09:38 kubelet.pem
</code></pre></div></li></ol> <h5 id="_3-拷贝证书文件到各个节点-并创建配置"><a href="#_3-拷贝证书文件到各个节点-并创建配置" class="header-anchor">#</a> 3）拷贝证书文件到各个节点, 并创建配置</h5> <p>在 node-03 上</p> <ol><li><p>拷贝文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~ <span class="token punctuation">]</span><span class="token comment"># cd /opt/kubernetes/server/bin/certs/</span>
<span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kubelet.pem .</span>
<span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kubelet-key.pem .</span>
</code></pre></div></li> <li><p>创建配置</p> <p>注意：在 conf 目录下, 没有就创建</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /opt/kubernetes/server/bin/conf
</code></pre></div><p><strong>set-cluster</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster myk8s \</span>
--certificate-authority<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://10.10.50.10:7443 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubelet.kubeconfig
</code></pre></div><p><strong>set-credentials</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials k8s-node \</span>
--client-certificate<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/client.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/client-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubelet.kubeconfig
</code></pre></div><p><strong>set-context</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context myk8s-context \</span>
--cluster<span class="token operator">=</span>myk8s <span class="token punctuation">\</span>
--user<span class="token operator">=</span>k8s-node <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kubelet.kubeconfig
</code></pre></div><p><strong>use-context</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span>
</code></pre></div><p><strong>查看生成的kubelet.kubeconfig</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">8</span>
-rw------- <span class="token number">1</span> root root <span class="token number">6189</span> <span class="token number">4</span>月  <span class="token number">15</span> <span class="token number">15</span>:17 kubelet.kubeconfig
</code></pre></div><p><strong>k8s-node.yaml</strong></p> <p>a. 创建配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># vi k8s-node.yaml</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>node
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node
</code></pre></div><p>b. 应用资源配置</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl create -f k8s-node.yaml</span>
</code></pre></div><p>c. 查看集群角色和角色属性</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl get clusterrolebinding k8s-node</span>
NAME       AGE
k8s-node   32s
<span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl get clusterrolebinding k8s-node -o yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: <span class="token string">&quot;2020-04-15T07:22:34Z&quot;</span>
  name: k8s-node
  resourceVersion: <span class="token string">&quot;55622&quot;</span>
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-node
  uid: f98c058b-e544-43e2-b926-6bda476a39fb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: k8s-node
</code></pre></div><p><strong>将 node-03 上生成的 kubelet.kubeconfig 拷贝到 node-04 的 conf 中</strong></p> <p>在 node-04 上创建 conf 目录, 把 node-03 生成的kubelet.kubeconfig直接拷贝到目标服务器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /opt/kubernetes/server/bin/conf</span>
<span class="token punctuation">[</span>root@node-04 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/kubernetes/server/bin/conf/</span>
<span class="token punctuation">[</span>root@node-04 conf<span class="token punctuation">]</span><span class="token comment"># scp node-03:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .</span>
</code></pre></div><p>同时, 将从 node-05 上 kubelet 对应的证书文件拷贝到目标服务器 /opt/kubernetes/server/bin/certs 目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kubelet.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kubelet-key.pem .</span>
</code></pre></div><p>查看集群角色和角色属性</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 conf<span class="token punctuation">]</span><span class="token comment"># kubectl get clusterrolebinding k8s-node</span>
NAME       AGE
k8s-node   35m
<span class="token punctuation">[</span>root@node-04 conf<span class="token punctuation">]</span><span class="token comment"># kubectl get clusterrolebinding k8s-node -o yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: <span class="token string">&quot;2020-04-15T07:22:34Z&quot;</span>
  name: k8s-node
  resourceVersion: <span class="token string">&quot;55622&quot;</span>
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/k8s-node
  uid: f98c058b-e544-43e2-b926-6bda476a39fb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: k8s-node
</code></pre></div></li></ol> <h5 id="_4-准备-pause-基础镜像"><a href="#_4-准备-pause-基础镜像" class="header-anchor">#</a> 4）准备 pause 基础镜像</h5> <p>在 node-05 上</p> <p>a. 下载 pause 镜像</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># docker pull kubernetes/pause</span>
</code></pre></div><p>b. 上传到 docker 私有仓库 harbor 中</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># docker images -a | grep pause</span>
kubernetes/pause                latest                     f9d5de079539        <span class="token number">5</span> years ago         240kB
<span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># docker tag f9d5de079539 harbor.thtf.com/public/pause:latest</span>
<span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># docker images -a | grep pause</span>
kubernetes/pause                latest                     f9d5de079539        <span class="token number">5</span> years ago         240kB
harbor.thtf.com/public/pause    latest                     f9d5de079539        <span class="token number">5</span> years ago         240kB
<span class="token punctuation">[</span>root@node-05 ~<span class="token punctuation">]</span><span class="token comment"># docker push harbor.thtf.com/public/pause:latest</span>
</code></pre></div><h5 id="_5-创建-kubelet-启动脚本"><a href="#_5-创建-kubelet-启动脚本" class="header-anchor">#</a> 5）创建 kubelet 启动脚本</h5> <p>在 node-03 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /opt/kubernetes/server/bin/kubelet.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>
./kubelet <span class="token punctuation">\</span>
  --anonymous-auth<span class="token operator">=</span>false <span class="token punctuation">\</span>
  --cgroup-driver systemd <span class="token punctuation">\</span>
  --cluster-dns <span class="token number">192.168</span>.0.2 <span class="token punctuation">\</span>
  --cluster-domain cluster.local <span class="token punctuation">\</span>
  --runtime-cgroups<span class="token operator">=</span>/systemd/system.slice <span class="token punctuation">\</span>
  --kubelet-cgroups<span class="token operator">=</span>/systemd/system.slice <span class="token punctuation">\</span>
  --fail-swap-on<span class="token operator">=</span><span class="token string">&quot;false&quot;</span> <span class="token punctuation">\</span>
  --client-ca-file ./certs/ca.pem <span class="token punctuation">\</span>
  --tls-cert-file ./certs/kubelet.pem <span class="token punctuation">\</span>
  --tls-private-key-file ./certs/kubelet-key.pem <span class="token punctuation">\</span>
  --hostname-override node-03 <span class="token punctuation">\</span>
  --image-gc-high-threshold <span class="token number">20</span> <span class="token punctuation">\</span>
  --image-gc-low-threshold <span class="token number">10</span> <span class="token punctuation">\</span>
  --kubeconfig ./conf/kubelet.kubeconfig <span class="token punctuation">\</span>
  --log-dir /data/logs/kubernetes/kube-kubelet <span class="token punctuation">\</span>
  --pod-infra-container-image harbor.thtf.com/public/pause:latest <span class="token punctuation">\</span>
  --root-dir /data/kubelet
</code></pre></div><p>授权, 创建目录</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /opt/kubernetes/server/bin/kubelet.sh </span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/logs/kubernetes/kube-kubelet   /data/kubelet</span>
</code></pre></div><h5 id="_6-创建-supervisor-配置"><a href="#_6-创建-supervisor-配置" class="header-anchor">#</a> 6）创建 supervisor 配置</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/supervisord.d/kube-kubelet.ini</span>
</code></pre></div><div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[program:kube-kubelet-node-03]</span>
<span class="token constant">command</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span>
<span class="token constant">numprocs</span><span class="token attr-value"><span class="token punctuation">=</span>1                                        ; number of processes copies to start (def 1)</span>
<span class="token constant">directory</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span>
<span class="token constant">autostart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                    ; start at supervisord start (default: true)</span>
<span class="token constant">autorestart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                  ; retstart at unexpected quit (default: true)</span>
<span class="token constant">startsecs</span><span class="token attr-value"><span class="token punctuation">=</span>30                                      ; number of secs prog must stay running (def. 1)</span>
<span class="token constant">startretries</span><span class="token attr-value"><span class="token punctuation">=</span>3                                    ; max # of serial start failures (default 3)</span>
<span class="token constant">exitcodes</span><span class="token attr-value"><span class="token punctuation">=</span>0,2                                     ; 'expected' exit codes for process (default 0,2)</span>
<span class="token constant">stopsignal</span><span class="token attr-value"><span class="token punctuation">=</span>QUIT                                   ; signal used to kill process (default TERM)</span>
<span class="token constant">stopwaitsecs</span><span class="token attr-value"><span class="token punctuation">=</span>10                                   ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="token constant">user</span><span class="token attr-value"><span class="token punctuation">=</span>root                                         ; setuid to this UNIX account to run the program</span>
<span class="token constant">redirect_stderr</span><span class="token attr-value"><span class="token punctuation">=</span>true                              ; redirect proc stderr to stdout (default false)</span>
<span class="token constant">stdout_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span>
<span class="token constant">stdout_logfile_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="token constant">stdout_logfile_backups</span><span class="token attr-value"><span class="token punctuation">=</span>4                          ; # of stdout logfile backups (default 10)</span>
<span class="token constant">stdout_capture_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>1MB                       ; number of bytes in 'capturemode' (default 0)</span>
<span class="token constant">stdout_events_enabled</span><span class="token attr-value"><span class="token punctuation">=</span>false                       ; emit events on stdout writes (default false)</span>
</code></pre></div><h5 id="_7-启动服务并检查"><a href="#_7-启动服务并检查" class="header-anchor">#</a> 7）启动服务并检查</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl  update</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl  status</span>
</code></pre></div><h5 id="同理-node-04-上按-5-7-步骤执行"><a href="#同理-node-04-上按-5-7-步骤执行" class="header-anchor">#</a> 同理, node-04 上按 5~7 步骤执行</h5> <p>不同的地方</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/opt/kubernetes/server/bin/kubelet.sh
--hostname-override node-04
<span class="token comment">##########</span>
/etc/supervisord.d/kube-kubelet.ini
<span class="token punctuation">[</span>program:kube-kubelet-node-04<span class="token punctuation">]</span>
</code></pre></div><h4 id="_6-7-2-部署-kube-proxy"><a href="#_6-7-2-部署-kube-proxy" class="header-anchor">#</a> 6.7.2 部署 kube-proxy</h4> <h5 id="_1-集群架构-7"><a href="#_1-集群架构-7" class="header-anchor">#</a> 1）集群架构</h5> <table><thead><tr><th>主机名</th> <th>角色</th> <th>IP地址</th></tr></thead> <tbody><tr><td>node-03</td> <td>kubelet</td> <td>10.10.50.233</td></tr> <tr><td>node-04</td> <td>kubelet</td> <td>10.10.50.99</td></tr></tbody></table> <p>以 node-03 为例</p> <h5 id="_2-签发-kube-proxy-证书"><a href="#_2-签发-kube-proxy-证书" class="header-anchor">#</a> 2）签发 kube-proxy 证书</h5> <p>在 node-05 上</p> <p>a. 创建生成证书 csr 的 json 配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># vi kube-proxy-csr.json</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system:kube-proxy&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>b. 生成 kube-proxy 证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span>
</code></pre></div><p>c. 检查生成的证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code>-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1009</span> <span class="token number">4</span>月  <span class="token number">17</span> <span class="token number">15</span>:35 kube-proxy-client.csr
-rw------- <span class="token number">1</span> root root <span class="token number">1679</span> <span class="token number">4</span>月  <span class="token number">17</span> <span class="token number">15</span>:35 kube-proxy-client-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1375</span> <span class="token number">4</span>月  <span class="token number">17</span> <span class="token number">15</span>:35 kube-proxy-client.pem
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">269</span> <span class="token number">4</span>月  <span class="token number">17</span> <span class="token number">15</span>:35 kube-proxy-csr.json
</code></pre></div><h5 id="_3-拷贝证书文件到各个节点-并创建配置-2"><a href="#_3-拷贝证书文件到各个节点-并创建配置-2" class="header-anchor">#</a> 3）拷贝证书文件到各个节点, 并创建配置</h5> <p>在 node-03 上</p> <ol><li><p>拷贝证书文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/kubernetes/server/bin/certs/</span>
<span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kube-proxy-client.pem .</span>
<span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kube-proxy-client-key.pem .</span>
</code></pre></div></li> <li><p>创建配置</p> <p>进入：/opt/kubernetes/server/bin/conf</p> <p><strong>set-cluster</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 conf<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster myk8s \</span>
--certificate-authority<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/ca.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--server<span class="token operator">=</span>https://10.10.50.10:7443 <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre></div><p><strong>set-credentials</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials kube-proxy \</span>
--client-certificate<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/kube-proxy-client.pem <span class="token punctuation">\</span>
--client-key<span class="token operator">=</span>/opt/kubernetes/server/bin/certs/kube-proxy-client-key.pem <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre></div><p><strong>set-context</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context myk8s-context \</span>
--cluster<span class="token operator">=</span>myk8s <span class="token punctuation">\</span>
--user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
--kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre></div><p><strong>use-context</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 certs<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span>
</code></pre></div><p><strong>将 node-03 上生成的 kube-proxy.kubeconfig 到 node-04 的conf目录下</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/kubernetes/server/bin/conf/</span>
<span class="token punctuation">[</span>root@node-04 conf<span class="token punctuation">]</span><span class="token comment"># scp node-03:/opt/kubernetes/server/bin/conf/kube-proxy.kubeconfig .</span>
</code></pre></div><p>同时, 将从 node-05 上 kubelet 对应的证书文件拷贝到目标服务器 /opt/kubernetes/server/bin/certs 目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-04 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/kubernetes/server/bin/certs/</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kube-proxy-client.pem .</span>
<span class="token punctuation">[</span>root@node-04 certs<span class="token punctuation">]</span><span class="token comment"># scp node-05:/opt/certs/kube-proxy-client-key.pem .</span>
</code></pre></div></li></ol> <h5 id="_4-创建-kube-proxy-启动脚本"><a href="#_4-创建-kube-proxy-启动脚本" class="header-anchor">#</a> 4）创建 kube-proxy 启动脚本</h5> <p>在 node-03 上</p> <p>a. 加载 ipvs 模块</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep ip_vs</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /root/ipvs.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ipvs_mods_dir</span><span class="token operator">=</span><span class="token string">&quot;/usr/lib/modules/<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -r<span class="token variable">)</span></span>/kernel/net/netfilter/ipvs&quot;</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $ipvs_mods_dir<span class="token operator">|</span><span class="token function">grep</span> -o <span class="token string">&quot;^[^.]*&quot;</span><span class="token variable">)</span></span>
<span class="token keyword">do</span>
  /sbin/modinfo -F filename <span class="token variable">$i</span> <span class="token operator">&amp;&gt;</span>/dev/null
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    /sbin/modprobe <span class="token variable">$i</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>    
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /root/ipvs.sh </span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># sh /root/ipvs.sh </span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep ip_vs</span>
</code></pre></div><p>b. 创建启动脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /opt/kubernetes/server/bin/kube-proxy.sh</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/sh</span>
./kube-proxy <span class="token punctuation">\</span>
--cluster-cidr <span class="token number">172.7</span>.0.0/16 <span class="token punctuation">\</span>
--hostname-override node-03<span class="token punctuation">\</span>
--proxy-mode<span class="token operator">=</span>ipvs <span class="token punctuation">\</span>
--ipvs-scheduler<span class="token operator">=</span>nq <span class="token punctuation">\</span>
--kubeconfig ./conf/kube-proxy.kubeconfig	
</code></pre></div><p>c. 授权, 创建目录</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># ls -l /opt/kubernetes/server/bin/conf/|grep kube-proxy</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /opt/kubernetes/server/bin/kube-proxy.sh </span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/logs/kubernetes/kube-proxy</span>
</code></pre></div><h5 id="_5-创建-supervisor-配置"><a href="#_5-创建-supervisor-配置" class="header-anchor">#</a> 5）创建 supervisor 配置</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/supervisord.d/kube-proxy.ini</span>
</code></pre></div><div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[program:kube-proxy-node-03]</span>
<span class="token constant">command</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span>
<span class="token constant">numprocs</span><span class="token attr-value"><span class="token punctuation">=</span>1                                                           ; number of processes copies to start (def 1)</span>
<span class="token constant">directory</span><span class="token attr-value"><span class="token punctuation">=</span>/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span>
<span class="token constant">autostart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                       ; start at supervisord start (default: true)</span>
<span class="token constant">autorestart</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                     ; retstart at unexpected quit (default: true)</span>
<span class="token constant">startsecs</span><span class="token attr-value"><span class="token punctuation">=</span>30                                                         ; number of secs prog must stay running (def. 1)</span>
<span class="token constant">startretries</span><span class="token attr-value"><span class="token punctuation">=</span>3                                                       ; max # of serial start failures (default 3)</span>
<span class="token constant">exitcodes</span><span class="token attr-value"><span class="token punctuation">=</span>0,2                                                        ; 'expected' exit codes for process (default 0,2)</span>
<span class="token constant">stopsignal</span><span class="token attr-value"><span class="token punctuation">=</span>QUIT                                                      ; signal used to kill process (default TERM)</span>
<span class="token constant">stopwaitsecs</span><span class="token attr-value"><span class="token punctuation">=</span>10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span>
<span class="token constant">user</span><span class="token attr-value"><span class="token punctuation">=</span>root                                                            ; setuid to this UNIX account to run the program</span>
<span class="token constant">redirect_stderr</span><span class="token attr-value"><span class="token punctuation">=</span>true                                                 ; redirect proc stderr to stdout (default false)</span>
<span class="token constant">stdout_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span>
<span class="token constant">stdout_logfile_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span>
<span class="token constant">stdout_logfile_backups</span><span class="token attr-value"><span class="token punctuation">=</span>4                                             ; # of stdout logfile backups (default 10)</span>
<span class="token constant">stdout_capture_maxbytes</span><span class="token attr-value"><span class="token punctuation">=</span>1MB                                          ; number of bytes in 'capturemode' (default 0)</span>
<span class="token constant">stdout_events_enabled</span><span class="token attr-value"><span class="token punctuation">=</span>false                                          ; emit events on stdout writes (default false)</span>
</code></pre></div><h5 id="_6-启动服务并检查"><a href="#_6-启动服务并检查" class="header-anchor">#</a> 6）启动服务并检查</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl update</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># supervisorctl status</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># yum install ipvsadm -y</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
<span class="token punctuation">[</span>root@node-03 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
</code></pre></div><h5 id="同理-在-node-04-上按照-4-5-步骤执行"><a href="#同理-在-node-04-上按照-4-5-步骤执行" class="header-anchor">#</a> 同理, 在 node-04 上按照 4~5 步骤执行</h5> <p>不同的地方</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/opt/kubernetes/server/bin/kube-proxy.sh
--hostname-override node-04
<span class="token comment">##########</span>
/etc/supervisord.d/kube-proxy.ini
<span class="token punctuation">[</span>program:kube-proxy-node-04<span class="token punctuation">]</span>
</code></pre></div><h3 id="_6-8-验证-kubernetes-集群"><a href="#_6-8-验证-kubernetes-集群" class="header-anchor">#</a> 6.8 验证 kubernetes 集群</h3> <h4 id="_6-8-1-在任意一个节点上创建一个资源配置清单"><a href="#_6-8-1-在任意一个节点上创建一个资源配置清单" class="header-anchor">#</a> 6.8.1 <strong>在任意一个节点上创建一个资源配置清单</strong></h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /root/nginx-ds.yaml
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: nginx-ds
spec:
  template:
    metadata:
      labels:
        app: nginx-ds
    spec:
      containers:
      - name: my-nginx
        image: harbor.thtf.com/public/nginx:v1.7.9
        ports:
        - containerPort: <span class="token number">80</span>
</code></pre></div><h4 id="_6-8-2-应用资源配置-并检查"><a href="#_6-8-2-应用资源配置-并检查" class="header-anchor">#</a> 6.8.2 <strong>应用资源配置，并检查</strong></h4> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f /root/nginx-ds.yaml
kubectl get pods
kubectl get pods -o wide
<span class="token function">curl</span> <span class="token number">172.7</span>.21.2
</code></pre></div><h2 id="第-7-章-环境搭建-kubeadm"><a href="#第-7-章-环境搭建-kubeadm" class="header-anchor">#</a> 第 7 章 环境搭建（kubeadm）</h2> <h3 id="_7-1-环境要求"><a href="#_7-1-环境要求" class="header-anchor">#</a> 7.1 环境要求</h3> <p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p> <ul><li><p>一台或多台机器，操作系统 CentOS7.x-86_x64</p></li> <li><p>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</p></li> <li><p>集群中所有机器之间网络互通</p></li> <li><p>可以访问外网，需要拉取镜像</p></li> <li><p>禁止swap分区</p></li></ul> <h3 id="_7-2-环境准备"><a href="#_7-2-环境准备" class="header-anchor">#</a> 7.2 环境准备</h3> <ul><li>关闭 SELinux 和 firewalld</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># systemctl stop firewalld               #临时关闭</span>
<span class="token comment"># systemctl disable firewalld            #永久关闭,即设置开机的时候不自动启动</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）
</code></pre></div><p>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）</p> <ul><li>关闭 swap</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># swapoff -a												# 临时关闭</span>
<span class="token comment"># vi /etc/fstab 										# 永久</span>
</code></pre></div><ul><li>添加主机名与IP对应关系（记得设置主机名）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># cat /etc/hosts</span>
<span class="token number">192.168</span>.31.61 k8s-master
<span class="token number">192.168</span>.31.62 k8s-node1
<span class="token number">192.168</span>.31.63 k8s-node2
</code></pre></div><ul><li>将桥接的IPv4流量传递到iptables的链</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
</code></pre></div><h3 id="_7-3-所有节点安装-docker-kubeadm-kubelet"><a href="#_7-3-所有节点安装-docker-kubeadm-kubelet" class="header-anchor">#</a> 7.3 所有节点安装 Docker/kubeadm/kubelet</h3> <p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p> <h4 id="_7-3-1-安装-docker"><a href="#_7-3-1-安装-docker" class="header-anchor">#</a> 7.3.1 安装 docker</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span>
<span class="token comment"># yum -y install docker-ce-18.06.1.ce-3.el7</span>
<span class="token comment"># systemctl enable docker &amp;&amp; systemctl start docker</span>
<span class="token comment"># docker --version</span>
</code></pre></div><h4 id="_7-3-2-添加阿里云-yun-软件源"><a href="#_7-3-2-添加阿里云-yun-软件源" class="header-anchor">#</a> 7.3.2 添加阿里云 YUN 软件源</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span>
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre></div><h4 id="_7-3-3-安装-kubeadm-kubelet-和-kubectl"><a href="#_7-3-3-安装-kubeadm-kubelet-和-kubectl" class="header-anchor">#</a> 7.3.3 安装 kubeadm, kubelet 和 kubectl</h4> <p>由于版本更新频繁，这里指定版本号部署：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># yum install -y kubelet-1.15.0 kubeadm-1.15.0 kubectl-1.15.0</span>
<span class="token comment"># systemctl enable kubelet</span>
</code></pre></div><h3 id="_7-4-部署-kubernetes-master"><a href="#_7-4-部署-kubernetes-master" class="header-anchor">#</a> 7.4 部署 Kubernetes Master</h3> <p>在192.168.31.61（Master）执行。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#kubeadm init \</span>
--apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.31.61 <span class="token punctuation">\</span>
--image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
--kubernetes-version v1.15.0 <span class="token punctuation">\</span>
--service-cidr<span class="token operator">=</span><span class="token number">10.1</span>.0.0/16 <span class="token punctuation">\</span>
--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
</code></pre></div><p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p> <p>使用kubectl工具：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># mkdir -p $HOME/.kube</span>
<span class="token comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="token comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl get nodes</span>
NAME     STATUS     ROLES    AGE     VERSION
master   NotReady   master   3m40s   v1.15.0
</code></pre></div><h3 id="_7-5-安装-pod-网络插件-cni"><a href="#_7-5-安装-pod-网络插件-cni" class="header-anchor">#</a> 7.5 安装 Pod 网络插件（CNI）</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span>
</code></pre></div><p>如果不能访问，就使用下面文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># vi kube-flannel.yml</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes/status
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> patch
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">cni-conf.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    {
      &quot;name&quot;: &quot;cbr0&quot;,
      &quot;plugins&quot;: [
        {
          &quot;type&quot;: &quot;flannel&quot;,
          &quot;delegate&quot;: {
            &quot;hairpinMode&quot;: true,
            &quot;isDefaultGateway&quot;: true
          }
        },
        {
          &quot;type&quot;: &quot;portmap&quot;,
          &quot;capabilities&quot;: {
            &quot;portMappings&quot;: true
          }
        }
      ]
    }</span>
  <span class="token key atrule">net-conf.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    {
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;
      }
    }</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>ds<span class="token punctuation">-</span>amd64
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
        <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">beta.kubernetes.io/arch</span><span class="token punctuation">:</span> amd64
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> flannel
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>amd64
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cp
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
        <span class="token punctuation">-</span> /etc/kube<span class="token punctuation">-</span>flannel/cni<span class="token punctuation">-</span>conf.json
        <span class="token punctuation">-</span> /etc/cni/net.d/10<span class="token punctuation">-</span>flannel.conflist
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>amd64
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /opt/bin/flanneld
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ip<span class="token punctuation">-</span>masq
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kube<span class="token punctuation">-</span>subnet<span class="token punctuation">-</span>mgr
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>ds<span class="token punctuation">-</span>arm64
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
        <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">beta.kubernetes.io/arch</span><span class="token punctuation">:</span> arm64
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> flannel
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>arm64
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cp
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
        <span class="token punctuation">-</span> /etc/kube<span class="token punctuation">-</span>flannel/cni<span class="token punctuation">-</span>conf.json
        <span class="token punctuation">-</span> /etc/cni/net.d/10<span class="token punctuation">-</span>flannel.conflist
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>arm64
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /opt/bin/flanneld
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ip<span class="token punctuation">-</span>masq
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kube<span class="token punctuation">-</span>subnet<span class="token punctuation">-</span>mgr
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>ds<span class="token punctuation">-</span>arm
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
        <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">beta.kubernetes.io/arch</span><span class="token punctuation">:</span> arm
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> flannel
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>arm
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cp
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
        <span class="token punctuation">-</span> /etc/kube<span class="token punctuation">-</span>flannel/cni<span class="token punctuation">-</span>conf.json
        <span class="token punctuation">-</span> /etc/cni/net.d/10<span class="token punctuation">-</span>flannel.conflist
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>arm
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /opt/bin/flanneld
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ip<span class="token punctuation">-</span>masq
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kube<span class="token punctuation">-</span>subnet<span class="token punctuation">-</span>mgr
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>ds<span class="token punctuation">-</span>ppc64le
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
        <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">beta.kubernetes.io/arch</span><span class="token punctuation">:</span> ppc64le
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> flannel
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>ppc64le
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cp
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
        <span class="token punctuation">-</span> /etc/kube<span class="token punctuation">-</span>flannel/cni<span class="token punctuation">-</span>conf.json
        <span class="token punctuation">-</span> /etc/cni/net.d/10<span class="token punctuation">-</span>flannel.conflist
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>ppc64le
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /opt/bin/flanneld
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ip<span class="token punctuation">-</span>masq
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kube<span class="token punctuation">-</span>subnet<span class="token punctuation">-</span>mgr
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>ds<span class="token punctuation">-</span>s390x
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
    <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> node
        <span class="token key atrule">app</span><span class="token punctuation">:</span> flannel
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">beta.kubernetes.io/arch</span><span class="token punctuation">:</span> s390x
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> flannel
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>s390x
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cp
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
        <span class="token punctuation">-</span> /etc/kube<span class="token punctuation">-</span>flannel/cni<span class="token punctuation">-</span>conf.json
        <span class="token punctuation">-</span> /etc/cni/net.d/10<span class="token punctuation">-</span>flannel.conflist
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/flannel<span class="token punctuation">:</span>v0.11.0<span class="token punctuation">-</span>s390x
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /opt/bin/flanneld
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>ip<span class="token punctuation">-</span>masq
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kube<span class="token punctuation">-</span>subnet<span class="token punctuation">-</span>mgr
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;50Mi&quot;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kube<span class="token punctuation">-</span>flannel/
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> run
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flannel<span class="token punctuation">-</span>cfg
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>flannel<span class="token punctuation">-</span>cfg
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f kube-flannel.yml</span>
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.extensions/kube-flannel-ds-amd64 created
daemonset.extensions/kube-flannel-ds-arm64 created
daemonset.extensions/kube-flannel-ds-arm created
daemonset.extensions/kube-flannel-ds-ppc64le created
daemonset.extensions/kube-flannel-ds-s390x created
</code></pre></div><p>检查是否成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-system</span>
NAME                             READY   STATUS    RESTARTS   AGE
coredns-bccdc95cf-2wbsm          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m
coredns-bccdc95cf-qth9j          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m
etcd-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16m
kube-apiserver-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16m
kube-controller-manager-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16m
kube-flannel-ds-amd64-5t8vx      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          74s
kube-proxy-drghg                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m
kube-scheduler-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16m
</code></pre></div><h3 id="_7-6-加入-kubernetes-node"><a href="#_7-6-加入-kubernetes-node" class="header-anchor">#</a> 7.6 加入 Kubernetes Node</h3> <p>在192.168.31.62/63（所有Node节点）执行。</p> <p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#kubeadm join 192.168.31:6443 --token g19l60.r4ai7kxwmtqthjh7 \</span>
    --discovery-token-ca-cert-hash sha256:3aed74d544f0b37428949a0f0c99f534bb9633e38f971a7af8b3bb9805f838f8 
</code></pre></div><h3 id="_7-7-测试kubernetes集群"><a href="#_7-7-测试kubernetes集群" class="header-anchor">#</a> 7.7 测试kubernetes集群</h3> <p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl get nodes</span>
NAME      STATUS   ROLES    AGE     VERSION
master    Ready    master   27m     v1.15.0
node-01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m27s   v1.15.0
node-02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m21s   v1.15.0
<span class="token comment"># kubectl get pods -n kube-system</span>
NAME                             READY   STATUS    RESTARTS   AGE
coredns-bccdc95cf-2wbsm          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
coredns-bccdc95cf-qth9j          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
etcd-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26m
kube-apiserver-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26m
kube-controller-manager-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26m
kube-flannel-ds-amd64-4f25j      <span class="token number">1</span>/1     Running   <span class="token number">1</span>          4m17s
kube-flannel-ds-amd64-5t8vx      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
kube-flannel-ds-amd64-826hw      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m23s
kube-proxy-8n76h                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m17s
kube-proxy-9xcrv                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m23s
kube-proxy-drghg                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
kube-scheduler-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26m

</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl create deployment nginx --image=nginx</span>
<span class="token comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span>
<span class="token comment"># kubectl get pod,svc</span>
</code></pre></div><p>访问地址：http://NodeIP:Port</p> <h3 id="_7-8-部署-dashboard"><a href="#_7-8-部署-dashboard" class="header-anchor">#</a> 7.8 部署 Dashboard</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span>
</code></pre></div><p>不能访问</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># vi kubernetes-dashboard.yaml</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># Copyright 2017 The Kubernetes Authors.</span>
<span class="token comment">#</span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>

<span class="token comment"># ------------------- Dashboard Secret ------------------- #</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque

<span class="token punctuation">---</span>
<span class="token comment"># ------------------- Dashboard Service Account ------------------- #</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>minimal
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># Allow Dashboard to create 'kubernetes-dashboard-key-holder' secret.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># Allow Dashboard to create 'kubernetes-dashboard-settings' config map.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;secrets&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;kubernetes-dashboard-key-holder&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;kubernetes-dashboard-certs&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;kubernetes-dashboard-settings&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">]</span>
  <span class="token comment"># Allow Dashboard to get metrics from heapster.</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;services&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;heapster&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;services/proxy&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;heapster&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http:heapster:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https:heapster:&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>minimal
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>minimal
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment"># ------------------- Dashboard Deployment ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
        <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.10.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>auto<span class="token punctuation">-</span>generate<span class="token punctuation">-</span>certificates
          <span class="token comment"># Uncomment the following line to manually specify Kubernetes API server Host</span>
          <span class="token comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span>
          <span class="token comment"># to it. Uncomment only if the default does not work.</span>
          <span class="token comment"># - --apiserver-host=http://my-address:port</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /certs
          <span class="token comment"># Create on-disk volume to store exec logs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
        <span class="token key atrule">secret</span><span class="token punctuation">:</span>
          <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
      <span class="token comment"># Comment the following tolerations if Dashboard must not be deployed on master</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule

<span class="token punctuation">---</span>
<span class="token comment"># ------------------- Dashboard Service ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
</code></pre></div><p>默认镜像国内无法访问，修改镜像地址为： lizhenliang/kubernetes-dashboard-amd64:v1.10.1</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
        <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.10.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
</code></pre></div><p>默认Dashboard只能集群内部访问，修改Service为NodePort类型，暴露到外部：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># ------------------- Dashboard Service ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">30001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>

</code></pre></div><p>重新apply</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f kubernetes-dashboard.yaml</span>
secret/kubernetes-dashboard-certs created
serviceaccount/kubernetes-dashboard created
role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
deployment.apps/kubernetes-dashboard created
service/kubernetes-dashboard created

</code></pre></div><p>检查</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-system</span>
NAME                                    READY   STATUS             RESTARTS   AGE
coredns-bccdc95cf-2wbsm                 <span class="token number">1</span>/1     Running            <span class="token number">0</span>          39m
coredns-bccdc95cf-qth9j                 <span class="token number">1</span>/1     Running            <span class="token number">0</span>          39m
etcd-master                             <span class="token number">1</span>/1     Running            <span class="token number">0</span>          38m
kube-apiserver-master                   <span class="token number">1</span>/1     Running            <span class="token number">0</span>          38m
kube-controller-manager-master          <span class="token number">1</span>/1     Running            <span class="token number">0</span>          38m
kube-flannel-ds-amd64-4f25j             <span class="token number">1</span>/1     Running            <span class="token number">1</span>          16m
kube-flannel-ds-amd64-5t8vx             <span class="token number">1</span>/1     Running            <span class="token number">0</span>          23m
kube-flannel-ds-amd64-826hw             <span class="token number">1</span>/1     Running            <span class="token number">0</span>          16m
kube-proxy-8n76h                        <span class="token number">1</span>/1     Running            <span class="token number">0</span>          16m
kube-proxy-9xcrv                        <span class="token number">1</span>/1     Running            <span class="token number">0</span>          16m
kube-proxy-drghg                        <span class="token number">1</span>/1     Running            <span class="token number">0</span>          39m
kube-scheduler-master                   <span class="token number">1</span>/1     Running            <span class="token number">0</span>          38m
kubernetes-dashboard-7d75c474bb-h24l9   <span class="token number">0</span>/1     ImagePullBackOff   <span class="token number">0</span>          5m4s

</code></pre></div><p>访问地址：http://NodeIP:30001</p> <p>创建service account并绑定默认cluster-admin管理员集群角色：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount dashboard-admin -n kube-system</span>
serviceaccount/dashboard-admin created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span>
clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')</span>
Name:         dashboard-admin-token-2xfsf
Namespace:    kube-system
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: c8e442b3-6076-4757-aff9-c6965cd719ab

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1025</span> bytes
namespace:  <span class="token number">11</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tMnhmc2YiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzhlNDQyYjMtNjA3Ni00NzU3LWFmZjktYzY5NjVjZDcxOWFiIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.pCpWvb3h5lSB7wOEScQuVo3UbjadGbOim3ues5nEruGb2TFzfHAWX3fb5x7kU8pzpFzRXUG55SCmHstWxdHmG17L54OCByklyHRv-VIaqr-ZgEneHEaqJMLjsPLkWMqRYqmhPT4XE4pwr6pkcm7-bKLHOHjOCenIF-0cXiaE04-3Am6swqMN63h8iOpCz-77k9KxNzcn0hehv-OwsCexNF-CzzSBao4ZWRYNqVzi0IXDoL9XdgcMx63RcW896jqj4qxN5Rja5X8P9DNP9qXutSuVPZLQWU_AQJdlbMMFaGj82WV2Bh0X3__zqTjI6uI5fPQm6iFRK06tfEgCkFKHQg

</code></pre></div><p>选择 token 登录输入上面生成 token</p> <p><img src="/study/assets/img/k8s_dashboard.c11755ed.png" alt=""></p> <h2 id="第-8-章-k8s-的核心资源管理方法"><a href="#第-8-章-k8s-的核心资源管理方法" class="header-anchor">#</a> 第 8 章 K8S 的核心资源管理方法</h2> <p>管理 K8S 核心资源的三种基本方法：</p> <ul><li><p>陈述式管理方法 - 主要依赖命令行 CLI 工具进行管理</p></li> <li><p>声明式管理方法 - 主要依赖统一资源配置清单（mainifest）进行管理</p></li> <li><p>GUI 式管理方法 - 主要依赖图形化操作界面（web 页面）进行管理</p></li></ul> <h3 id="_8-1-陈述式资源管理方法"><a href="#_8-1-陈述式资源管理方法" class="header-anchor">#</a> 8.1 陈述式资源管理方法</h3> <h4 id="_8-1-1-管理名称空间资源"><a href="#_8-1-1-管理名称空间资源" class="header-anchor">#</a> 8.1.1 管理名称空间资源</h4> <h5 id="查看名称空间"><a href="#查看名称空间" class="header-anchor">#</a> 查看名称空间</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get namespaces</span>
NAME              STATUS   AGE
default           Active   24h
kube-node-lease   Active   24h
kube-public       Active   24h
kube-system       Active   24h
</code></pre></div><h5 id="查看名称空间内的资源"><a href="#查看名称空间内的资源" class="header-anchor">#</a> 查看名称空间内的资源</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all -n default</span>
</code></pre></div><h5 id="创建名称空间"><a href="#创建名称空间" class="header-anchor">#</a> 创建名称空间</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create namespace app</span>
</code></pre></div><h5 id="删除名称空间"><a href="#删除名称空间" class="header-anchor">#</a> 删除名称空间</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete namespace app</span>
</code></pre></div><h4 id="_8-1-2-管理-deployment-资源"><a href="#_8-1-2-管理-deployment-资源" class="header-anchor">#</a> 8.1.2 管理 Deployment 资源</h4> <h5 id="创建-deployment"><a href="#创建-deployment" class="header-anchor">#</a> 创建 deployment</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment nginx-dp --image=docker.io/panyangyang/nginx:v1.12.2 -n kube-public</span>
</code></pre></div><h5 id="查看-deployment"><a href="#查看-deployment" class="header-anchor">#</a> 查看 deployment</h5> <ul><li><p>简单查看</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n kube-public</span>
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
nginx-dp   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           9m19s
</code></pre></div></li> <li><p>扩展查看</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -o wide -n kube-public</span>
NAME       READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                SELECTOR
nginx-dp   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           11m   nginx        docker.io/panyangyang/nginx:v1.12.2   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
</code></pre></div></li> <li><p>详细查看</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe deployment nginx-dp -n kube-public</span>
Name:                   nginx-dp
Namespace:              kube-public
CreationTimestamp:      Sun, <span class="token number">19</span> Apr <span class="token number">2020</span> <span class="token number">12</span>:53:10 +0800
Labels:                 <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
Annotations:            deployment.kubernetes.io/revision: <span class="token number">1</span>
Selector:               <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
Replicas:               <span class="token number">1</span> desired <span class="token operator">|</span> <span class="token number">1</span> updated <span class="token operator">|</span> <span class="token number">1</span> total <span class="token operator">|</span> <span class="token number">1</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
  Containers:
   nginx:
    Image:        docker.io/panyangyang/nginx:v1.12.2
    Port:         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Host Port:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
NewReplicaSet:   nginx-dp-58774b9c55 <span class="token punctuation">(</span><span class="token number">1</span>/1 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  12m   deployment-controller  Scaled up replica <span class="token builtin class-name">set</span> nginx-dp-58774b9c55 to 
</code></pre></div></li></ul> <h5 id="查看-pod-资源"><a href="#查看-pod-资源" class="header-anchor">#</a> 查看 pod 资源</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-public</span>
NAME                        READY   STATUS    RESTARTS   AGE
nginx-dp-58774b9c55-cx76j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
</code></pre></div><h5 id="进入-pod-资源"><a href="#进入-pod-资源" class="header-anchor">#</a> 进入 pod 资源</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it nginx-dp-58774b9c55-cx76j bash -n kube-public</span>
root@nginx-dp-58774b9c55-cx76j:/<span class="token comment"># ls</span>
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@nginx-dp-58774b9c55-cx76j:/<span class="token comment"># </span>
</code></pre></div><p>当然也可以用 docker exec 进入容器</p> <h5 id="删除-pod-资源-重启"><a href="#删除-pod-资源-重启" class="header-anchor">#</a> 删除 pod 资源（重启）</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod nginx-dp-58774b9c55-cx76j -n kube-public</span>
pod <span class="token string">&quot;nginx-dp-58774b9c55-cx76j&quot;</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-public</span>
NAME                        READY   STATUS    RESTARTS   AGE
nginx-dp-58774b9c55-7974f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s
</code></pre></div><blockquote><p>强制删除参数：--force --grace-period=0</p></blockquote> <h5 id="删除-deployment"><a href="#删除-deployment" class="header-anchor">#</a> 删除 deployment</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deployment nginx-dp -n kube-public</span>
deployment.extensions <span class="token string">&quot;nginx-dp&quot;</span> deleted
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment -n kube-public</span>
No resources found.
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-public</span>
No resources found.
</code></pre></div><h4 id="_8-1-3-管理-service-资源"><a href="#_8-1-3-管理-service-资源" class="header-anchor">#</a> 8.1.3 管理 Service 资源</h4> <h5 id="创建service"><a href="#创建service" class="header-anchor">#</a> 创建service</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment nginx-dp --image=docker.io/panyangyang/nginx:v1.12.2 -n kube-public</span>
deployment.apps/nginx-dp created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-554b9c67f9-pjd5p   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24h
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment nginx-dp --port=80 -n kube-public</span>
service/nginx-dp exposed
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all -n kube-public</span>
NAME                            READY   STATUS    RESTARTS   AGE
pod/nginx-dp-58774b9c55-lgv6r   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          108s


NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/nginx-dp   ClusterIP   <span class="token number">10.1</span>.133.189   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    17s


NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx-dp   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           108s

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-dp-58774b9c55   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       108s
</code></pre></div><h5 id="查看-service"><a href="#查看-service" class="header-anchor">#</a> 查看 service</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc nginx-dp -n kube-public</span>
Name:              nginx-dp
Namespace:         kube-public
Labels:            <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-dp
Type:              ClusterIP
IP:                <span class="token number">10.1</span>.133.189
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.2.5:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_8-1-4-总结"><a href="#_8-1-4-总结" class="header-anchor">#</a> 8.1.4 总结</h4> <p><img src="/study/assets/img/k8s_cs.4c3eef1f.png" alt=""></p> <h3 id="_8-2-声明式资源管理方法"><a href="#_8-2-声明式资源管理方法" class="header-anchor">#</a> 8.2 声明式资源管理方法</h3> <p>声明式资源管理方法依赖于 - 资源配置清单（yaml/json)</p> <h4 id="_8-2-1-查看资源配置清单的方法"><a href="#_8-2-1-查看资源配置清单的方法" class="header-anchor">#</a> 8.2.1 查看资源配置清单的方法</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc nginx-dp -o yaml -n kube-public</span>
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="token string">&quot;2020-04-19T05:31:44Z&quot;</span>
  labels:
    app: nginx-dp
  name: nginx-dp
  namespace: kube-public
  resourceVersion: <span class="token string">&quot;131556&quot;</span>
  selfLink: /api/v1/namespaces/kube-public/services/nginx-dp
  uid: 9ec83521-f04a-4cb5-9a0e-22915f9fe046
spec:
  clusterIP: <span class="token number">10.1</span>.133.189
  ports:
  - port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
  selector:
    app: nginx-dp
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="_8-2-2-解释资源配置清单"><a href="#_8-2-2-解释资源配置清单" class="header-anchor">#</a> 8.2.2 解释资源配置清单</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain service.metadata</span>
</code></pre></div><h4 id="_8-2-3-创建资源配置清单"><a href="#_8-2-3-创建资源配置清单" class="header-anchor">#</a> 8.2.3 创建资源配置清单</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ds
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ds
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>public
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ds
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre></div><h4 id="_8-2-4-应用资源配置清单"><a href="#_8-2-4-应用资源配置清单" class="header-anchor">#</a> 8.2.4 应用资源配置清单</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f nginx-ds-svc.yaml </span>
service/nginx-ds created
</code></pre></div><h4 id="_8-2-5-修改资源配置清单并应用"><a href="#_8-2-5-修改资源配置清单并应用" class="header-anchor">#</a> 8.2.5 修改资源配置清单并应用</h4> <ul><li><p>离线修改</p> <blockquote><p>修改 nginx-ds-svc.yaml 文件，并用 kubectl apply -f nginx-ds-svc.yaml 使之生效。</p></blockquote></li> <li><p>在线修改</p> <blockquote><p>直接使用 kubectl edit service nginx-ds 在线编辑资源配置清单并保持生效。</p></blockquote></li></ul> <h4 id="_8-2-6-删除资源配置清单"><a href="#_8-2-6-删除资源配置清单" class="header-anchor">#</a> 8.2.6 删除资源配置清单</h4> <ul><li><p>陈述式删除</p> <blockquote><p>kubectl delete service nginx-ds -n tube-public</p></blockquote></li> <li><p>声明式删除</p> <blockquote><p>kubectl delete -f nginx-df-svc.yaml</p></blockquote></li></ul> <h4 id="_8-2-7-查看并使用-service-资源"><a href="#_8-2-7-查看并使用-service-资源" class="header-anchor">#</a> 8.2.7 查看并使用 service 资源</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -o wide</span>
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE     SELECTOR
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        27h     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx        NodePort    <span class="token number">10.1</span>.189.125   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:31068/TCP   26h     <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
nginx-ds     ClusterIP   <span class="token number">10.1</span>.39.17     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP         4m32s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-ds
</code></pre></div><h4 id="_8-2-8-总结"><a href="#_8-2-8-总结" class="header-anchor">#</a> 8.2.8 总结</h4> <p><img src="/study/assets/img/k8s_cs.4c3eef1f.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/devops/kubernetes-1.html" class="prev">
        Kubernetes-1
      </a></span> <span class="next"><a href="/study/devops/nginx.html">
        Nginx
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study/assets/js/app.fc789024.js" defer></script><script src="/study/assets/js/2.45ac72bb.js" defer></script><script src="/study/assets/js/11.8110839e.js" defer></script>
  </body>
</html>
