<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes | PYY在线笔记文档</title>
    <meta name="description" content="PYY在线笔记文档">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/study/img/logo.png">
    
    <link rel="preload" href="/study/assets/css/0.styles.adf990bf.css" as="style"><link rel="preload" href="/study/assets/js/app.805d6976.js" as="script"><link rel="preload" href="/study/assets/js/2.d79867de.js" as="script"><link rel="preload" href="/study/assets/js/6.40dc09d8.js" as="script"><link rel="prefetch" href="/study/assets/js/10.8f6cc0bc.js"><link rel="prefetch" href="/study/assets/js/11.80afb327.js"><link rel="prefetch" href="/study/assets/js/12.202c1bb3.js"><link rel="prefetch" href="/study/assets/js/13.c0659ce7.js"><link rel="prefetch" href="/study/assets/js/14.2e675df6.js"><link rel="prefetch" href="/study/assets/js/15.478fef0f.js"><link rel="prefetch" href="/study/assets/js/16.e3882713.js"><link rel="prefetch" href="/study/assets/js/17.15b2bc97.js"><link rel="prefetch" href="/study/assets/js/18.e3f7e58b.js"><link rel="prefetch" href="/study/assets/js/19.7df53965.js"><link rel="prefetch" href="/study/assets/js/20.095604ea.js"><link rel="prefetch" href="/study/assets/js/21.025c2b93.js"><link rel="prefetch" href="/study/assets/js/3.373a8979.js"><link rel="prefetch" href="/study/assets/js/4.66dbe83c.js"><link rel="prefetch" href="/study/assets/js/5.f2f75567.js"><link rel="prefetch" href="/study/assets/js/7.f16429f3.js"><link rel="prefetch" href="/study/assets/js/8.ace670df.js"><link rel="prefetch" href="/study/assets/js/9.7fd67b26.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.adf990bf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记文档" class="logo"> <span class="site-name can-hide">PYY在线笔记文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link router-link-active">
  DevOps
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/pyy-admin-x" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link router-link-active">
  DevOps
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/pyy-admin-x" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dev Ops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/DevOps/" class="sidebar-link">介绍</a></li><li><a href="/study/DevOps/Docker.html" class="sidebar-link">Docker</a></li><li><a href="/study/DevOps/Jenkins与Docker的自动化CICD实战.html" class="sidebar-link">/DevOps/Jenkins与Docker的自动化CICD实战.html</a></li><li><a href="/study/DevOps/Kubernetes.html" class="active sidebar-link">Kubernetes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-1-章-kubernetes-概述" class="sidebar-link">第 1 章 Kubernetes 概述</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-2-章-kubernetes-优势" class="sidebar-link">第 2 章 Kubernetes 优势</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-3-章-kubernetes-快速入门" class="sidebar-link">第 3 章 Kubernetes 快速入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_3-1-四组基本概念" class="sidebar-link">3.1 四组基本概念</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-4-章-kubernetes-核心功能" class="sidebar-link">第 4 章 Kubernetes 核心功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_4-1-调度" class="sidebar-link">4.1 调度</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_4-2-自动修复" class="sidebar-link">4.2 自动修复</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_4-3-水平伸缩" class="sidebar-link">4.3 水平伸缩</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-5-章-kubernetes-的架构" class="sidebar-link">第 5 章 Kubernetes 的架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_5-1-master" class="sidebar-link">5.1 Master</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_5-2-node" class="sidebar-link">5.2 Node</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#第-6-章-环境搭建" class="sidebar-link">第 6 章 环境搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_6-1-准备环境" class="sidebar-link">6.1 准备环境</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_6-2-dns-服务初始化" class="sidebar-link">6.2 DNS 服务初始化</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_6-3-准备签发证书环境" class="sidebar-link">6.3 准备签发证书环境</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_6-4-部署-docker" class="sidebar-link">6.4 部署 docker</a></li><li class="sidebar-sub-header"><a href="/study/DevOps/Kubernetes.html#_6-5-部署私有仓库-harbor" class="sidebar-link">6.5 部署私有仓库 harbor</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes"><a href="#kubernetes" class="header-anchor">#</a> Kubernetes</h1> <h2 id="第-1-章-kubernetes-概述"><a href="#第-1-章-kubernetes-概述" class="header-anchor">#</a> 第 1 章 Kubernetes 概述</h2> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAACrCAMAAAD8Q8FaAAAAz1BMVEX///87XukAAAD8/Pw1W+7w8PA5XOl6kvH4+Pj19fWMjIw2WumVlZXn5+fh4eFqamqhoaHCwsJHR0fv8v1ycnLb29vV1dXLy8s/Pz/6+//19/4vVeggICAVFRXU3Prd4/uqufXq7v26xvckTucvLy9QUFBhYWGkpKSxsbGFhYXFz/iUpfJWde8rU+ixv/bc4vskJCRYWFiBlvFObethfO1shu50jPGbq/NCZOqHnfHO1/mjs/QuLi4XFxe7u7twcHDAzPgZSOdFaOpngO1cevCV9SEKAAAKtUlEQVR4nO2cbXeqvBKGeTOoEbfVqgWsgra1KqgV32273db//5tOJoAi6nOec9baWstcH6pgsMm9JjOTSVpBQBAEQRAEQRAEQRAEQRAEQRAEQRAEQRAEQRAEQf4d9nJdL127E98de/W1mXujtX7tjnxnSjNHpIQQOp92r92X74re6M0VQkSAUGXcxKl3jDFYeKavkQ+l46Z97V59M/Rlz1GiInGhxInVuHbPvhPLkUfiIvGpJ25XaFE++lKd0xMicaEIdVAoRmk9UZRDEzrQjBBz3mskPD+wm6qoxAxoMvMObYsozmyZYKFK/ek8JpJInYa+ijsqQr3FUr52d6+D0R+zYBbHnBpCd37kqljGOapfu8dXwLY881gkJtO4JDRPhj1FmSRu6g3GR2lSMOm8hmCZJz8SFTIzrt3xi2JP4j5pZzRiXZi5Zz+0EuWh+vMzQrCVL5OpdSaNEukkSUmU3DvllvyUaWQIS4et6E75J5HMl9fu+wWxp4FMJCIGpZtJr7m0oVawttStuE8zye6t0r923y9IPUggCXG8UDDT63XtfSQzGv1pGAqJuN0EOimLBDnxMDGi0/rgi/traqr1eLQvWX5phVLLbm4Ck9smpwqlr2hgTBYT44uFf8VrBiIZzFpkI7iwR2y2URNajYNHNskprZRC10S/mEe2VWJOeIatN/qq1wd1tr0ltxrdEunGYuKtwsScNK/a9UtiO6FHpo5ls4S8x01kMHNcU2EylFTXFad+kdfqdaEeJe58+OK6fb8gy0gixNwTMxq4azkUjGzNZBpR5tJFFXIkWWcmtdkHPTq+bt8vyCq6GDH9jNHoKaAFT4yMBeWxb+snSX0SybKImJh13TS6UiEi9zalBbclugHj6vkyOWv4xD5oLrrra3b9gujOwQ5KuP7ob9lqmHgDNtFmFDYMRkFQ60dVEpXZ9Xp+URqHRV3Iq/lEqqtsheIwmQSWMJieFWZIxiQ6SZXR1Tp+WZrRAgB1SuCMeEJQWoktB0zIct0vXq3UVzAj162orNuErH4XUWtyV+xO84/je+vlxALDaoz8wpIxM7mKm6gPT8jqV99GywOUTTJ9YpqbE2mjvVAIhfuLyKwjonXhDl+HQXTjhDrMeuosxaZiMx7pbZUt6Sikk83onhRZJCIlWEdLcqbK7vR5KjC3DoffmMLCl4yZsxqIUWWTUZqbRcfs9tgdv0hHRV5Lsq1ZF7x3SeXlAeLBss+JOicnCVsshhp1Ta4V3IHKJRS6S6NWiyec9pRCMZPM2ZquNDnIw5NQmmuMo8lliw3ZmJrU3Hz11pAoLZmfMlV4N+irW9E0+SJvepA5zRLgnLqbY5nE6SqsXNY9ymai/77UWM+28+aRTKMElOb6B1sBrRkcSRkYu32l0sJtzfcnCnW7bgelu70PT0CCafTC5JJ5I0U5kS7VV0flbmNBFIXu/BP5+QmmHXpj4k3UxWw3YL1kN5aRAq6xrDfsnZEZzdlC/QozCbq6cKcvz25TZbu2d1bT6DIZJtuNs3c6fXEzni5WzWV4SzbsMJVQ1B/vw9c09MMw1LrVBz/T41OQUnMvk+USnhBswE91V30wtHpQECfOj/fhMzOcc03bGs9pCxYjS5eP31zAJDNs+Nnw/NLcmJlcSTTpRu02FqH3Jz9+eyWUiSlguizP9neURnCX8rU/y6IgfTSCCiYYU78FG3muuwt3P1+m9T6fDrY0oRrZgKoB5Vlln1kQqAD5FTGhBhfu0e0zgp8/6Y6O7NAx1Cubc8o3NyESErLS/c0884sX6Y7OGP78SBfLwkEnfizAIibUd2WL8POXAlR6Xb7IHWxjxqSoP96YBDCcmG0oFtzuzqFY0OC1ABfmmu1MIQraauzsXEIKKcIsPu1gdcvCfQMOPnFNCAUzWoMczJUfWh9NRB1FgFgW12kTLuIG1DUhf/ozDRJIfRZTiSjra/X70jTGcZ28vr8ssWeTrec5YzWo+JbitiQqvWv2/LLUnZhXJmQROhzdKO0WMcuvmF8iyihBx8CEZjzckT8nNnNL2/iRXpIQ9x2gr+JHv2G/brDcR3q7azOZjvLKhLjvED3mxum8LnS3ntqzmt1lt79aTOaqLcf8N0nQGbAAe3twLMWc6cYXC3KKLwy8MvtqHCxTiJsg9x1y4MYpyyS7/p9nEBKcgqZeLGWnydjHjBF147AvsIj5a2LWBX201zIp2XeMSOYIe5aGF/PXosuCX2/n6qnz8yvgJ9Ej20qj9eLoz56IZ/V3J8YS6L5DjH3AN1sn/jiMuO5OJSUBxZNzHGXjZ0nMGbmTHGXjZ6CTH1/W/Sf02b+SKbHuO8QYnfszzQhknlj3HXK0H3ACv7yZbOrOf7En4u98Jp2uYyr/gKmMEpl9H2Fb6j+wWCapEIcgyN8lVcm9pk9+ki63c6kL9+a7kvolSb8ypz6Rc5L0oF26P98UkOn+r8iUKn9+nvziW+TvyVR4kor5///x78XfkykrSc8/TiY5nc6khXQ6DXvf/AVkKmopbe/F0+VKfuftM1rwiZzStL3O6Xwl71+BTGX2tX7ryKOsSUU7HTW+LYFMWnFYe0rl32rDgiDkP4ZPVS7T48OH9PFS5ccGMrmaJElPBRBByxXZxWOxKheK74+SVAvapNvvrM07D5BMJmk4rL2koTk8+sAjarrwIcFF9YqD/t/hMqW1NzbotlB5kKSOIJTZMO64TD5Pd9DwPrjKssEW/LfvZe0huFuDNulscAX2Gbx/zgiZt/BR1iYXaX87cJny91wlofzAhxKR6fEd7KCYEWRQ5i1bZD+rvkzDp49iJl+ENkNow8zpFWTJPrOfr1ymx/en919prsxLFgStCBr79KmTe365LbcFMr2AoeTkEzI93aW0X1yZ/DPYiJxiLX5zmR6qKa0sgEzZVArMJSWATd6nhNQLE8v3TZVUKiWUn6CNUC6CqcKvaDN/lrqt/6kGMgEFuDiSqcgiXaYGw7t7lIZVNug2sxFfpjI8ATLlBKHKLeWuJn20WZs71kbeR7o2lzuVYt/3JoM11Tr5G/PgoUxPPGodyQQJQfoNjKMNMxBgr75MFXiCyyQLGre4z0ib/F6mXHBb4t/n+6b7ym1aUwd0OitTMXTanHMyvUbaxGQKeEgJmcJwFxZuB5Dp7SXimzpxmTJsWPdgKbV29Y5z1poepcds0CYy6VjjYfAopA1yvg3e/P6mVtV+pHvzgxO8vmSE/IFvgsD+KVSYH+5AyiTDj9MyQT7BRy+D64EIwLIvGVyWlN09Cvkrn8c3tarmMskVNpJaWZBBkrfc/U6mWif3K5grcPOhk+u8gHSnZZI7Eo/2nRewwlfmjIrZzr2WBmMt8tss03z5XXh9ZXq+3Zw1/c74qQ2LWO+hF4mml8NP1rBSDC8r52Ti1ujDLjT/gY9PoTwMbzPTCn9D4aZ8eLBYyTz40nwGIxpWBLkdDOj5jo+o/Nu/fKxEE4KHqEyCFqbq4KBhnvqTuRLECUkTPmv+l2RvypgEuVyt5pkM+Sp7Zdfaa6FQeK1q4EHyd+yiXQ0HlK7A5R201qrVStq/V61CNGRP8wVvugxtPvNcWO0THof7Gf9RDRz4J/yC/E3ZEoIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIJ8M/4DSbz7+ra1Go8AAAAASUVORK5CYII=" alt=""></p> <ul><li><p>官网：https://kubernetes.io</p></li> <li><p>Github：https://github.com/kubernetes/kubernetes</p></li> <li><p>由来：谷歌的Borg系统, 后经Go语言重写并捐献给CNCF基金会开源</p></li> <li><p>含义：词根源于希腊语：舵手/飞行员，K8S -》K 8个字母 S</p></li> <li><p>重要作用：开源的容器编排框架工具（生态极其丰富）</p></li> <li><p>学习意义：解决跑裸docker 的若干痛点</p> <blockquote><p>使用Docker容器话封装应用程序的缺点：</p> <ul><li>单击使用, 无法有效集群</li> <li>随着容器数量的上升, 管理成本攀升</li> <li>没有有效的容灾/自愈机制</li> <li>没有预设编排模板, 无法实现快速、大规模容器调度</li> <li>没有统一的配置管理中心工具</li> <li>没有容器生命周期管理工具</li> <li>没有图形化运维管理工具</li> <li>...</li></ul></blockquote></li></ul> <h2 id="第-2-章-kubernetes-优势"><a href="#第-2-章-kubernetes-优势" class="header-anchor">#</a> 第 2 章 Kubernetes 优势</h2> <ul><li>自动装箱, 水平扩展, 自我修复</li> <li>服务发现和负载均衡</li> <li>自动发布（默认滚动发布模式）和回滚</li> <li>集中化配置管理和秘钥管理</li> <li>存储编排</li> <li>任务批处理运行</li> <li>...</li></ul> <h2 id="第-3-章-kubernetes-快速入门"><a href="#第-3-章-kubernetes-快速入门" class="header-anchor">#</a> 第 3 章 Kubernetes 快速入门</h2> <h3 id="_3-1-四组基本概念"><a href="#_3-1-四组基本概念" class="header-anchor">#</a> 3.1 四组基本概念</h3> <ul><li><p>Pod/Pod控制器</p></li> <li><p>Name/Namespace</p></li> <li><p>Label/Label选择器</p></li> <li><p>Service/Ingress</p></li></ul> <h4 id="_3-1-1-pod-pod控制器"><a href="#_3-1-1-pod-pod控制器" class="header-anchor">#</a> 3.1.1 Pod/Pod控制器</h4> <ul><li><p><strong>Pod</strong></p> <ul><li><p>Pod是K8S里能够被运行的最小的逻辑单元（原子单元）；</p></li> <li><p>1个Pod里面可以运行多个容器, 它们共享UTS+NET+IPC名字空间；</p></li> <li><p>可以把Pod理解成豌豆荚, 而同一个Pod内的每个容器是一颗颗豌豆；</p></li> <li><p>一个Pod里运行多个容器, 又叫：边车（SideCar）模式。</p></li></ul></li> <li><p><strong>Pod控制器</strong></p> <ul><li><p>Pod控制器是Pod启动的一种模板, 用来保证在 K8S 里启动的 Pod 应始终按照人们的预期运行 (副本数、生命周期、健康状态检查...)。</p></li> <li><p>K8S 内提供了众多的 Pod 控制器，常用的有以下几种：</p> <ul><li>Deployment</li> <li>DaemonSet</li> <li>ReplicaSet</li> <li>StatefulSet</li> <li>Job</li> <li>Cronjob</li></ul></li></ul></li></ul> <h4 id="_3-1-2-name-namespace"><a href="#_3-1-2-name-namespace" class="header-anchor">#</a> 3.1.2 Name/Namespace</h4> <ul><li><strong>Name</strong> <ul><li>由于 K8S 内部, 使用“资源”来定义每一种逻辑概念（功能）故每种“资源”, 都应该有自己的“名称”。</li> <li>“资源”有 api 版本（apiVersion）类别（kind）、元数据（metadata）、定义清单（spec）、状态（status）等配置信息。</li> <li>“名称”通常定义在“资源”的“元数据“信息里。</li></ul></li> <li><strong>Namespace</strong> <ul><li>随着项目增多、人员增加、集群规模的扩大, 需要一种能够隔离 K8S 内各种“资源”的方法, 这就是名称空间。</li> <li>名称空间可以理解为 K8S 内部的虚拟集群组。</li> <li>不同名称空间内的“资源”, 名称可以相同, 相同名称空间内的同种“资源”, “名称” 不能相同。</li> <li>合理的使用 K8S 的名称空间使得集群管理员能够更好的对交付到 K8S 里的服务器进行分类管理和浏览。</li> <li>K8S里默认存在的名称空间有：default、kube-system、kube-public。</li> <li>查询 K8S 里特定“资源”要带上相应的名称空间。</li></ul></li></ul> <h4 id="_3-1-3-label-label选择器"><a href="#_3-1-3-label-label选择器" class="header-anchor">#</a> 3.1.3 Label/Label选择器</h4> <ul><li><strong>Label</strong> <ul><li>标签是 K8S 特色的管理方式, 便于分类管理资源对象。</li> <li>一个标签可以对应多个资源, 一个资源也可以有多个标签, 它们是多对多的关系。</li> <li>一个资源拥有多个标签, 可以实现不同维度的管理。</li> <li>标签的组成: key=value。</li> <li>与标签类似的还有一种“注释”（annotations）。</li></ul></li> <li><strong>Label 选择器</strong> <ul><li>给资源打上标签后, 可以使用标签选择器过滤指定的标签。</li> <li>标签选择器目前有两个：基于等值关系（等于、不等于）和基于集合关系（属于、不属于、存在）。</li> <li>许多资源支持内嵌标签选择器字段
<ul><li>matchLabels</li> <li>matchExpressions</li></ul></li></ul></li></ul> <h4 id="_3-1-4-service-ingress"><a href="#_3-1-4-service-ingress" class="header-anchor">#</a> 3.1.4 Service/Ingress</h4> <ul><li><strong>Service</strong> <ul><li>在 K8S 的世界里, 虽然没个 Pod 都会被分配一个单独的 IP 地址, 但这个 IP 地址会随着 Pod 的销毁而消失。</li> <li>Service（服务）就是用来解决这个问题的核心概念。</li> <li>一个 Service 可以看作一组提供相同服务的 Pod 的对外访问接口。</li> <li>Service 作用于哪些 Pod 是通过标签选择器来定义的。</li></ul></li> <li><strong>Ingress</strong> <ul><li>Ingress 是 K8S 集群里工作在 OSI 网络参考模型下, 第 7 层的应用, 对外暴露的接口。</li> <li>Service 只能进行 L4 浏览调度, 表现形式是 ip+port。</li> <li>Ingress 则可以调度不同的业务域、不同 URL 访问路径的业务流量。</li></ul></li></ul> <h2 id="第-4-章-kubernetes-核心功能"><a href="#第-4-章-kubernetes-核心功能" class="header-anchor">#</a> 第 4 章 Kubernetes 核心功能</h2> <h3 id="_4-1-调度"><a href="#_4-1-调度" class="header-anchor">#</a> 4.1 调度</h3> <p>Kubernetes 可以把用户提交的容器放到 Kubernetes 管理的集群的某一台节点上去。Kubernetes 的调度器是执行这项能力的组件，它会观察正在被调度的这个容器的大小、规格。</p> <p>比如说它所需要的 CPU 以及它所需要的 memory，然后在集群中找一台相对比较空闲的机器来进行一次 placement，也就是一次放置的操作。在这个例子中，它可能会把红颜色的这个容器放置到第二个空闲的机器上，来完成一次调度的工作。</p> <p><img src="/study/assets/img/k8s_scheduler.45cf5f02.png" alt=""></p> <h3 id="_4-2-自动修复"><a href="#_4-2-自动修复" class="header-anchor">#</a> 4.2 自动修复</h3> <p>Kubernetes 有一个节点健康检查的功能，它会监测这个集群中所有的宿主机，当宿主机本身出现故障，或者软件出现故障的时候，这个节点健康检查会自动对它进行发现。</p> <p>下面 Kubernetes 会把运行在这些失败节点上的容器进行自动迁移，迁移到一个正在健康运行的宿主机上，来完成集群内容器的一个自动恢复。</p> <p><img src="/study/assets/img/k8s_fix.a11b20e0.png" alt=""></p> <h3 id="_4-3-水平伸缩"><a href="#_4-3-水平伸缩" class="header-anchor">#</a> 4.3 水平伸缩</h3> <p>Kubernetes 有业务负载检查的能力，它会监测业务上所承担的负载，如果这个业务本身的 CPU 利用率过高，或者响应时间过长，它可以对这个业务进行一次扩容。</p> <p>比如说在下面的例子中，黄颜色的过度忙碌，Kubernetes 就可以把黄颜色负载从一份变为三份。接下来，它就可以通过负载均衡把原来打到第一个黄颜色上的负载平均分到三个黄颜色的负载上去，以此来提高响应的时间。</p> <p><img src="/study/assets/img/k8s_expend.7ec5e67e.png" alt=""></p> <h2 id="第-5-章-kubernetes-的架构"><a href="#第-5-章-kubernetes-的架构" class="header-anchor">#</a> 第 5 章 Kubernetes 的架构</h2> <p>Kubernetes 架构是一个比较典型的二层架构和 server-client 架构。Master 作为中央的管控节点，会去与 Node 进行一个连接。</p> <p>所有 UI 的、clients、这些 user 侧的组件，只会和 Master 进行连接，把希望的状态或者想执行的命令下发给 Master，Master 会把这些命令或者状态下发给相应的节点，进行最终的执行。</p> <p><img src="/study/assets/img/k8s_schdule.a9aa07e6.png" alt=""></p> <h3 id="_5-1-master"><a href="#_5-1-master" class="header-anchor">#</a> 5.1 Master</h3> <p>Kubernetes 的 Master 包含四个主要的组件：API Server、Controller、Scheduler 以及 etcd。如下图所示：</p> <p><img src="/study/assets/img/k8s_master.f890248c.png" alt=""></p> <ul><li>**API Server：**顾名思义是用来处理 API 操作的，Kubernetes 中所有的组件都会和 API Server 进行连接，组件与组件之间一般不进行独立的连接，都依赖于 API Server 进行消息的传送；</li> <li>**Controller：**是控制器，它用来完成对集群状态的一些管理。比如刚刚我们提到的两个例子之中，第一个自动对容器进行修复、第二个自动进行水平扩张，都是由 Kubernetes 中的 Controller 来进行完成的；</li> <li>**Scheduler：**是调度器，“调度器”顾名思义就是完成调度的操作，就是我们刚才介绍的第一个例子中，把一个用户提交的 Container，依据它对 CPU、对 memory 请求大小，找一台合适的节点，进行放置；</li> <li>**etcd：**是一个分布式的一个存储系统，API Server 中所需要的这些原信息都被放置在 etcd 中，etcd 本身是一个高可用系统，通过 etcd 保证整个 Kubernetes 的 Master 组件的高可用性。</li></ul> <p>我们刚刚提到的 API Server，它本身在部署结构上是一个可以水平扩展的一个部署组件；Controller 是一个可以进行热备的一个部署组件，它只有一个 active，它的调度器也是相应的，虽然只有一个 active，但是可以进行热备。</p> <h3 id="_5-2-node"><a href="#_5-2-node" class="header-anchor">#</a> 5.2 <strong>Node</strong></h3> <p>Kubernetes 的 Node 是真正运行业务负载的，每个业务负载会以 Pod 的形式运行。一个 Pod 中运行的一个或者多个容器，真正去运行这些 Pod 的组件的是叫做 <strong>kubelet</strong>，也就是 Node 上最为关键的组件，它通过 API Server 接收到所需要 Pod 运行的状态，然后提交到我们下面画的这个 Container Runtime 组件中。</p> <p><img src="/study/assets/img/k8s_node.c47d8adf.png" alt=""></p> <p>在 OS 上去创建容器所需要运行的环境，最终把容器或者 Pod 运行起来，也需要对存储跟网络进行管理。Kubernetes 并不会直接进行网络存储的操作，他们会靠 Storage Plugin 或者是网络的 Plugin 来进行操作。用户自己或者云厂商都会去写相应的 <strong>Storage Plugin</strong> 或者 <strong>Network Plugin</strong>，去完成存储操作或网络操作。</p> <p>在 Kubernetes 自己的环境中，也会有 Kubernetes 的 Network，它是为了提供 Service network 来进行搭网组网的。真正完成 service 组网的组件的是 <strong>Kube-proxy</strong>，它是利用了 iptable 的能力来进行组建 Kubernetes 的 Network，就是 cluster network，以上就是 Node 上面的四个组件。</p> <p>Kubernetes 的 Node 并不会直接和 user 进行 interaction，它的 interaction 只会通过 Master。而 User 是通过 Master 向节点下发这些信息的。Kubernetes 每个 Node 上，都会运行我们刚才提到的这几个组件。</p> <p>下面我们以一个例子再去看一下 Kubernetes 架构中的这些组件，是如何互相进行 interaction 的。</p> <h2 id="第-6-章-环境搭建"><a href="#第-6-章-环境搭建" class="header-anchor">#</a> 第 6 章 环境搭建</h2> <h3 id="_6-1-准备环境"><a href="#_6-1-准备环境" class="header-anchor">#</a> 6.1 准备环境</h3> <table><thead><tr><th>主机</th> <th>服务</th> <th>备注</th></tr></thead> <tbody><tr><td>node-01</td> <td></td> <td></td></tr> <tr><td>node-02</td> <td></td> <td></td></tr> <tr><td>node-03</td> <td></td> <td></td></tr> <tr><td>node-04</td> <td></td> <td></td></tr> <tr><td>node-05</td> <td></td> <td></td></tr></tbody></table> <ol><li><p>关闭 SELinux 和 firewalld</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl stop firewalld               <span class="token comment">#临时关闭</span>

systemctl disable firewalld            <span class="token comment">#永久关闭,即设置开机的时候不自动启动</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）
</code></pre></div><p>永久关闭selinux可以使用vi命令打开/etc/sysconfig/selinux 文件将SELINUXTYPE=(disable或permissive）</p></li> <li><p>为全部服务器安装 epel-release 源</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> epel-release -y
</code></pre></div></li> <li><p>为全部服务器安装常用工具</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token function">wget</span> telnet net-tools tree nmap sysstat lrzsz dos2unix bind-utils -y
</code></pre></div></li></ol> <h3 id="_6-2-dns-服务初始化"><a href="#_6-2-dns-服务初始化" class="header-anchor">#</a> 6.2 DNS 服务初始化</h3> <h4 id="_6-2-1-安装-bind9-软件"><a href="#_6-2-1-安装-bind9-软件" class="header-anchor">#</a> 6.2.1 安装 bind9 软件</h4> <p>在 node-01 上执行命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token builtin class-name">bind</span> -y
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa bind</span>
bind-9.11.4-9.P2.el7.x86_64
</code></pre></div><h4 id="_6-2-2-配置-bind9"><a href="#_6-2-2-配置-bind9" class="header-anchor">#</a> 6.2.2 配置 bind9</h4> <ul><li><p>主配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/named.conf
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>listen-on port <span class="token number">53</span> <span class="token punctuation">{</span> <span class="token number">10.10</span>.50.50<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
allow-query     <span class="token punctuation">{</span> any<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
forwarders      <span class="token punctuation">{</span> <span class="token number">10.10</span>.50.1<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
dnssec-enable no<span class="token punctuation">;</span>
dnssec-validation no<span class="token punctuation">;</span>
</code></pre></div><p>​	检查配置, 没有保存就是 OK</p> <div class="language-shell extra-class"><pre class="language-shell"><code>name-checkconf
</code></pre></div></li> <li><p>区域配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/named.rfc1912.zones 
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>zone &quot;host.com&quot; IN {
        type master;
        file &quot;host.com.zone&quot;;
        allow-update { 10.10.50.50; };
};

zone &quot;thtf.com&quot; IN {
        type master;
        file &quot;thtf.com.zone&quot;;
        allow-update { 10.10.50.50; };
};
</code></pre></div></li> <li><p>区域数据文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span>  /var/named/host.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN host.com.
$TTL 600    ; 10 minutes
@       IN SOA  dns.host.com. dnsadmin.host.com. (
                2020032001 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
            NS   dns.host.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
node-01            A    10.10.50.50           
node-02            A    10.10.50.20
node-03            A    10.10.50.233
node-04            A    10.10.50.99
node-05            A    10.10.50.40
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span>  /var/named/thtf.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN thtf.com.
$TTL 600    ; 10 minutes
@           IN SOA  dns.thtf.com. dnsadmin.thtf.com. (
                2020032001 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
                NS   dns.thtf.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
</code></pre></div><p>检查配置, 没有保存就是 OK</p> <div class="language-shell extra-class"><pre class="language-shell"><code>named-checkconf
</code></pre></div></li></ul> <h4 id="_6-2-3-启动-bind9"><a href="#_6-2-3-启动-bind9" class="header-anchor">#</a> 6.2.3 启动 bind9</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start named</span>
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># netstat -lntup|grep 53</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.50:53          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">26226</span>/named         
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:953           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">26226</span>/named         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::53                   :::*                    LISTEN      <span class="token number">26226</span>/named         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> ::1:953                 :::*                    LISTEN      <span class="token number">26226</span>/named         
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">10.10</span>.50.50:53          <span class="token number">0.0</span>.0.0:*                           <span class="token number">26226</span>/named         
udp6       <span class="token number">0</span>      <span class="token number">0</span> :::53                   :::*                                <span class="token number">26226</span>/named 
</code></pre></div><h4 id="_6-2-4-检查-dns-服务"><a href="#_6-2-4-检查-dns-服务" class="header-anchor">#</a> 6.2.4 检查 DNS 服务</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-01.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.50
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-02.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.20
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-03.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.233
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-04.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.99
<span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A node-05.host.com @10.10.50.50 +short</span>
<span class="token number">10.10</span>.50.40
</code></pre></div><h4 id="_6-2-5-配置-dns-客户端"><a href="#_6-2-5-配置-dns-客户端" class="header-anchor">#</a> 6.2.5 配置 DNS 客户端</h4> <p>全部主机执行下面操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token number">10.10</span>.50.50
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/resolv.conf
search host.com
nameserver <span class="token number">10.10</span>.50.50
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>systemctl restart network
</code></pre></div><h3 id="_6-3-准备签发证书环境"><a href="#_6-3-准备签发证书环境" class="header-anchor">#</a> 6.3 准备签发证书环境</h3> <p>在 node-02 上</p> <h4 id="_6-3-1-安装-cfssl"><a href="#_6-3-1-安装-cfssl" class="header-anchor">#</a> 6.3.1 安装 cfssl</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
<span class="token function">chmod</span> +x /usr/bin/cfssl*
</code></pre></div><h4 id="_6-3-2-创建生成ca证书csr的json配置文件"><a href="#_6-3-2-创建生成ca证书csr的json配置文件" class="header-anchor">#</a> 6.3.2 创建生成ca证书csr的json配置文件</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /opt/certs
<span class="token function">vi</span>  /opt/certs/ca-csr.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;CN&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hosts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;algo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rsa&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;C&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CN&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ST&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;L&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beijing&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;O&quot;</span><span class="token operator">:</span> <span class="token string">&quot;thtf&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;OU&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ops&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ca&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;expiry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;175200h&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>CN：Common Name, 浏览器使用该字段验证网站是否合法, 一般写的是域名。非常重要。</p> <p>C：Country, 国家</p> <p>ST：State, 州, 省</p> <p>L：Locality 地区 城市</p> <p>O： Organization Name 组织名称 公司名称</p> <p>OU：Organization Unit Name 组织单位名称 公司部门</p></blockquote> <h4 id="_6-3-3-生成ca证书文件"><a href="#_6-3-3-生成ca证书文件" class="header-anchor">#</a> 6.3.3 生成ca证书文件</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-02 ~<span class="token punctuation">]</span><span class="token comment"># cd /opt/certs</span>

<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span>
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2020</span>/04/14 <span class="token number">10</span>:53:46 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">35390055852589240424773939585539235500209661940</span>
<span class="token punctuation">[</span>root@node-02 certs<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">16</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">989</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca.csr
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">325</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca-csr.json
-rw------- <span class="token number">1</span> root root <span class="token number">1675</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca-key.pem
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1338</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">10</span>:53 ca.pem
</code></pre></div><h3 id="_6-4-部署-docker"><a href="#_6-4-部署-docker" class="header-anchor">#</a> 6.4 部署 docker</h3> <p>node-03 node-04 node-05上</p> <h4 id="_6-4-1-安装"><a href="#_6-4-1-安装" class="header-anchor">#</a> 6.4.1 安装</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -fsSL https://get.docker.com <span class="token operator">|</span> <span class="token function">bash</span> -s docker --mirror Aliyun
</code></pre></div><h4 id="_6-4-2-配置"><a href="#_6-4-2-配置" class="header-anchor">#</a> 6.4.2 配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span>  /etc/docker
<span class="token function">vi</span>  /etc/docker/daemon.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;graph&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/data/docker&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;storage-driver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;overlay2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;insecure-registries&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;registry.access.redhat.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;quay.io&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;harbor.thtf.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;bip&quot;</span><span class="token operator">:</span> <span class="token string">&quot;172.7.21.1/24&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exec-opts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;live-restore&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
##########
bip要根据宿主机ip变化 
</code></pre></div><h4 id="_6-4-3-启动"><a href="#_6-4-3-启动" class="header-anchor">#</a> 6.4.3 启动</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /data/docker
systemctl start docker
systemctl <span class="token builtin class-name">enable</span> docker
docker --version
</code></pre></div><h3 id="_6-5-部署私有仓库-harbor"><a href="#_6-5-部署私有仓库-harbor" class="header-anchor">#</a> 6.5 部署私有仓库 harbor</h3> <p>在 node-05 上</p> <h4 id="_6-5-1-下载软件并解压"><a href="#_6-5-1-下载软件并解压" class="header-anchor">#</a> 6.5.1 下载软件并解压</h4> <p>harbor官网github地址 https://github.com/goharbor/harbor</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> xf harbor-offline-installer-v1.8.3.tgz -C /opt/
<span class="token function">mv</span> harbor/ harbor-v1.8.3
<span class="token function">ln</span> -s /opt/harbor-v1.8.3/ /opt/harbor
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>lrwxrwxrwx 1 root root  19 4月  14 12:13 harbor -&gt; /opt/harbor-v1.8.3/
drwxr-xr-x 2 root root 100 4月  14 12:12 harbor-v1.8.3
drwxr-xr-x 2 root root  49 4月  14 12:13 install_package
</code></pre></div><h4 id="_6-5-2-配置"><a href="#_6-5-2-配置" class="header-anchor">#</a> 6.5.2 配置</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /data/harbor/logs
<span class="token function">vi</span> /opt/harbor/harbor.yml
</code></pre></div><p>修改配置：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">hostname</span><span class="token punctuation">:</span> harbor.thtf.com
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">180</span>
 harbor_admin_password<span class="token punctuation">:</span>Harbor12345
<span class="token key atrule">data_volume</span><span class="token punctuation">:</span> /data/harbor
<span class="token key atrule">log</span><span class="token punctuation">:</span>
    <span class="token key atrule">level</span><span class="token punctuation">:</span>  info
    <span class="token key atrule">rotate_count</span><span class="token punctuation">:</span>  <span class="token number">50</span>
    rotate_size<span class="token punctuation">:</span>200M
    <span class="token key atrule">location</span><span class="token punctuation">:</span> /data/harbor/logs
</code></pre></div><h4 id="_6-5-3-安装-docker-compose"><a href="#_6-5-3-安装-docker-compose" class="header-anchor">#</a> 6.5.3 安装 docker-compose</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> docker-compose -y
</code></pre></div><h4 id="_6-5-4-安装-harbor"><a href="#_6-5-4-安装-harbor" class="header-anchor">#</a> 6.5.4 安装 harbor</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 进入 harbor 根目录</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">569632</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">583269670</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> harbor.v1.8.3.tar.gz
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">4528</span> <span class="token number">4</span>月  <span class="token number">14</span> <span class="token number">12</span>:19 harbor.yml
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">5088</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> install.sh
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">11347</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> LICENSE
-rwxr-xr-x <span class="token number">1</span> root root      <span class="token number">1654</span> <span class="token number">9</span>月  <span class="token number">16</span> <span class="token number">2019</span> prepare
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># ./install.sh </span>
</code></pre></div><h4 id="_6-5-5-检查-harbor-启动情况"><a href="#_6-5-5-检查-harbor-启动情况" class="header-anchor">#</a> 6.5.5 检查 harbor 启动情况</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose ps</span>
      Name                     Command               State             Ports          
--------------------------------------------------------------------------------------
harbor-core         /harbor/start.sh                 Up                               
harbor-db           /entrypoint.sh postgres          Up      <span class="token number">5432</span>/tcp                 
harbor-jobservice   /harbor/start.sh                 Up                               
harbor-log          /bin/sh -c /usr/local/bin/ <span class="token punctuation">..</span>.   Up      <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp
harbor-portal       nginx -g daemon off<span class="token punctuation">;</span>             Up      <span class="token number">80</span>/tcp                   
nginx               nginx -g daemon off<span class="token punctuation">;</span>             Up      <span class="token number">0.0</span>.0.0:180-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp      
redis               docker-entrypoint.sh redis <span class="token punctuation">..</span>.   Up      <span class="token number">6379</span>/tcp                 
registry            /entrypoint.sh /etc/regist <span class="token punctuation">..</span>.   Up      <span class="token number">5000</span>/tcp                 
registryctl         /harbor/start.sh                 Up                               
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker ps -a</span>
CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS                             PORTS                       NAMES
118479faae3c        goharbor/nginx-photon:v1.8.3                        <span class="token string">&quot;nginx -g 'daemon of…&quot;</span>   <span class="token number">27</span> seconds ago      Up <span class="token number">25</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:180-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp         nginx
a01be83050a8        goharbor/harbor-portal:v1.8.3                       <span class="token string">&quot;nginx -g 'daemon of…&quot;</span>   <span class="token number">28</span> seconds ago      Up <span class="token number">26</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">80</span>/tcp                      harbor-portal
bd00d3fa85cc        goharbor/harbor-jobservice:v1.8.3                   <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">28</span> seconds ago      Up <span class="token number">26</span> seconds                                                  harbor-jobservice
30e39e116f97        goharbor/harbor-core:v1.8.3                         <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">29</span> seconds ago      Up <span class="token number">27</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>                               harbor-core
3ecf74bd9a7b        goharbor/redis-photon:v1.8.3                        <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds                      <span class="token number">6379</span>/tcp                    redis
9acf04233a0d        goharbor/harbor-db:v1.8.3                           <span class="token string">&quot;/entrypoint.sh post…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">5432</span>/tcp                    harbor-db
0795ebef5a5d        goharbor/harbor-registryctl:v1.8.3                  <span class="token string">&quot;/harbor/start.sh&quot;</span>       <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>                               registryctl
e36367cf43e8        goharbor/registry-photon:v2.7.1-patch-2819-v1.8.3   <span class="token string">&quot;/entrypoint.sh /etc…&quot;</span>   <span class="token number">30</span> seconds ago      Up <span class="token number">28</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">5000</span>/tcp                    registry
33d5234e3edf        goharbor/harbor-log:v1.8.3                          <span class="token string">&quot;/bin/sh -c /usr/loc…&quot;</span>   <span class="token number">31</span> seconds ago      Up <span class="token number">29</span> seconds <span class="token punctuation">(</span>health: starting<span class="token punctuation">)</span>   <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp   harbor-log

</code></pre></div><h4 id="_6-5-6-配置-harbor-的-dns-内网解析"><a href="#_6-5-6-配置-harbor-的-dns-内网解析" class="header-anchor">#</a> 6.5.6 配置 harbor 的 dns 内网解析</h4> <p>在 node-01 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /var/named/thtf.com.zone
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ORIGIN thtf.com.
$TTL 600    ; 10 minutes
@           IN SOA  dns.thtf.com. dnsadmin.thtf.com. (
                2020032002 ; serial
                10800      ; refresh (3 hours)
                900        ; retry (15 minutes)
                604800     ; expire (1 week)
                86400      ; minimum (1 day)
                )
                NS   dns.thtf.com.
$TTL 60 ; 1 minute
dns                A    10.10.50.50
harbor             A    10.10.50.40
</code></pre></div><blockquote><p>2020032002 ; serial 前滚一个序号</p> <p>harbor             A    10.10.50.40</p></blockquote> <p>重启 named</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl restart named
</code></pre></div><p>检查</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-01 ~<span class="token punctuation">]</span><span class="token comment"># dig -t A harbor.thtf.com +short</span>
<span class="token number">10.10</span>.50.40
</code></pre></div><h4 id="_6-5-6-安装-nginx-并配置"><a href="#_6-5-6-安装-nginx-并配置" class="header-anchor">#</a> 6.5.6 安装 Nginx 并配置</h4> <p>在 node-05 上</p> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> nginx -y
</code></pre></div><p>修改配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/nginx/conf.d/harbor.thtf.com.conf
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>server {
    listen       80;
    server_name  harbor.thtf.com;

    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># systemctl start nginx</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># systemctl enable nginx</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.
</code></pre></div><h4 id="_6-5-7-测试"><a href="#_6-5-7-测试" class="header-anchor">#</a> 6.5.7 测试</h4> <ol><li>浏览器输入：harbor.thtf.com</li></ol> <p><img src="/study/assets/img/harbor.d0279e60.png" alt=""></p> <ol start="2"><li><p>输入用户名：admin 密码：Harbor12345</p> <p><img src="/study/assets/img/harbor_admin.1639de8c.png" alt=""></p></li> <li><p>新建项目：public 访问级别：公开</p> <p><img src="/study/assets/img/harbor_public.15703d1a.png" alt=""></p> <p><img src="/study/assets/img/harbor_public_list.5dbf2b26.png" alt=""></p></li> <li><p>下载镜像并给镜像打 tag</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker pull nginx:1.7.9</span>
<span class="token number">1.7</span>.9: Pulling from library/nginx
Image docker.io/library/nginx:1.7.9 uses outdated schema1 manifest format. Please upgrade to a schema2 image <span class="token keyword">for</span> better future compatibility. More information at https://docs.docker.com/registry/spec/deprecated-schema-v1/
a3ed95caeb02: Pull complete 
6f5424ebd796: Pull complete 
d15444df170a: Pull complete 
e83f073daa67: Pull complete 
a4d93e421023: Pull complete 
084adbca2647: Pull complete 
c9cec474c523: Pull complete 
Digest: sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
Status: Downloaded newer image <span class="token keyword">for</span> nginx:1.7.9
docker.io/library/nginx:1.7.9
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker images|grep nginx</span>
goharbor/nginx-photon           v1.8.3                     3a016e0dc7de        <span class="token number">7</span> months ago        37MB
nginx                           <span class="token number">1.7</span>.9                      84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker tag 84581e99d807 harbor.thtf.com/public/nginx:v1.7.9</span>
<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker images|grep nginx</span>
goharbor/nginx-photon           v1.8.3           <span class="token function">vi</span> <span class="token function">vi</span>           3a016e0dc7de        <span class="token number">7</span> months ago        37MB
nginx                           <span class="token number">1.7</span>.9                      84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB
harbor.thtf.com/public/nginx     v1.7.9                     84581e99d807        <span class="token number">5</span> years ago         <span class="token number">91</span>.7MB

</code></pre></div></li> <li><p>登录 harbor 并上传仓库</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker login harbor.thtf.com</span>
Authenticating with existing credentials<span class="token punctuation">..</span>.
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span> /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-store</span>

Login Succeeded

<span class="token punctuation">[</span>root@node-05 harbor<span class="token punctuation">]</span><span class="token comment"># docker push harbor.thtf.com/public/nginx:v1.7.9</span>
The push refers to repository <span class="token punctuation">[</span>harbor.thtf.com/public/nginx<span class="token punctuation">]</span>
5f70bf18a086: Pushed 
4b26ab29a475: Pushed 
ccb1d68e3fb7: Pushed 
e387107e2065: Pushed 
63bf84221cce: Pushed 
e02dce553481: Pushed 
dea2e4984e29: Pushed 
v1.7.9: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: <span class="token number">3012</span>

</code></pre></div><p>可以看到NGINX镜像已经上传到public下</p> <p><img src="/study/assets/img/harbor_push.c26f187c.png" alt=""></p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/DevOps/Jenkins与Docker的自动化CICD实战.html" class="prev">
        /DevOps/Jenkins与Docker的自动化CICD实战.html
      </a></span> <span class="next"><a href="/study/大数据/Hadoop.html">
        Hadoop
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/study/assets/js/app.805d6976.js" defer></script><script src="/study/assets/js/2.d79867de.js" defer></script><script src="/study/assets/js/6.40dc09d8.js" defer></script>
  </body>
</html>
