<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes-1 | PYY在线笔记文档</title>
    <meta name="generator" content="VuePress 1.7.0">
    <link rel="icon" href="/study/img/logo.png">
    <meta name="description" content="PYY在线笔记文档">
    
    <link rel="preload" href="/study/assets/css/0.styles.340bd9de.css" as="style"><link rel="preload" href="/study/assets/js/app.9d47d501.js" as="script"><link rel="preload" href="/study/assets/js/2.e3467082.js" as="script"><link rel="preload" href="/study/assets/js/3.1db237fe.js" as="script"><link rel="prefetch" href="/study/assets/js/10.c375ac7f.js"><link rel="prefetch" href="/study/assets/js/11.04dc01bf.js"><link rel="prefetch" href="/study/assets/js/12.ccec54f3.js"><link rel="prefetch" href="/study/assets/js/13.7a1d7fab.js"><link rel="prefetch" href="/study/assets/js/14.dc3952ea.js"><link rel="prefetch" href="/study/assets/js/15.ec56fed9.js"><link rel="prefetch" href="/study/assets/js/16.d318f187.js"><link rel="prefetch" href="/study/assets/js/17.d4390fcd.js"><link rel="prefetch" href="/study/assets/js/18.626fd5f8.js"><link rel="prefetch" href="/study/assets/js/19.c34f4af5.js"><link rel="prefetch" href="/study/assets/js/20.040a84e0.js"><link rel="prefetch" href="/study/assets/js/21.8279dbd3.js"><link rel="prefetch" href="/study/assets/js/22.28c51ca7.js"><link rel="prefetch" href="/study/assets/js/23.ddf8c731.js"><link rel="prefetch" href="/study/assets/js/24.5b56b931.js"><link rel="prefetch" href="/study/assets/js/25.6a6b1692.js"><link rel="prefetch" href="/study/assets/js/26.61602338.js"><link rel="prefetch" href="/study/assets/js/4.5fea7e6b.js"><link rel="prefetch" href="/study/assets/js/5.df154660.js"><link rel="prefetch" href="/study/assets/js/6.6441e3e8.js"><link rel="prefetch" href="/study/assets/js/7.6d55976a.js"><link rel="prefetch" href="/study/assets/js/8.c8e9358a.js"><link rel="prefetch" href="/study/assets/js/9.15b0a697.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.340bd9de.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记文档" class="logo"> <span class="site-name can-hide">PYY在线笔记文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dev Ops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/devops/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/study/devops/docker.html" class="sidebar-link">Docker</a></li><li><a href="/study/devops/dockercompose.html" class="sidebar-link">Docker Compose</a></li><li><a href="/study/devops/jenkins-yudocker-de-zi-dong-huacicd-shi-zhan.html" class="sidebar-link">Jenkins与Docker的自动化CICD实战</a></li><li><a href="/study/devops/kubernetes-1.html" aria-current="page" class="active sidebar-link">Kubernetes-1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-1-章-概述" class="sidebar-link">第 1 章 概述</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-2-章-从传统到容器化部署" class="sidebar-link">第 2 章 从传统到容器化部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_2-1-传统的部署方式" class="sidebar-link">2.1 传统的部署方式</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_2-2-容器化部署的优势" class="sidebar-link">2.2 容器化部署的优势</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_2-3-为什么需要-kubernetes" class="sidebar-link">2.3 为什么需要 Kubernetes</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-3-章-kubernetes-快速入门" class="sidebar-link">第 3 章 Kubernetes 快速入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-1-kubernetes-安装前准备" class="sidebar-link">3.1 Kubernetes 安装前准备</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-2-统一环境配置" class="sidebar-link">3.2 统一环境配置</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-3-单独节点配置" class="sidebar-link">3.3 单独节点配置</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-4-kubernetes-集群安装" class="sidebar-link">3.4 Kubernetes 集群安装</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-5-kubernetes-网络配置" class="sidebar-link">3.5 Kubernetes 网络配置</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_3-6-第一个-kubernetes-容器" class="sidebar-link">3.6 第一个 Kubernetes 容器</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-4-章-kubernetes-核心功能" class="sidebar-link">第 4 章 Kubernetes 核心功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_4-1-调度" class="sidebar-link">4.1 调度</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_4-2-自动修复" class="sidebar-link">4.2 自动修复</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_4-3-水平伸缩" class="sidebar-link">4.3 水平伸缩</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-5-章-kubernetes-架构" class="sidebar-link">第 5 章 Kubernetes 架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_5-1-master" class="sidebar-link">5.1 Master</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_5-2-node" class="sidebar-link">5.2 Node</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#第-6-章-kubernetes-实战" class="sidebar-link">第 6 章 Kubernetes 实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_6-1-nginx-部署" class="sidebar-link">6.1 Nginx 部署</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_6-2-ingress-统一访问入门" class="sidebar-link">6.2 Ingress 统一访问入门</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_6-3-kubernetes-准备数据卷-持久化" class="sidebar-link">6.3 Kubernetes 准备数据卷（持久化）</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_6-4-kubernetes-实现数据持久化" class="sidebar-link">6.4 Kubernetes 实现数据持久化</a></li><li class="sidebar-sub-header"><a href="/study/devops/kubernetes-1.html#_6-5-kubernetes-configmap" class="sidebar-link">6.5 Kubernetes ConfigMap</a></li></ul></li></ul></li><li><a href="/study/devops/kubernetes-2.html" class="sidebar-link">Kubernetes-2</a></li><li><a href="/study/devops/nginx.html" class="sidebar-link">Nginx</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes-1"><a href="#kubernetes-1" class="header-anchor">#</a> Kubernetes-1</h1> <h2 id="第-1-章-概述"><a href="#第-1-章-概述" class="header-anchor">#</a> 第 1 章 概述</h2> <p><img src="data:image/png;base64,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" alt=""></p> <p>官网：https://kubernetes.io</p> <p>Github：https://github.com/kubernetes/kubernetes</p> <p>由来：谷歌的Borg系统, 后经Go语言重写并捐献给CNCF基金会开源</p> <p>含义：词根源于希腊语：舵手/飞行员，K8S -》K 8个字母 S</p> <p>Kubernetes 是 <strong>Google 2014 年创建管理的</strong>，是 Google 10 多年大规模容器管理技术 Borg 的开源版本。</p> <p>Kubernetes 是容器集群管理系统，是一个开源的平台，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。使用 Kubernetes 我们可以：</p> <ul><li>快速部署应用</li> <li>快速扩展应用</li> <li>无缝对接新的应用功能</li> <li>节省资源，优化硬件资源的使用</li></ul> <p>Kubernetes 的目标是促进完善组件和工具的生态系统，以减轻应用程序在公有云或私有云中运行的负担。</p> <h2 id="第-2-章-从传统到容器化部署"><a href="#第-2-章-从传统到容器化部署" class="header-anchor">#</a> 第 2 章 从传统到容器化部署</h2> <p><img src="/study/assets/img/why_containers.c9dbd324.svg" alt=""></p> <h3 id="_2-1-传统的部署方式"><a href="#_2-1-传统的部署方式" class="header-anchor">#</a> 2.1 传统的部署方式</h3> <p>传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等操作，当然也可以通过创建虚机的方式来实现某些功能，但是虚拟机非常重，并不利于可移植性。</p> <h3 id="_2-2-容器化部署的优势"><a href="#_2-2-容器化部署的优势" class="header-anchor">#</a> 2.2 容器化部署的优势</h3> <ul><li><p><strong>快速创建/部署应用：</strong> 与虚拟机相比，容器镜像的创建更加容易。</p></li> <li><p><strong>持续开发、集成和部署：</strong> 提供可靠且频繁的容器镜像构建/部署，并使用快速和简单的回滚(由于镜像不可变性)。</p></li> <li><p><strong>开发和运行相分离：</strong> 在 build 或者 release 阶段创建容器镜像，使得应用和基础设施解耦。</p></li> <li><p><strong>开发，测试和生产环境一致性：</strong> 在本地或外网（生产环境）运行的一致性。</p></li> <li><p><strong>云平台或其他操作系统：</strong> 可以在 Ubuntu、RHEL、CoreOS、on-prem、Google Container Engine 或其它任何环境中运行。</p></li> <li><p><strong>分布式，弹性，微服务化：</strong> 应用程序分为更小的、独立的部件，可以动态部署和管理。</p></li> <li><p><strong>资源隔离</strong></p></li> <li><p><strong>资源利用更高效</strong></p></li></ul> <h3 id="_2-3-为什么需要-kubernetes"><a href="#_2-3-为什么需要-kubernetes" class="header-anchor">#</a> 2.3 为什么需要 Kubernetes</h3> <p>可以在物理或虚拟机的 Kubernetes 集群上运行容器化应用，Kubernetes 能提供一个以 <strong>“容器为中心的基础架构”</strong>，满足在生产环境中运行应用的一些常见需求，如：</p> <ul><li><strong>自动化装箱</strong>：在不牺牲可用性的条件下，基于容器对资源的要求和约束自动部署容器。同时，为了提高利用率和节省更多资源，将关键和最佳工作量结合在一起。</li> <li><strong>自愈能力</strong>：当容器失败时，会对容器进行重启；当所部署的Node节点有问题时，会对容器进行重新部署和重新调度；当容器未通过监控检查时，会关闭此容器；直到容器正常运行时，才会对外提供服务。</li> <li><strong>水平扩容</strong>：通过简单的命令、用户界面或基于CPU 的使用情况，能够对应用进行扩容和缩容。</li> <li><strong>服务发现和负载均衡</strong>：开发者不需要使用额外的服务发现机制，就能够基于Kubernetes 进行服务发现和负载均衡。</li> <li><strong>自动发布和回滚</strong>：Kubernetes 能够程序化的发布应用和相关的配置。如果发布有问题，Kubernetes 将能够回归发生的变更。</li> <li><strong>保密和配置管理</strong>：在不需要重新构建镜像的情况下，可以部署和更新保密和应用配置。</li> <li><strong>存储编排</strong>：自动挂接存储系统，这些存储系统可以来自于本地、公共云提供商（例如：GCP和AWS）、网络存储(例如：NFS、iSCSI、Gluster、Ceph、Cinder和Floker等)。</li></ul> <h2 id="第-3-章-kubernetes-快速入门"><a href="#第-3-章-kubernetes-快速入门" class="header-anchor">#</a> 第 3 章 Kubernetes 快速入门</h2> <h3 id="_3-1-kubernetes-安装前准备"><a href="#_3-1-kubernetes-安装前准备" class="header-anchor">#</a> 3.1 Kubernetes 安装前准备</h3> <h4 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h4> <p>本次安装采用 Ubuntu Server X64 18.04 LTS 版本安装 kubernetes 集群环境，集群节点为 1 主 2 从模式，此次对虚拟机会有些基本要求，如下：</p> <ul><li>OS：Ubuntu Server X64 18.04 LTS</li> <li>CPU：最低要求，1 CPU 2 核</li> <li>内存：最低要求，2GB</li> <li>磁盘：最低要求，20GB</li></ul> <h4 id="节点配置"><a href="#节点配置" class="header-anchor">#</a> 节点配置</h4> <p>创建三台虚拟机，节点配置如下：</p> <table><thead><tr><th>主机名</th> <th>IP</th> <th>角色</th> <th>系统</th> <th>CUP/内存</th> <th>磁盘</th></tr></thead> <tbody><tr><td>k8s-master</td> <td></td> <td>Master</td> <td>Ubuntu Server 18.04</td> <td>2 核 2G</td> <td>20G</td></tr> <tr><td>k8s-node-01</td> <td></td> <td>Node</td> <td>Ubuntu Server 18.04</td> <td>2 核 2G</td> <td>20G</td></tr> <tr><td>k8s-node-02</td> <td></td> <td>Node</td> <td>Ubuntu Server 18.04</td> <td>2 核 2G</td> <td>20G</td></tr></tbody></table> <h3 id="_3-2-统一环境配置"><a href="#_3-2-统一环境配置" class="header-anchor">#</a> 3.2 统一环境配置</h3> <blockquote><p>注意：以下步骤请在制作 VMWare 镜像时一并完成, 避免逐台安装的麻烦。</p></blockquote> <h4 id="关闭交互空间"><a href="#关闭交互空间" class="header-anchor">#</a> 关闭交互空间</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>swapoff -a
</code></pre></div><h4 id="避免开机启动交换空间"><a href="#避免开机启动交换空间" class="header-anchor">#</a> 避免开机启动交换空间</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 注释 /etc/fstab 中的 swap</span>
<span class="token function">vi</span> /etc/fstab
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># /etc/fstab: static file system information.</span>
<span class="token comment"># </span>
<span class="token comment"># Use 'blkid' to print the universally unique identifier for a</span>
<span class="token comment"># device; this may be used with UUID= as a more robust way to name devices</span>
<span class="token comment"># that works even if disks are added and removed. See fstab(5).</span>
<span class="token comment">#</span>
<span class="token comment"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
<span class="token comment"># / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation</span>
/dev/disk/by-id/dm-uuid-LVM-rcRcdAdAApoq0jWHr6b2lt7nzFCwTHvsdjqttVuxIlK6RMu4kQbZVprrsZ0H7yvf / ext4 defaults <span class="token number">0</span> <span class="token number">0</span>
<span class="token comment"># /boot was on /dev/sda2 during curtin installation</span>
/dev/disk/by-uuid/87384c47-a26e-4950-8352-ad8b3c7dacfb /boot ext4 defaults <span class="token number">0</span> <span class="token number">0</span>
<span class="token comment">#/swap.img      none    swap    sw      0       0</span>
</code></pre></div><h4 id="关闭防火墙"><a href="#关闭防火墙" class="header-anchor">#</a> 关闭防火墙</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>ufw disable
</code></pre></div><h4 id="使用-apt-安装-docker"><a href="#使用-apt-安装-docker" class="header-anchor">#</a> 使用 apt 安装 Docker</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 更新软件源</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token comment"># 安装所需依赖</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common
<span class="token comment"># 安装 GPG 证书</span>
<span class="token function">curl</span> -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token comment"># 新增软件源信息</span>
<span class="token function">sudo</span> add-apt-repository <span class="token string">&quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable&quot;</span>
<span class="token comment"># 再次更新软件源</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y update
<span class="token comment"># 安装 Docker CE 版</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> docker-ce
</code></pre></div><h4 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># docker version</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>Client: Docker Engine - Community
 Version:           <span class="token number">19.03</span>.8
 API version:       <span class="token number">1.40</span>
 Go version:        go1.12.17
 Git commit:        afacb8b7f0
 Built:             Wed Mar <span class="token number">11</span> 01:25:46 <span class="token number">2020</span>
 OS/Arch:           linux/amd64
 Experimental:      <span class="token boolean">false</span>

Server: Docker Engine - Community
 Engine:
  Version:          <span class="token number">19.03</span>.8
  API version:      <span class="token number">1.40</span> <span class="token punctuation">(</span>minimum version <span class="token number">1.12</span><span class="token punctuation">)</span>
  Go version:       go1.12.17
  Git commit:       afacb8b7f0
  Built:            Wed Mar <span class="token number">11</span> 01:24:19 <span class="token number">2020</span>
  OS/Arch:          linux/amd64
  Experimental:     <span class="token boolean">false</span>
 containerd:
  Version:          <span class="token number">1.2</span>.13
  GitCommit:        7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc:
  Version:          <span class="token number">1.0</span>.0-rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker-init:
  Version:          <span class="token number">0.18</span>.0
  GitCommit:        fec3683
</code></pre></div><h4 id="配置-docker-加速器"><a href="#配置-docker-加速器" class="header-anchor">#</a> 配置 Docker 加速器</h4> <p>对于使用 <strong>systemd</strong> 的系统，请在 <code>/etc/docker/daemon.json</code> 中写入如下内容（如果文件不存在请新建该文件）</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;https://registry.docker-cn.com&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>注意，一定要保证该文件符合 JSON 规范，否则 Docker 将不能启动。</p></blockquote> <p>验证加速器是否配置成功：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> systemctl restart docker
docker info
<span class="token punctuation">..</span>.
<span class="token comment"># 出现如下语句即表示配置成功</span>
Registry Mirrors:
 https://registry.docker-cn.com/
<span class="token punctuation">..</span>.
</code></pre></div><h4 id="安装-kubeadm-kubelet-kubectl"><a href="#安装-kubeadm-kubelet-kubectl" class="header-anchor">#</a> 安装 kubeadm，kubelet，kubectl</h4> <p>kubeadm 是 kubernetes 的集群安装工具，能够快速安装 kubernetes 集群。</p> <ul><li><p>配置软件源</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装系统工具</span>
<span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https
<span class="token comment"># 安装 GPG 证书</span>
<span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -
<span class="token comment"># 写入软件源；注意：我们用系统代号为 bionic，但目前阿里云不支持，所以沿用 16.04 的 xenial</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span>/etc/apt/sources.list.d/kubernetes.list</span>
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF</span>
</code></pre></div></li> <li><p>安装kubeadm，kubelet，kubectl</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装</span>
<span class="token function">apt-get</span> update  
<span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl
</code></pre></div></li> <li><p>设置 kubelet 自启动， 并启动 kubelet</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet
</code></pre></div><blockquote><p><strong>kubeadm</strong>：用于初始化 Kubernetes 集群</p> <p><strong>kubectl</strong>：Kubernetes 的命令行工具，主要作用是部署和管理应用，查看各种资源，创建，删除和更新组件</p> <p><strong>kubelet</strong>：主要负责启动 Pod 和容器</p></blockquote></li></ul> <h4 id="同步时间"><a href="#同步时间" class="header-anchor">#</a> 同步时间</h4> <ul><li><p>设定时区</p> <div class="language-shell extra-class"><pre class="language-shell"><code>dpkg-reconfigure tzdata
</code></pre></div><p><img src="/study/assets/img/ubuntu_clock.44cab9b9.png" alt=""></p> <p>选择 Asia -&gt; 再选择 Shanghai -&gt; OK</p> <p><img src="/study/assets/img/ubuntu_clock1.ed9b3b5c.png" alt=""></p></li> <li><p>时间同步</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装ntpdate工具</span>
<span class="token function">apt-get</span> <span class="token function">install</span> ntpdate

<span class="token comment"># 将系统时间与网络同步</span>
ntpdate cn.pool.ntp.org

<span class="token comment"># 将时间写入硬件</span>
hwclock --systohc
</code></pre></div></li> <li><p>查看时间是否已同步</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">date</span>
</code></pre></div></li></ul> <h4 id="修改-cloud-cfg"><a href="#修改-cloud-cfg" class="header-anchor">#</a> 修改 cloud.cfg</h4> <p>主要作用是防止重启后主机名修改还原问题</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /etc/cloud/cloud.cfg

<span class="token comment"># 该配置默认为 false，修改为 true 即可</span>
preserve_hostname: <span class="token boolean">true</span>
</code></pre></div><h4 id="克隆虚拟机环境"><a href="#克隆虚拟机环境" class="header-anchor">#</a> 克隆虚拟机环境</h4> <p>在完成上面统一配置后，我们将虚拟机重启下。重启完毕后, 就可以将这台基础服务器关机, 并用此虚拟机作为 k8s 基础服务器镜像, 然后分表克隆出三台服务器节点, 并为它们单独配置 <strong>IP</strong> 和 <strong>主机名</strong></p> <h3 id="_3-3-单独节点配置"><a href="#_3-3-单独节点配置" class="header-anchor">#</a> 3.3 单独节点配置</h3> <p>在同一局域网中主机名不应该相同，所以我们需要做修改，下列操作步骤为修改 <strong>18.04</strong> 版本的 Hostname，如果是 16.04 或以下版本则直接修改 <code>/etc/hostname</code> 里的名称即可</p> <h4 id="修改主机名-各个节点分别修改"><a href="#修改主机名-各个节点分别修改" class="header-anchor">#</a> 修改主机名（各个节点分别修改）</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 使用 hostnamectl 命令修改，其中 kubernetes-master 为新的主机名</span>
hostnamectl set-hostname kubernetes-master

<span class="token comment"># 配置 hosts</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
10.10.50.50 kubernetes-node-02
EOF</span>
</code></pre></div><h4 id="重启"><a href="#重启" class="header-anchor">#</a> 重启</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">reboot</span>
</code></pre></div><h3 id="_3-4-kubernetes-集群安装"><a href="#_3-4-kubernetes-集群安装" class="header-anchor">#</a> 3.4 Kubernetes 集群安装</h3> <h4 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h4> <p>安装 kubernetes 主要是安装它的各个镜像，而 kubeadm 已经为我们集成好了运行 kubernetes 所需的基本镜像。但由于国内的网络原因，在搭建环境时，无法拉取到这些镜像。此时我们只需要修改为阿里云提供的镜像服务即可解决该问题。</p> <h4 id="创建并修改配置"><a href="#创建并修改配置" class="header-anchor">#</a> 创建并修改配置</h4> <p>在 kubernetes-master 节点上</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建工作目录</span>
<span class="token function">mkdir</span> -p /usr/local/kubernetes/cluster
<span class="token builtin class-name">cd</span> /usr/local/kubernetes/cluster/

<span class="token comment"># 导出配置文件</span>
kubeadm config print init-defaults --kubeconfig ClusterConfiguration <span class="token operator">&gt;</span> kubeadm.yml

</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 修改配置文件内容</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">bootstrapTokens</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>kubeadm<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token
  <span class="token key atrule">token</span><span class="token punctuation">:</span> abcdef.0123456789abcdef
  <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 24h0m0s
  <span class="token key atrule">usages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> signing
  <span class="token punctuation">-</span> authentication
<span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration
<span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>
	<span class="token comment"># 修改主节点 IP 地址</span>
  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 10.10.50.38
  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/dockershim.sock
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>master
  <span class="token key atrule">taints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
<span class="token punctuation">---</span>
<span class="token key atrule">apiServer</span><span class="token punctuation">:</span>
  <span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> kubernetes
<span class="token key atrule">controllerManager</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> CoreDNS
<span class="token key atrule">etcd</span><span class="token punctuation">:</span>
  <span class="token key atrule">local</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token comment"># 国内不能访问 Google, 修改镜像为阿里云</span>
<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> v1.18.0
<span class="token key atrule">networking</span><span class="token punctuation">:</span>
  <span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> cluster.local
  <span class="token comment"># 配置 Pod 所在网段为我们虚拟机不重叠的网段（这里用的是 flannel 默认网段）</span>
  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> <span class="token string">&quot;10.244.0.0/16&quot;</span>
  <span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.96.0.0/12
<span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="查看和拉取镜像"><a href="#查看和拉取镜像" class="header-anchor">#</a> 查看和拉取镜像</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看所需镜像列表</span>
kubeadm config images list --config kubeadm.yml

<span class="token comment"># 拉取镜像</span>
kubeadm config images pull --config kubeadm.yml
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>root@kubernetes-master:/usr/local/kubernetes/cluster<span class="token comment"># kubeadm config images list --config kubeadm.yml</span>
registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.0
registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.0
registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.0
registry.aliyuncs.com/google_containers/kube-proxy:v1.18.0
registry.aliyuncs.com/google_containers/pause:3.2
registry.aliyuncs.com/google_containers/etcd:3.4.3-0
registry.aliyuncs.com/google_containers/coredns:1.6.7
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>root@kubernetes-master:/usr/local/kubernetes/cluster<span class="token comment"># kubeadm config images pull --config kubeadm.yml</span>
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.18.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.2
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.4.3-0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/coredns:1.6.7
</code></pre></div><h4 id="安装-kubernetes-master主节点"><a href="#安装-kubernetes-master主节点" class="header-anchor">#</a> 安装 kubernetes master主节点</h4> <p>执行以下命令初始化主节点，该命令指定了初始化时需要使用的配置文件，其中添加 <code>--upload-certs</code> 参数可以在后续执行加入节点时自动分发证书文件。追加的 <code>tee kubeadm-init.log</code> 用以输出日志。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@kubernetes-master:/usr/local/kubernetes/cluster<span class="token comment"># kubeadm init --config=kubeadm.yml --upload-certs | tee kubeadm-init.log</span>

<span class="token comment"># 安装信息如下：</span>
W0422 <span class="token number">18</span>:39:10.202126   <span class="token number">64944</span> configset.go:202<span class="token punctuation">]</span> WARNING: kubeadm cannot validate component configs <span class="token keyword">for</span> API <span class="token function">groups</span> <span class="token punctuation">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span class="token punctuation">]</span>
<span class="token punctuation">[</span>init<span class="token punctuation">]</span> Using Kubernetes version: v1.18.0
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
        <span class="token punctuation">[</span>WARNING IsDockerSystemdCheck<span class="token punctuation">]</span>: detected <span class="token string">&quot;cgroupfs&quot;</span> as the Docker cgroup driver. The recommended driver is <span class="token string">&quot;systemd&quot;</span><span class="token builtin class-name">.</span> Please follow the guide at https://kubernetes.io/docs/setup/cri/
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Pulling images required <span class="token keyword">for</span> setting up a Kubernetes cluster
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> This might take a minute or two, depending on the speed of your internet connection
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> You can also perform this action <span class="token keyword">in</span> beforehand using <span class="token string">'kubeadm config images pull'</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Using certificateDir folder <span class="token string">&quot;/etc/kubernetes/pki&quot;</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;ca&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;apiserver&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> apiserver serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>kubernetes-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.96</span>.0.1 <span class="token number">10.10</span>.50.38<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;apiserver-kubelet-client&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;front-proxy-ca&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;front-proxy-client&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;etcd/ca&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;etcd/server&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/server serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>kubernetes-master localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.10</span>.50.38 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;etcd/peer&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/peer serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>kubernetes-master localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.10</span>.50.38 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;etcd/healthcheck-client&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;apiserver-etcd-client&quot;</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">&quot;sa&quot;</span> key and public key
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Using kubeconfig folder <span class="token string">&quot;/etc/kubernetes&quot;</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">&quot;admin.conf&quot;</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">&quot;kubelet.conf&quot;</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">&quot;controller-manager.conf&quot;</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">&quot;scheduler.conf&quot;</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Using manifest folder <span class="token string">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">&quot;kube-apiserver&quot;</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">&quot;kube-controller-manager&quot;</span>
W0422 <span class="token number">18</span>:39:13.732379   <span class="token number">64944</span> manifests.go:225<span class="token punctuation">]</span> the default kube-apiserver authorization-mode is <span class="token string">&quot;Node,RBAC&quot;</span><span class="token punctuation">;</span> using <span class="token string">&quot;Node,RBAC&quot;</span>
W0422 <span class="token number">18</span>:39:13.733814   <span class="token number">64944</span> manifests.go:225<span class="token punctuation">]</span> the default kube-apiserver authorization-mode is <span class="token string">&quot;Node,RBAC&quot;</span><span class="token punctuation">;</span> using <span class="token string">&quot;Node,RBAC&quot;</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">&quot;kube-scheduler&quot;</span>
<span class="token punctuation">[</span>etcd<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token builtin class-name">local</span> etcd <span class="token keyword">in</span> <span class="token string">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="token punctuation">[</span>wait-control-plane<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="token string">&quot;/etc/kubernetes/manifests&quot;</span><span class="token builtin class-name">.</span> This can take up to 4m0s
<span class="token punctuation">[</span>apiclient<span class="token punctuation">]</span> All control plane components are healthy after <span class="token number">26.003179</span> seconds
<span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Storing the configuration used <span class="token keyword">in</span> ConfigMap <span class="token string">&quot;kubeadm-config&quot;</span> <span class="token keyword">in</span> the <span class="token string">&quot;kube-system&quot;</span> Namespace
<span class="token punctuation">[</span>kubelet<span class="token punctuation">]</span> Creating a ConfigMap <span class="token string">&quot;kubelet-config-1.18&quot;</span> <span class="token keyword">in</span> namespace kube-system with the configuration <span class="token keyword">for</span> the kubelets <span class="token keyword">in</span> the cluster
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Storing the certificates <span class="token keyword">in</span> Secret <span class="token string">&quot;kubeadm-certs&quot;</span> <span class="token keyword">in</span> the <span class="token string">&quot;kube-system&quot;</span> Namespace
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Using certificate key:
e2ae2e0a251263e68ee121fff04c8b4605d1cd50224a4085817f4375f6bb7273
<span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node kubernetes-master as control-plane by adding the label <span class="token string">&quot;node-role.kubernetes.io/master=''&quot;</span>
<span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node kubernetes-master as control-plane by adding the taints <span class="token punctuation">[</span>node-role.kubernetes.io/master:NoSchedule<span class="token punctuation">]</span>
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Using token: abcdef.0123456789abcdef
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="token keyword">in</span> order <span class="token keyword">for</span> nodes to get long term certificate credentials
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow certificate rotation <span class="token keyword">for</span> all node client certificates <span class="token keyword">in</span> the cluster
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Creating the <span class="token string">&quot;cluster-info&quot;</span> ConfigMap <span class="token keyword">in</span> the <span class="token string">&quot;kube-public&quot;</span> namespace
<span class="token punctuation">[</span>kubelet-finalize<span class="token punctuation">]</span> Updating <span class="token string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key
<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS
<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">10.10</span>.50.38:6443 --token abcdef.0123456789abcdef <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:433b194618efc80f0cf6cdc5fa2fd8930c428c9bfb9e61b931a9cfe062b9c3b8 
</code></pre></div><h4 id="配置-kubectl"><a href="#配置-kubectl" class="header-anchor">#</a> 配置 kubectl</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 参考上面输出</span>
<span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config

<span class="token comment"># 非 ROOT 用户执行</span>
<span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre></div><h4 id="验证是否成功"><a href="#验证是否成功" class="header-anchor">#</a> 验证是否成功</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get node

<span class="token comment"># 能够打印出节点信息即表示成功</span>
NAME                STATUS     ROLES    AGE     VERSION
kubernetes-master   NotReady   master   4m12s   v1.18.2
</code></pre></div><p>至此主节点配置完成。</p> <h4 id="使用-kubeadm-配置-slave-节点"><a href="#使用-kubeadm-配置-slave-节点" class="header-anchor">#</a> 使用 kubeadm 配置 slave 节点</h4> <p>将 slave 节点加入到集群中很简单，只需要在 slave 服务器上安装 kubeadm，kubectl，kubelet 三个工具，然后使用 <code>kubeadm join</code> 命令加入即可。准备工作如下：</p> <ul><li>修改主机名</li> <li>配置软件源</li> <li>安装三个工具</li></ul> <p>由于之前章节已经操作完成，此处不再赘述。</p> <p>这里我们只需要借助于上面 master 节点 kubeadm 生成的命令将 slave 加入集群即可。</p> <p>分别在 kubernetes-node-01 和 kubernetes-node-02 节点上执行下面命令。</p> <h4 id="将-slave-加入到集群"><a href="#将-slave-加入到集群" class="header-anchor">#</a> 将 slave 加入到集群</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubeadm join 10.10.50.38:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:433b194618efc80f0cf6cdc5fa2fd8930c428c9bfb9e61b931a9cfe062b9c3b8 </span>

<span class="token comment"># 成功信息如下：</span>
W0422 <span class="token number">18</span>:54:12.792739   <span class="token number">68348</span> join.go:346<span class="token punctuation">]</span> <span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
        <span class="token punctuation">[</span>WARNING IsDockerSystemdCheck<span class="token punctuation">]</span>: detected <span class="token string">&quot;cgroupfs&quot;</span> as the Docker cgroup driver. The recommended driver is <span class="token string">&quot;systemd&quot;</span><span class="token builtin class-name">.</span> Please follow the guide at https://kubernetes.io/docs/setup/cri/
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Downloading configuration <span class="token keyword">for</span> the kubelet from the <span class="token string">&quot;kubelet-config-1.18&quot;</span> ConfigMap <span class="token keyword">in</span> the kube-system namespace
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to perform the TLS Bootstrap<span class="token punctuation">..</span>.

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this node <span class="token function">join</span> the cluster.

</code></pre></div><p>说明：</p> <ul><li>token
<ul><li>可以通过安装 master 时的日志查看 token 信息</li> <li>可以通过 <code>kubeadm token list</code> 命令打印出 token 信息</li> <li>如果 token 过期，可以使用 <code>kubeadm token create</code> 命令创建新的 token</li></ul></li> <li>discovery-token-ca-cert-hash
<ul><li>可以通过安装 master 时的日志查看 sha256 信息</li> <li>可以通过 <code>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</code> 命令查看 sha256 信息</li></ul></li></ul> <h4 id="验证是否成功-2"><a href="#验证是否成功-2" class="header-anchor">#</a> 验证是否成功</h4> <p>回到 master 服务器</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get nodes

<span class="token comment"># 可以看到如下信息证明 slave 加入 master 成功</span>
NAME                 STATUS     ROLES    AGE     VERSION
kubernetes-master    NotReady   master   18m     v1.18.2
kubernetes-node-01   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m31s   v1.18.2
kubernetes-node-02   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   35s     v1.18.2
</code></pre></div><blockquote><p>如果 slave 节点加入 master 时配置有问题可以在 slave 节点上使用 <code>kubeadm reset</code> 重置配置再使用 <code>kubeadm join</code> 命令重新加入即可。希望在 master 节点删除 node ，可以使用 <code>kubeadm delete nodes</code> 删除。</p></blockquote> <h5 id="查看-pod-状态"><a href="#查看-pod-状态" class="header-anchor">#</a> 查看 pod 状态</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod -n kube-system -o wide

<span class="token comment"># 信息如下：</span>
NAME                                        READY   STATUS    RESTARTS   AGE     IP             NODE                 NOMINATED NODE   READINESS GATES
coredns-7ff77c879f-8xfdq                    <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          19m     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>               <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
coredns-7ff77c879f-vfvtq                    <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          19m     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>               <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
etcd-kubernetes-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m     <span class="token number">10.10</span>.50.38    kubernetes-master    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-apiserver-kubernetes-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m     <span class="token number">10.10</span>.50.38    kubernetes-master    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-controller-manager-kubernetes-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m     <span class="token number">10.10</span>.50.38    kubernetes-master    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-proxy-p7qsf                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m     <span class="token number">10.10</span>.50.38    kubernetes-master    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-proxy-v4c4s                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m7s    <span class="token number">10.10</span>.50.221   kubernetes-node-01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-proxy-v7cxf                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m11s   <span class="token number">10.10</span>.50.135   kubernetes-node-02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
kube-scheduler-kubernetes-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m     <span class="token number">10.10</span>.50.38    kubernetes-master    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre></div><p>可以看出 coredns 尚未运行，此时我们还需要安装网络插件。</p> <h3 id="_3-5-kubernetes-网络配置"><a href="#_3-5-kubernetes-网络配置" class="header-anchor">#</a> 3.5 Kubernetes 网络配置</h3> <h4 id="概述-3"><a href="#概述-3" class="header-anchor">#</a> 概述</h4> <p>容器网络是容器选择连接到其他容器、主机和外部网络的机制。容器的 runtime 提供了各种网络模式，每种模式都会产生不同的体验。例如，Docker 默认情况下可以为容器配置以下网络：</p> <ul><li><strong>none：</strong> 将容器添加到一个容器专门的网络堆栈中，没有对外连接。</li> <li><strong>host：</strong> 将容器添加到主机的网络堆栈中，没有隔离。</li> <li><strong>default bridge：</strong> 默认网络模式。每个容器可以通过 IP 地址相互连接。</li> <li><strong>自定义网桥：</strong> 用户定义的网桥，具有更多的灵活性、隔离性和其他便利功能。</li></ul> <h4 id="什么是-cni"><a href="#什么是-cni" class="header-anchor">#</a> 什么是 CNI</h4> <p>CNI(Container Network Interface) 是一个标准的，通用的接口。在容器平台，Docker，Kubernetes，Mesos 容器网络解决方案 flannel，calico，weave。只要提供一个标准的接口，就能为同样满足该协议的所有容器平台提供网络功能，而 CNI 正是这样的一个标准接口协议。</p> <h4 id="kubernetes-中的-cni-插件"><a href="#kubernetes-中的-cni-插件" class="header-anchor">#</a> Kubernetes 中的 CNI 插件</h4> <p>CNI 的初衷是创建一个框架，用于在配置或销毁容器时动态配置适当的网络配置和资源。插件负责为接口配置和管理 IP 地址，并且通常提供与 IP 管理、每个容器的 IP 分配、以及多主机连接相关的功能。容器运行时会调用网络插件，从而在容器启动时分配 IP 地址并配置网络，并在删除容器时再次调用它以清理这些资源。</p> <p>运行时或协调器决定了容器应该加入哪个网络以及它需要调用哪个插件。然后，插件会将接口添加到容器网络命名空间中，作为一个 veth 对的一侧。接着，它会在主机上进行更改，包括将 veth 的其他部分连接到网桥。再之后，它会通过调用单独的 IPAM（IP地址管理）插件来分配 IP 地址并设置路由。</p> <p>在 Kubernetes 中，kubelet 可以在适当的时间调用它找到的插件，为通过 kubelet 启动的 pod进行自动的网络配置。</p> <p>Kubernetes 中可选的 CNI 插件如下：</p> <ul><li>Flannel</li> <li>Calico</li> <li>Canal</li> <li>Weave</li></ul> <h4 id="什么是-calico"><a href="#什么是-calico" class="header-anchor">#</a> 什么是 Calico</h4> <p>Calico 为容器和虚拟机提供了安全的网络连接解决方案，并经过了大规模生产验证（在公有云和跨数千个集群节点中），可与 Kubernetes，OpenShift，Docker，Mesos，DC / OS 和 OpenStack 集成。</p> <p>Calico 还提供网络安全规则的动态实施。使用 Calico 的简单策略语言，您可以实现对容器，虚拟机工作负载和裸机主机端点之间通信的细粒度控制。</p> <h4 id="安装网络插件-calico"><a href="#安装网络插件-calico" class="header-anchor">#</a> 安装网络插件 Calico</h4> <p>参考官方文档安装：https://docs.projectcalico.org/getting-started/kubernetes/quickstart</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre></div><h4 id="确定安装是否成功"><a href="#确定安装是否成功" class="header-anchor">#</a> 确定安装是否成功</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">watch</span> kubectl get pods --all-namespaces

<span class="token comment"># 需要等待所有状态为 Running，注意时间可能较久，3 - 5 分钟的样子</span>
NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-555fc8cc5c-2m6xd    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m55s
kube-system   calico-node-d6lnp                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m55s
kube-system   calico-node-gtgpk                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m55s
kube-system   calico-node-wpw8r                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m55s
kube-system   coredns-7ff77c879f-8xfdq                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   coredns-7ff77c879f-vfvtq                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   etcd-kubernetes-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   kube-apiserver-kubernetes-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   kube-controller-manager-kubernetes-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   kube-proxy-p7qsf                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
kube-system   kube-proxy-v4c4s                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28m
kube-system   kube-proxy-v7cxf                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          25m
kube-system   kube-scheduler-kubernetes-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42m
</code></pre></div><h4 id="解决-imagepullbackoff"><a href="#解决-imagepullbackoff" class="header-anchor">#</a> 解决 ImagePullBackOff</h4> <p>在使用 <code>watch kubectl get pods --all-namespaces</code> 命令观察 Pods 状态时如果出现 <code>ImagePullBackOff</code> 无法 Running 的情况，请尝试使用如下步骤处理：</p> <ul><li>Master 中删除 Nodes：<code>kubectl delete nodes</code></li> <li>Slave 中重置配置：<code>kubeadm reset</code></li> <li>Slave 重启计算机：<code>reboot</code></li> <li>Slave 重新加入集群：<code>kubeadm join</code></li></ul> <p>至此基本集群环境已部署完毕。</p> <h3 id="_3-6-第一个-kubernetes-容器"><a href="#_3-6-第一个-kubernetes-容器" class="header-anchor">#</a> 3.6 第一个 Kubernetes 容器</h3> <h4 id="检查组件运行状态"><a href="#检查组件运行状态" class="header-anchor">#</a> 检查组件运行状态</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 在 master 节点执行</span>
kubectl get cs

<span class="token comment"># 输出如下</span>
NAME                 STATUS    MESSAGE             ERROR
<span class="token comment"># 调度服务，主要作用是将 POD 调度到 Node</span>
scheduler            Healthy   ok                  
<span class="token comment"># 自动化修复服务，主要作用是 Node 宕机后自动修复 Node 回到正常的工作状态</span>
controller-manager   Healthy   ok                  
<span class="token comment"># 服务注册与发现</span>
etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span> 
</code></pre></div><h4 id="检查-master-状态"><a href="#检查-master-状态" class="header-anchor">#</a> 检查 Master 状态</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl cluster-info</span>

<span class="token comment"># 主节点状态</span>
Kubernetes master is running at https://10.10.50.38:6443
<span class="token comment"># DNS 状态</span>
KubeDNS is running at https://10.10.50.38:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">'kubectl cluster-info dump'</span><span class="token builtin class-name">.</span>
</code></pre></div><h4 id="检查-nodes-状态"><a href="#检查-nodes-状态" class="header-anchor">#</a> 检查 Nodes 状态</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl get nodes</span>

<span class="token comment"># 输出如下，STATUS 为 Ready 即为正常状态</span>
NAME                 STATUS   ROLES    AGE   VERSION
kubernetes-master    Ready    master   49m   v1.18.2
kubernetes-node-01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   34m   v1.18.2
kubernetes-node-02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   31m   v1.18.2
</code></pre></div><h4 id="运行第一个容器实例"><a href="#运行第一个容器实例" class="header-anchor">#</a> 运行第一个容器实例</h4> <p>下面是 Deployment 示例, 使用 yaml 声明式方式。创建一个 ReplicaSet 展开两个 <code>nginx</code> Pods：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># vi nginx-deployment.yaml</span>

<span class="token comment"># 内容如下</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl apply -f nginx-deployment.yaml</span>
</code></pre></div><h4 id="查看全部-pods-的状态"><a href="#查看全部-pods-的状态" class="header-anchor">#</a> 查看全部 Pods 的状态</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl get pods -o wide</span>

<span class="token comment"># 输出如下，需要等待一小段实践，STATUS 为 Running 即为运行成功</span>
NAME                                READY   STATUS    RESTARTS   AGE    IP               NODE                 NOMINATED NODE   READINESS GATES
nginx-deployment-6b474476c4-tpsdt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104s   <span class="token number">10.244</span>.140.69    kubernetes-node-02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-6b474476c4-wkvm2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          104s   <span class="token number">10.244</span>.141.195   kubernetes-node-01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><h4 id="查看已部署的服务"><a href="#查看已部署的服务" class="header-anchor">#</a> 查看已部署的服务</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl get deployment</span>
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           6m4s

</code></pre></div><h4 id="映射服务-让用户可以访问"><a href="#映射服务-让用户可以访问" class="header-anchor">#</a> 映射服务，让用户可以访问</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl expose deployment nginx-deployment --port=80 --type=LoadBalancer</span>
service/nginx-deployment exposed
</code></pre></div><h4 id="创建已发布服务"><a href="#创建已发布服务" class="header-anchor">#</a> 创建已发布服务</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>root@kubernetes-master:~<span class="token comment"># kubectl get services</span>
NAME               TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes         ClusterIP      <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        124m
<span class="token comment"># 由此可见，Nginx 服务已成功发布并将 80 端口映射为 32211</span>
nginx-deployment   LoadBalancer   <span class="token number">10.99</span>.226.196   <span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span>     <span class="token number">80</span>:32211/TCP   9s
</code></pre></div><h4 id="查看服务详情"><a href="#查看服务详情" class="header-anchor">#</a> 查看服务详情</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl describe service nginx-deployment</span>
Name:                     nginx-deployment
Namespace:                default
Labels:                   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Annotations:              <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:                 <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Type:                     LoadBalancer
IP:                       <span class="token number">10.99</span>.226.196
Port:                     <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:               <span class="token number">80</span>/TCP
NodePort:                 <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">32211</span>/TCP
Endpoints:                <span class="token number">10.244</span>.140.68:80,10.244.140.69:80,10.244.141.195:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><h4 id="验证是否成功-3"><a href="#验证是否成功-3" class="header-anchor">#</a> 验证是否成功</h4> <p>通过浏览器访问 Master 服务器:http://10.10.50.38:32211/</p> <p><img src="/study/assets/img/nginx.ec1d57d4.png" alt=""></p> <p>此时 Kubernetes 会以负载均衡的方式访问部署的 Nginx 服务，能够正常看到 Nginx 的欢迎页即表示成功。容器实际部署在其它 Node 节点上，通过访问 Node 节点的 IP:Port 也是可以的。</p> <h4 id="停止服务"><a href="#停止服务" class="header-anchor">#</a> 停止服务</h4> <ul><li>删除已部署的服务</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl delete deployment nginx-deployment</span>
<span class="token comment"># 输出如下</span>
deployment.extensions <span class="token string">&quot;nginx-deployment&quot;</span> deleted
</code></pre></div><ul><li>删除已发布的服务</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl delete service nginx</span>
<span class="token comment"># 输出如下</span>
<span class="token function">service</span> <span class="token string">&quot;nginx-deployment&quot;</span> deleted
</code></pre></div><h2 id="第-4-章-kubernetes-核心功能"><a href="#第-4-章-kubernetes-核心功能" class="header-anchor">#</a> 第 4 章 Kubernetes 核心功能</h2> <h3 id="_4-1-调度"><a href="#_4-1-调度" class="header-anchor">#</a> 4.1 调度</h3> <p>Kubernetes 可以把用户提交的容器放到 Kubernetes 管理的集群的某一台节点上去。Kubernetes 的调度器是执行这项能力的组件，它会观察正在被调度的这个容器的大小、规格。</p> <p>比如说它所需要的 CPU 以及它所需要的 memory，然后在集群中找一台相对比较空闲的机器来进行一次 placement，也就是一次放置的操作。在这个例子中，它可能会把红颜色的这个容器放置到第二个空闲的机器上，来完成一次调度的工作。</p> <p><img src="/study/assets/img/k8s_scheduler.45cf5f02.png" alt=""></p> <h3 id="_4-2-自动修复"><a href="#_4-2-自动修复" class="header-anchor">#</a> 4.2 自动修复</h3> <p>Kubernetes 有一个节点健康检查的功能，它会监测这个集群中所有的宿主机，当宿主机本身出现故障，或者软件出现故障的时候，这个节点健康检查会自动对它进行发现。</p> <p>下面 Kubernetes 会把运行在这些失败节点上的容器进行自动迁移，迁移到一个正在健康运行的宿主机上，来完成集群内容器的一个自动恢复。</p> <p><img src="/study/assets/img/k8s_fix.a11b20e0.png" alt=""></p> <h3 id="_4-3-水平伸缩"><a href="#_4-3-水平伸缩" class="header-anchor">#</a> 4.3 水平伸缩</h3> <p>Kubernetes 有业务负载检查的能力，它会监测业务上所承担的负载，如果这个业务本身的 CPU 利用率过高，或者响应时间过长，它可以对这个业务进行一次扩容。</p> <p>比如说在下面的例子中，黄颜色的过度忙碌，Kubernetes 就可以把黄颜色负载从一份变为三份。接下来，它就可以通过负载均衡把原来打到第一个黄颜色上的负载平均分到三个黄颜色的负载上去，以此来提高响应的时间。</p> <p><img src="/study/assets/img/k8s_expend.7ec5e67e.png" alt=""></p> <h2 id="第-5-章-kubernetes-架构"><a href="#第-5-章-kubernetes-架构" class="header-anchor">#</a> 第 5 章 Kubernetes 架构</h2> <p>Kubernetes 是一个开源的 <strong>Docker 容器编排系统</strong>，它可以调度计算集群的节点，动态管理上面的作业，保证它们按用户期望的状态运行。通过使用「labels」和「pods」的概念，Kubernetes 将应用按逻辑单元进行分组，方便管理和服务发现。</p> <p><img src="/study/assets/img/k8s_m_n.a1bf6ae9.png" alt=""></p> <p>Kubernetes 架构是一个比较典型的二层架构和 server-client 架构。Master 作为<strong>中央的管控节点</strong>，会去与 <strong>Node</strong> 进行一个连接。</p> <p>所有 UI 的、clients、这些 user 侧的组件，只会和 Master 进行连接，把希望的状态或者想执行的命令下发给 Master，Master 会把这些命令或者状态下发给相应的节点，进行最终的执行。</p> <p><img src="/study/assets/img/k8s_schedule1.3fd2911e.png" alt=""></p> <ul><li><strong>pods：</strong> 是一组紧密关联的容器集合，它们共享 IPC(进程间通信)、Network(网络) 和 UTS namespace(UTS 命名空间是 Linux 命名空间的一个子系统，主要作用是完成对容器 Hostname 和 Domain 的隔离，同时保存内核名称、版本、以及底层体系结构类型等信息)，是 Kubernetes 调度的基本单位。</li> <li><strong>labels：</strong> 键值对(key/value)标签，可以被关联到如 Pod 这样的对象上，主要作用是给用户一个直观的感受，比如这个 Pod 是用来放置数据库的。</li> <li><strong>GUI：</strong> 用户图形界面，可以是 Web 用户界面，比如使用 <code>kubernetes-dashboard</code> 组件，用户可以通过 Dashboard 在 Kubernetes 集群中部署容器化的应用，可以查看集群中应用的运行情况，同时也能够基于 Dashboard 创建或修改部署、任务、服务等 Kubernetes 的资源。通过部署向导，用户能够对部署进行扩缩容，进行滚动更新、重启 Pod 和部署新应用。当然，通过 Dashboard 也能够查看 Kubernetes 资源的状态。</li> <li><strong>kubectl：</strong> 用于管理 Kubernetes 集群的命令行工具。</li> <li><strong>kube-apiserver：</strong> 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制</li> <li><strong>Kubernetes Master：</strong> Kubernetes 集群主节点，主要由 <code>kube-apiserver</code>、<code>kube-scheduler</code>、<code>kube-controller-manager</code>、<code>etcd</code> 四个模块组成。</li> <li><strong>Kubernetes Node：</strong> Kubernetes 集群子节点，主要由 <code>kubelet</code>、<code>kube-proxy</code>、<code>runtime</code> 三个模块组成。</li> <li><strong>Image Registry：</strong> 镜像仓库，比如：Ducker HUB 或 Docker 私服。</li></ul> <h3 id="_5-1-master"><a href="#_5-1-master" class="header-anchor">#</a> 5.1 Master</h3> <p>Master 是 Cluster 的大脑，它的主要职责是调度，即决定将应用放在哪里运行。Master 运行 Linux 操作系统，可以是物理机或者虚拟机。为了实现高可用，可以运行多个 Master。</p> <p>Kubernetes 的 Master 包含四个主要的组件：API Server、Controller、Scheduler 以及 etcd。</p> <p><img src="/study/assets/img/k8s_m.61775f75.png" alt=""></p> <ul><li><p><strong>kube-apiserver</strong></p> <p>顾名思义是用来处理 API 操作的，Kubernetes 中所有的组件都会和 API Server 进行连接，组件与组件之间一般不进行独立的连接，都依赖于 API Server 进行消息的传送；</p></li> <li><p><strong>kube-controller-manager</strong></p> <p>用于执行大部分的集群层次的功能，它既执行生命周期功能(例如：命名空间创建和生命周期、事件垃圾收集、已终止垃圾收集、级联删除垃圾收集、node垃圾收集)，也执行API业务逻辑（例如：pod的弹性扩容）。控制管理提供自愈能力、扩容、应用生命周期管理、服务发现、路由、服务绑定和提供。Kubernetes默认提供Replication Controller、Node Controller、Namespace Controller、Service Controller、Endpoints Controller、Persistent Controller、DaemonSet Controller等控制器。</p></li> <li><p><strong>kube-scheduler</strong></p> <p>scheduler组件为容器自动选择运行的主机。依据请求资源的可用性，服务请求的质量等约束条件，scheduler监控未绑定的pod，并将其绑定至特定的node节点。Kubernetes也支持用户自己提供的调度器，Scheduler负责根据调度策略自动将Pod部署到合适Node中，调度策略分为预选策略和优选策略，Pod的整个调度过程分为两步：</p> <p>1）预选Node：遍历集群中所有的Node，按照具体的预选策略筛选出符合要求的Node列表。如没有Node符合预选策略规则，该Pod就会被挂起，直到集群中出现符合要求的Node。</p> <p>2）优选Node：预选Node列表的基础上，按照优选策略为待选的Node进行打分和排序，从中获取最优Node。</p></li> <li><p><strong>etcd：</strong> CoreOS 基于 Raft 开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）</p></li></ul> <h3 id="_5-2-node"><a href="#_5-2-node" class="header-anchor">#</a> 5.2 <strong>Node</strong></h3> <p>Node 的职责是运行容器应用。Node 由 Master 管理，Node 负责监控并汇报容器的状态，并根据 Master 的要求管理容器的生命周期。Node 运行在 Linux 操作系统，可以是物理机或者是虚拟机。</p> <p><img src="/study/assets/img/k8s_n.418c6820.png" alt=""></p> <ul><li><p><strong>Kubelet</strong></p> <p>Kubelet是Kubernetes中最主要的控制器，它是Pod和Node API的主要实现者，Kubelet负责驱动容器执行层。在Kubernetes中，应用容器彼此是隔离的，并且与运行其的主机也是隔离的，这是对应用进行独立解耦管理的关键点。</p> <p>在Kubernets中，Pod作为基本的执行单元，它可以拥有多个容器和存储数据卷，能够方便在每个容器中打包一个单一的应用，从而解耦了应用构建时和部署时的所关心的事项，已经能够方便在物理机/虚拟机之间进行迁移。API准入控制可以拒绝或者Pod，或者为Pod添加额外的调度约束，但是Kubelet才是Pod是否能够运行在特定Node上的最终裁决者，而不是scheduler或者DaemonSet。kubelet默认情况使用cAdvisor进行资源监控。<strong>负责管理Pod、容器、镜像、数据卷等，实现集群对节点的管理，并将容器的运行状态汇报给Kubernetes API Server</strong>。</p></li> <li><p><strong>Container Runtime</strong></p> <p>每一个Node都会运行一个Container Runtime，其负责下载镜像和运行容器。Kubernetes本身并不提供容器运行时环境，但提供了接口，可以插入所选择的容器运行时环境。kubelet使用Unix socket之上的gRPC框架与容器运行时进行通信，kubelet作为客户端，而CRI shim作为服务器。</p> <p><img src="/study/assets/img/kube_cr.ab209f7c.png" alt=""></p> <p>protocol buffers API提供两个gRPC服务，ImageService和RuntimeService。ImageService提供拉取、查看、和移除镜像的RPC。RuntimeSerivce则提供管理Pods和容器生命周期管理的RPC，以及与容器进行交互(exec/attach/port-forward)。容器运行时能够同时管理镜像和容器（例如：Docker和Rkt），并且可以通过同一个套接字提供这两种服务。在Kubelet中，这个套接字通过*–container-runtime-endpoint<em>和</em>–image-service-endpoint*字段进行设置。Kubernetes CRI支持的容器运行时包括docker、rkt、cri-o、frankti、kata-containers和clear-containers等, 默认的容器运行时为 Docker。</p></li> <li><p><strong>Kube proxy</strong></p> <p>基于一种公共访问策略（例如：负载均衡），服务提供了一种访问一群pod的途径。此方式通过创建一个虚拟的IP来实现，客户端能够访问此IP，并能够将服务透明的代理至Pod。每一个Node都会运行一个kube-proxy，kube proxy通过iptables规则引导访问至服务IP，并将重定向至正确的后端应用，通过这种方式kube-proxy提供了一个高可用的负载均衡解决方案。服务发现主要通过DNS实现。</p> <p>在Kubernetes中，kube proxy负责为Pod创建代理服务；引到访问至服务；并实现服务到Pod的路由和转发，以及通过应用的负载均衡。</p></li></ul> <h2 id="第-6-章-kubernetes-实战"><a href="#第-6-章-kubernetes-实战" class="header-anchor">#</a> 第 6 章 Kubernetes 实战</h2> <h3 id="_6-1-nginx-部署"><a href="#_6-1-nginx-部署" class="header-anchor">#</a> 6.1 Nginx 部署</h3> <h4 id="概述-4"><a href="#概述-4" class="header-anchor">#</a> 概述</h4> <p>我们知道通过 <code>run</code> 命令启动容器非常麻烦，Docker 提供了 Compose 为我们解决了这个问题。那 Kubernetes 是如何解决这个问题的呢？其实很简单，使用 <code>kubectl create</code> 命令就可以做到和 Compose 一样的效果了，该命令可以通过配置文件快速创建一个集群资源对象。</p> <h4 id="部署-deployment"><a href="#部署-deployment" class="header-anchor">#</a> 部署 Deployment</h4> <p>以 部署 nginx 为例</p> <p>创建一个名为<code>nginx-deployment.yml</code> 配置文件</p> <p>v1.16.0 之后</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># API 版本号：由 extensions/v1beta1 修改为 apps/v1</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 增加了选择器配置</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token comment"># 设置标签由 name 修改为 app</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>部署&amp;删除</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># kubectl create -f nginx-deployment.yml</span>
<span class="token comment"># kubecel delete -f nginx-deployment.yml</span>
</code></pre></div><h4 id="镜像拉取策略"><a href="#镜像拉取策略" class="header-anchor">#</a> 镜像拉取策略</h4> <p>支持三中 ImagePullPolicy</p> <ul><li>Always：不管镜像是否存在都会进行一次拉取</li> <li>Never：不管镜像是否存在都不会进行拉取</li> <li>IfNotPresent：如果镜像不存在，才会进行拉取</li></ul> <p>注意：</p> <ul><li>默认为 <code>IfNotPresent</code>, 但 <code>:latest</code> 标签的镜像默认为：<code>Always</code></li> <li>拉取镜像时 Docker 会进行校验, 如果镜像中的 MD5 码没有变, 则不会拉取镜像数据</li> <li>生产环境中应该尽可能避免使用：<code>latest</code> 标签, 而开发环境中可以借助 <code>:latest</code> 自动拉取最新的镜像。</li></ul> <h4 id="发布-service"><a href="#发布-service" class="header-anchor">#</a> 发布 Service</h4> <p>创建一个名为 <code>nginx-service.yml</code> 的配置文件</p> <p>v1.16.0 之后</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># API 版本号</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token comment"># 类型，如：Pod/ReplicationController/Deployment/Service/Ingress</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token comment"># 元数据</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># Kind 的名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>http
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token comment"># 暴露端口</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  	<span class="token comment">## Service 暴露的端口</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    	<span class="token comment">## Pod 上的端口，这里是将 Service 暴露的端口转发到 Pod 端口上</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token comment"># 类型</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
   <span class="token comment"># 标签选择器</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token comment"># 需要和上面部署的 Deployment 标签名对应</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
</code></pre></div><p>部署&amp;删除</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 部署</span>
kubectl create -f nginx-service.yml
<span class="token comment"># 删除</span>
kubectl delete -f nginx-service.yml
</code></pre></div><h4 id="验证是否生效"><a href="#验证是否生效" class="header-anchor">#</a> 验证是否生效</h4> <ul><li><p>查看 POD 列表</p> <div class="language-sh extra-class"><pre class="language-sh"><code>root@kubernetes-master:~<span class="token comment"># kubectl get pods</span>
NAME                        READY   STATUS              RESTARTS   AGE
nginx-app-d46f5678b-xkknk   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          29s
nginx-app-d46f5678b-zhs5c   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          29s
</code></pre></div></li> <li><p>查看 Deployment 列表</p> <div class="language-sh extra-class"><pre class="language-sh"><code>root@kubernetes-master:~<span class="token comment"># kubectl get deployment</span>
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
nginx-app   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           91s
</code></pre></div></li> <li><p>查看 Service 列表</p> <div class="language-sh extra-class"><pre class="language-sh"><code>root@kubernetes-master:~<span class="token comment"># kubectl get services</span>
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes   ClusterIP      <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        62m
nginx-http   LoadBalancer   <span class="token number">10.106</span>.102.66   <span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span>     <span class="token number">80</span>:32511/TCP   8s
</code></pre></div></li> <li><p>查看 Service 详情</p> <div class="language-sh extra-class"><pre class="language-sh"><code>root@kubernetes-master:~<span class="token comment"># kubectl describe service nginx-http</span>
Name:                     nginx-http
Namespace:                default
Labels:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:              <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:                 <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx
Type:                     LoadBalancer
IP:                       <span class="token number">10.106</span>.102.66
Port:                     <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">80</span>/TCP
TargetPort:               <span class="token number">80</span>/TCP
NodePort:                 <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">32511</span>/TCP
Endpoints:                <span class="token number">10.244</span>.140.65:80,10.244.140.66:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>通过浏览器访问</p> <p>通过浏览器访问 http://masterip:32511/ ，出现 Nginx 欢迎页即表示成功</p></li></ul> <h4 id="集成环境部署"><a href="#集成环境部署" class="header-anchor">#</a> 集成环境部署</h4> <p>也可以不区分配置文件，一次性部署 Deployment 和 Service，创建一个名为 <code>nginx.yml</code> 的配置文件，配置内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vi</span> nginx.yml
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># API 版本号：由 extensions/v1beta1 修改为 apps/v1</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 增加了选择器配置</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token comment"># 设置标签由 name 修改为 app</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token comment"># API 版本号</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token comment"># 类型，如：Pod/ReplicationController/Deployment/Service/Ingress</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token comment"># 元数据</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># Kind 的名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>http
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 暴露端口</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token comment">## Service 暴露的端口</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token comment">## Pod 上的端口，这里是将 Service 暴露的端口转发到 Pod 端口上</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token comment"># 类型</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
   <span class="token comment"># 标签选择器</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token comment"># 需要和上面部署的 Deployment 标签名对应</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx       
</code></pre></div><p>部署&amp;删除</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 部署</span>
kubectl create -f nginx.yml
<span class="token comment"># 删除</span>
kubectl delete -f nginx.yml
</code></pre></div><h4 id="修改默认的端口范围"><a href="#修改默认的端口范围" class="header-anchor">#</a> 修改默认的端口范围</h4> <p>Kubernetes 服务的 NodePort 默认端口范围是 30000-32767，在某些场合下，这个限制不太适用，我们可以自定义它的端口范围，操作步骤如下：</p> <p>编辑 <code>vi /etc/kubernetes/manifests/kube-apiserver.yaml</code> 配置文件，增加配置 <code>--service-node-port-range=2-65535</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token comment"># 在这里增加配置即可</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>node<span class="token punctuation">-</span>port<span class="token punctuation">-</span>range=2<span class="token punctuation">-</span><span class="token number">65535</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=192.168.141.150
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>allow<span class="token punctuation">-</span>privileged=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>mode=Node<span class="token punctuation">,</span>RBAC
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>admission<span class="token punctuation">-</span>plugins=NodeRestriction
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>bootstrap<span class="token punctuation">-</span>token<span class="token punctuation">-</span>auth=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>cafile=/etc/kubernetes/pki/etcd/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>certfile=/etc/kubernetes/pki/apiserver<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>client.crt
// 以下配置省略<span class="token punctuation">...</span>
</code></pre></div><p>使用 <code>docker ps</code> 命令找到 <code>kube-apiserver</code> 容器，再使用 <code>docker restart</code> 即可生效。</p> <h3 id="_6-2-ingress-统一访问入门"><a href="#_6-2-ingress-统一访问入门" class="header-anchor">#</a> 6.2 Ingress 统一访问入门</h3> <h4 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h4> <ul><li><strong>节点：</strong> Kubernetes 集群中的服务器</li> <li><strong>集群：</strong> Kubernetes 管理的一组服务器集合</li> <li><strong>边界路由器：</strong> 为局域网和 Internet 路由数据包的路由器，执行防火墙保护局域网络</li> <li><strong>集群网络：</strong> 遵循 Kubernetes 网络模型实现集群内的通信的具体实现，比如 Flannel 和 Calico</li> <li><strong>服务：</strong> Kubernetes 的服务 (Service) 是使用标签选择器标识的一组 Pod Service (Deployment)。 <strong>除非另有说明，否则服务的虚拟 IP 仅可在集群内部访问</strong></li></ul> <h4 id="内部访问方式-clusterip"><a href="#内部访问方式-clusterip" class="header-anchor">#</a> 内部访问方式 ClusterIP</h4> <p>ClusterIP 服务是 Kubernetes 的默认服务。它给你一个集群内的服务，集群内的其它应用都可以访问该服务。集群外部无法访问它。在某些场景下我们可以使用 Kubernetes 的 Proxy 模式来访问服务，比如调试服务时。</p> <p><img src="/study/assets/img/clusterIp.0d6a711b.png" alt=""></p> <h4 id="三种外部访问方式"><a href="#三种外部访问方式" class="header-anchor">#</a> 三种外部访问方式</h4> <h5 id="nodeport"><a href="#nodeport" class="header-anchor">#</a> NodePort</h5> <p>NodePort 服务是引导外部流量到你的服务的最原始方式。NodePort，正如这个名字所示，<strong>在所有节点（虚拟机）上开放一个特定端口</strong>，任何发送到该端口的流量都被转发到对应服务。</p> <p>NodePort 服务特征如下：</p> <ul><li>每个端口只能是一种服务</li> <li>端口范围只能是 30000-32767（可调）</li> <li>不在 YAML 配置文件中指定则会分配一个默认端口</li></ul> <blockquote><p><strong>建议：</strong> 不要在生产环境中使用这种方式暴露服务，大多数时候我们应该让 Kubernetes 来选择端口</p></blockquote> <p><img src="/study/assets/img/nodeport.9ab3653e.png" alt=""></p> <h5 id="loadbalancer"><a href="#loadbalancer" class="header-anchor">#</a> LoadBalancer</h5> <p>LoadBalancer 服务是暴露服务到 Internet 的标准方式。所有通往你指定的端口的流量都会被转发到对应的服务。它没有过滤条件，没有路由等。这意味着你几乎可以发送任何种类的流量到该服务，像 HTTP，TCP，UDP，WebSocket，gRPC 或其它任意种类。</p> <p><img src="/study/assets/img/loadbalancer.d795a82f.png" alt=""></p> <h5 id="ingress"><a href="#ingress" class="header-anchor">#</a> Ingress</h5> <p>Ingress 事实上不是一种服务类型。相反，它处于多个服务的前端，扮演着 “智能路由” 或者集群入口的角色。你可以用 Ingress 来做许多不同的事情，各种不同类型的 Ingress 控制器也有不同的能力。它允许你基于路径或者子域名来路由流量到后端服务。</p> <p>Ingress 可能是暴露服务的最强大方式，但同时也是最复杂的。Ingress 控制器有各种类型，包括 Google Cloud Load Balancer， Nginx，Contour，Istio，等等。它还有各种插件，比如 cert-manager (它可以为你的服务自动提供 SSL 证书)/</p> <p>如果你想要使用同一个 IP 暴露多个服务，这些服务都是使用相同的七层协议（典型如 HTTP），你还可以获取各种开箱即用的特性（比如 SSL、认证、路由等等）</p> <p><img src="/study/assets/img/ingress.8320ad58.png" alt=""></p> <h4 id="什么是-ingress"><a href="#什么是-ingress" class="header-anchor">#</a> 什么是 Ingress</h4> <p>通常情况下，Service 和 Pod 的 IP 仅可在集群内部访问。集群外部的请求需要通过负载均衡转发到 Service 在 Node 上暴露的 NodePort 上，然后再由 kube-proxy 通过边缘路由器 (edge router) 将其转发给相关的 Pod 或者丢弃。而 Ingress 就是为进入集群的请求提供路由规则的集合</p> <p>Ingress 可以给 Service 提供集群外部访问的 URL、负载均衡、SSL 终止、HTTP 路由等。为了配置这些 Ingress 规则，集群管理员需要部署一个 Ingress Controller，它监听 Ingress 和 Service 的变化，并根据规则配置负载均衡并提供访问入口。</p> <h4 id="使用-nginx-ingress-controller"><a href="#使用-nginx-ingress-controller" class="header-anchor">#</a> 使用 Nginx Ingress Controller</h4> <p>本次实践的主要目的就是将入口统一，不再通过 LoadBalancer 等方式将端口暴露出来，而是使用 Ingress 提供的反向代理负载均衡功能作为我们的唯一入口。通过以下步骤操作仔细体会。</p> <blockquote><p><strong>注意：</strong> 下面包含资源配置的步骤都是自行创建 YAML 配置文件通过 <code>kubectl create -f</code> 和 <code>kubectl delete -f</code> 部署和删除</p></blockquote> <h5 id="部署-tomcat"><a href="#部署-tomcat" class="header-anchor">#</a> 部署 Tomcat</h5> <p>部署 Tomcat 但仅允许在内网访问，我们要通过 Ingress 提供的反向代理功能路由到 Tomcat 之上</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>http
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token comment"># ClusterIP, NodePort, LoadBalancer</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
</code></pre></div><h5 id="安装-nginx-ingress-controller"><a href="#安装-nginx-ingress-controller" class="header-anchor">#</a> 安装 Nginx Ingress Controller</h5> <p>Ingress Controller 有许多种，我们选择最熟悉的 Nginx 来处理请求，其它可以参考 <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p>下载 Nginx Ingress Controller 配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span>
</code></pre></div></li> <li><p>修改配置文件，找到配置如下位置 (搜索 <code>serviceAccountName</code>) 在下面增加一句 <code>hostNetwork: true</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 可以部署多个实例</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">&quot;10254&quot;</span>
        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>serviceaccount
      <span class="token comment"># 增加 hostNetwork: true，意思是开启主机网络模式，暴露 Nginx 服务端口 80</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller
          <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/kubernetes<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>0.24.1
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>configuration
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/tcp<span class="token punctuation">-</span>services
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>udp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/udp<span class="token punctuation">-</span>services
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>publish<span class="token punctuation">-</span>service=$(POD_NAMESPACE)/ingress<span class="token punctuation">-</span>nginx
// 以下代码省略<span class="token punctuation">...</span>
</code></pre></div></li> <li><p>部署 Ingress</p> <p>Ingress 翻译过来是入口的意思，说白了就是个 API 网关（想想之前学的 Zuul 和 Spring Cloud Gateway）</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>web
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定 Ingress Controller 的类型</span>
    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> <span class="token string">&quot;nginx&quot;</span>
    <span class="token comment"># 指定我们的 rules 的 path 可以使用正则表达式</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/use-regex</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token comment"># 连接超时时间，默认为 5s</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">&quot;600&quot;</span>
    <span class="token comment"># 后端服务器回转数据超时时间，默认为 60s</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span class="token punctuation">:</span> <span class="token string">&quot;600&quot;</span>
    <span class="token comment"># 后端服务器响应超时时间，默认为 60s</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token string">&quot;600&quot;</span>
    <span class="token comment"># 客户端上传文件，最大大小，默认为 20m</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="token punctuation">:</span> <span class="token string">&quot;10m&quot;</span>
    <span class="token comment"># URL 重写</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 路由规则</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># 主机名，只能是域名，修改为你自己的</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> k8s.test.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span>
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token comment"># 后台部署的 Service Name，与上面部署的 Tomcat 对应</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>http
          <span class="token comment"># 后台部署的 Service Port，与上面部署的 Tomcat 对应</span>
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div></li></ul> <h4 id="验证是否成功-4"><a href="#验证是否成功-4" class="header-anchor">#</a> 验证是否成功</h4> <h5 id="查看-tomcat"><a href="#查看-tomcat" class="header-anchor">#</a> 查看 Tomcat</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get deployment

<span class="token comment"># 输出如下</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
tomcat-app   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           88m
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get <span class="token function">service</span>

<span class="token comment"># 输出如下</span>
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
kubernetes    ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    2d5h
tomcat-http   ClusterIP   <span class="token number">10.97</span>.222.179   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   89m
</code></pre></div><h5 id="查看-nginx-ingress-controller"><a href="#查看-nginx-ingress-controller" class="header-anchor">#</a> 查看 Nginx Ingress Controller</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get pods -n ingress-nginx -o wide

<span class="token comment"># 输出如下，注意下面的 IP 地址，就是我们实际访问地址</span>
NAME                                        READY   STATUS    RESTARTS   AGE   IP                NODE                 NOMINATED NODE   READINESS GATES
nginx-ingress-controller-76f9fddcf8-vzkm5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61m   <span class="token number">192.168</span>.141.160   kubernetes-node-01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><h5 id="查看-ingress"><a href="#查看-ingress" class="header-anchor">#</a> 查看 Ingress</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get ingress

<span class="token comment"># 输出如下</span>
NAME        HOSTS          ADDRESS   PORTS   AGE
nginx-web   k8s.test.com             <span class="token number">80</span>      61m
</code></pre></div><h4 id="测试访问"><a href="#测试访问" class="header-anchor">#</a> 测试访问</h4> <p>成功代理到 Tomcat 即表示成功</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 不设置 Hosts 的方式请求地址，下面的 IP 和 Host 均在上面有配置</span>
<span class="token function">curl</span> -v http://192.168.141.160 -H <span class="token string">'host: k8s.test.com'</span>
</code></pre></div><h4 id="扩展阅读"><a href="#扩展阅读" class="header-anchor">#</a> 扩展阅读</h4> <h5 id="解决无法下载-quay-io-地址镜像的问题"><a href="#解决无法下载-quay-io-地址镜像的问题" class="header-anchor">#</a> 解决无法下载 quay.io 地址镜像的问题</h5> <p>在实际操作中我们需要拉取 Nginx Ingress 镜像，默认地址为：<code>quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.1</code>，由于国内网络等原因，可能无法正常拉取该镜像，此时我们可以使用 Azure 提供的镜像加速器，将 <code>quay.io</code> 替换为 <code>quay.azk8s.cn</code>，其它类似地址的镜像无法下载均可尝试使用该方式解决，替换后的地址如：<code>quay.azk8s.cn/kubernetes-ingress-controller/nginx-ingress-controller:0.24.1</code></p> <h3 id="_6-3-kubernetes-准备数据卷-持久化"><a href="#_6-3-kubernetes-准备数据卷-持久化" class="header-anchor">#</a> 6.3 Kubernetes 准备数据卷（持久化）</h3> <h4 id="概述-5"><a href="#概述-5" class="header-anchor">#</a> 概述</h4> <p>在 Docker 中就有数据卷的概念，当容器删除时，数据也一起会被删除，想要持久化使用数据，需要把主机上的目录挂载到 Docker 中去，在 K8S 中，数据卷是通过 Pod 实现持久化的，如果 Pod 删除，数据卷也会一起删除，k8s 的数据卷是 docker 数据卷的扩展，K8S 适配各种存储系统，包括本地存储 EmptyDir，HostPath， 网络存储（NFS，GlusterFS，PV/PVC）等。</p> <p>我们以部署 MySQL8 为例，采用 <strong>NFS + PV/PVC</strong> 网络存储方案实现我们的 Kubernetes 数据持久化。</p> <h4 id="什么是-nfs"><a href="#什么是-nfs" class="header-anchor">#</a> 什么是 NFS</h4> <p>NFS 是 Network File System 的简写，即网络文件系统，NFS 是 FreeBSD 支持的文件系统中的一种。NFS 基于 RPC (Remote Procedure Call) 远程过程调用实现，其允许一个系统在网络上与它人共享目录和文件。通过使用 NFS，用户和程序就可以像访问本地文件一样访问远端系统上的文件。NFS 是一个非常稳定的，可移植的网络文件系统。具备可扩展和高性能等特性，达到了企业级应用质量标准。由于网络速度的增加和延迟的降低，NFS 系统一直是通过网络提供文件系统服务的有竞争力的选择 。</p> <h5 id="nfs-原理"><a href="#nfs-原理" class="header-anchor">#</a> NFS 原理</h5> <p>NFS 使用 RPC (Remote Procedure Call) 的机制进行实现，RPC 使得客户端可以调用服务端的函数。同时，由于有 VFS 的存在，客户端可以像使用其它普通文件系统一样使用 NFS 文件系统。经由操作系统的内核，将 NFS 文件系统的调用请求通过 TCP/IP 发送至服务端的 NFS 服务。NFS 服务器执行相关的操作，并将操作结果返回给客户端。</p> <p><img src="/study/assets/img/nfs.a635dab3.jpg" alt=""></p> <h5 id="nfs-服务主要进程"><a href="#nfs-服务主要进程" class="header-anchor">#</a> NFS 服务主要进程</h5> <ul><li>rpc.nfsd：最主要的 NFS 进程，管理客户端是否可登录</li> <li>rpc.mountd：挂载和卸载 NFS 文件系统，包括权限管理</li> <li>rpc.lockd：非必要，管理文件锁，避免同时写出错</li> <li>rpc.statd：非必要，检查文件一致性，可修复文件</li></ul> <h5 id="nfs-的关键工具"><a href="#nfs-的关键工具" class="header-anchor">#</a> NFS 的关键工具</h5> <ul><li>主要配置文件：<code>/etc/exports</code></li> <li>NFS 文件系统维护命令：<code>/usr/bin/exportfs</code></li> <li>共享资源的日志文件：<code>/var/lib/nfs/*tab</code></li> <li>客户端查询共享资源命令：<code>/usr/sbin/showmount</code></li> <li>端口配置：<code>/etc/sysc</code></li></ul> <h5 id="nfs-服务端配置"><a href="#nfs-服务端配置" class="header-anchor">#</a> NFS 服务端配置</h5> <p>在 NFS 服务器端的主要配置文件为 <code>/etc/exports</code> 时，通过此配置文件可以设置共享文件目录。每条配置记录由 NFS 共享目录、NFS 客户端地址和参数这 3 部分组成，格式如下：</p> <div class="language-text extra-class"><pre class="language-text"><code>[NFS 共享目录] [NFS 客户端地址 1 (参数 1, 参数 2, 参数 3……)] [客户端地址 2 (参数 1, 参数 2, 参数 3……)]
</code></pre></div><ul><li>NFS 共享目录：服务器上共享出去的文件目录</li> <li>NFS 客户端地址：允许其访问的 NFS 服务器的客户端地址，可以是客户端 IP 地址，也可以是一个网段 (192.168.141.0/24)</li> <li>访问参数：括号中逗号分隔项，主要是一些权限选项</li></ul> <h5 id="访问权限参数"><a href="#访问权限参数" class="header-anchor">#</a> 访问权限参数</h5> <table><thead><tr><th>序号</th> <th>选项</th> <th>描述</th></tr></thead> <tbody><tr><td>1</td> <td>ro</td> <td>客户端对于共享文件目录为只读权限。默认</td></tr> <tr><td>2</td> <td>rw</td> <td>客户端对于共享文件目录具有读写权限</td></tr></tbody></table> <h5 id="用户映射参数"><a href="#用户映射参数" class="header-anchor">#</a> 用户映射参数</h5> <table><thead><tr><th>序号</th> <th>选项</th> <th>描述</th></tr></thead> <tbody><tr><td>1</td> <td>root_squash</td> <td>使客户端使用 root 账户访冋时，服务器映射为服务器本地的匿名账号</td></tr> <tr><td>2</td> <td>no_root_squash</td> <td>客户端连接服务端时如果使用的是 root，那么也拥有对服务端分享的目录的 root 权限</td></tr> <tr><td>3</td> <td>all_squash</td> <td>将所有客户端用户请求映射到匿名用户或用户组（nfsnobody)</td></tr> <tr><td>4</td> <td>no_all_squash</td> <td>与上相反。默认</td></tr> <tr><td>5</td> <td>anonuid=xxx</td> <td>将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户(UID=xxx)</td></tr> <tr><td>6</td> <td>anongid=xxx</td> <td>将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户(GUI=xxx)</td></tr></tbody></table> <h5 id="其它配置参数"><a href="#其它配置参数" class="header-anchor">#</a> 其它配置参数</h5> <table><thead><tr><th>序号</th> <th>选项</th> <th>描述</th></tr></thead> <tbody><tr><td>1</td> <td>sync</td> <td>同步写操作，数据写入存储设备后返回成功信息。默认</td></tr> <tr><td>2</td> <td>async</td> <td>异步写提作，数据在未完全写入存储设备前就返回成功信息，实际还在内存，</td></tr> <tr><td>3</td> <td>wdelay</td> <td>延迟写入选项，将多个写提请求合并后写入硬盘，减少 I/O 次数， NFS 非正常关闭数据可能丢失。默认</td></tr> <tr><td>4</td> <td>no_wdelay</td> <td>与上相反，不与 async 同时生效，如果 NFS 服务器主要收到小且不相关的请求，该选项实际会降低性能</td></tr> <tr><td>5</td> <td>subtree</td> <td>若输出目录是一个子目录，则 NFS 服务器将检查其父目录的权限。默认</td></tr> <tr><td>6</td> <td>no_subtree</td> <td>即使输出目录是一个子目录， NFS 服务器也不检查其父目录的权限，这样可以提高效率</td></tr> <tr><td>7</td> <td>secure</td> <td>限制客户端只能从小于 1024 的 TCP/IP 端口连接 NFS 服务器。默认</td></tr> <tr><td>8</td> <td>insecure</td> <td>允许客户端从大于 1024 的 TCP/IP 端口连接服务器</td></tr></tbody></table> <h4 id="安装-nfs-服务器"><a href="#安装-nfs-服务器" class="header-anchor">#</a> 安装 NFS 服务器</h4> <p>由于 NFS 是一套分布式文件系统，我们再创建一台独立的虚拟机作为我们 NFS 服务端，配置如下</p> <table><thead><tr><th>主机名</th> <th>IP</th> <th>系统</th> <th>CPU/内存</th> <th>磁盘</th></tr></thead> <tbody><tr><td>kubernetes-volumes</td> <td>192.168.141.140</td> <td>Ubuntu Server 18.04</td> <td>2核2G</td> <td>20G</td></tr></tbody></table> <ul><li>创建一个目录作为共享文件目录</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /usr/local/kubernetes/volumes
</code></pre></div><ul><li>给目录增加读写权限</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">chmod</span> a+rw /usr/local/kubernetes/volumes
</code></pre></div><ul><li>安装 NFS 服务端</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">apt-get</span> update
<span class="token function">apt-get</span> <span class="token function">install</span> -y nfs-kernel-server
</code></pre></div><ul><li>配置 NFS 服务目录，打开文件 <code>vi /etc/exports</code>，在尾部新增一行，内容如下
<ul><li><code>/usr/local/kubernetes/volumes</code>：作为服务目录向客户端开放</li> <li>*：表示任何 IP 都可以访问</li> <li>rw：读写权限</li> <li>sync：同步权限</li> <li>no_subtree_check：表示如果输出目录是一个子目录，NFS 服务器不检查其父目录的权限</li></ul></li></ul> <div class="language-text extra-class"><pre class="language-text"><code>/usr/local/kubernetes/volumes *(rw,sync,no_subtree_check)
</code></pre></div><ul><li>重启服务，使配置生效</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>/etc/init.d/nfs-kernel-server restart
</code></pre></div><h4 id="安装-nfs-客户端"><a href="#安装-nfs-客户端" class="header-anchor">#</a> 安装 NFS 客户端</h4> <p>安装客户端的目的是验证是否可以上传文件到服务端，安装命令如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">apt-get</span> <span class="token function">install</span> -y nfs-common
</code></pre></div><ul><li>创建 NFS 客户端挂载目录</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /usr/local/kubernetes/volumes-mount
</code></pre></div><ul><li>将 NFS 服务器的 <code>/usr/local/kubernetes/volumes</code> 目录挂载到 NFS 客户端的 <code>/usr/local/kubernetes/volumes-mount</code> 目录</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mount</span> <span class="token number">192.168</span>.141.140:/usr/local/kubernetes/volumes /usr/local/kubernetes/volumes-mount
</code></pre></div><ul><li>使用 <code>df</code> 命令查看挂载信息</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">df</span>

<span class="token comment"># 输出如下</span>
Filesystem                                    1K-blocks    Used Available Use% Mounted on
udev                                             <span class="token number">977556</span>       <span class="token number">0</span>    <span class="token number">977556</span>   <span class="token number">0</span>% /dev
tmpfs                                            <span class="token number">201732</span>    <span class="token number">1252</span>    <span class="token number">200480</span>   <span class="token number">1</span>% /run
/dev/mapper/ubuntu--vg-ubuntu--lv              <span class="token number">19475088</span> <span class="token number">5490916</span>  <span class="token number">12971848</span>  <span class="token number">30</span>% /
tmpfs                                           <span class="token number">1008648</span>       <span class="token number">0</span>   <span class="token number">1008648</span>   <span class="token number">0</span>% /dev/shm
tmpfs                                              <span class="token number">5120</span>       <span class="token number">0</span>      <span class="token number">5120</span>   <span class="token number">0</span>% /run/lock
tmpfs                                           <span class="token number">1008648</span>       <span class="token number">0</span>   <span class="token number">1008648</span>   <span class="token number">0</span>% /sys/fs/cgroup
/dev/loop0                                        <span class="token number">90624</span>   <span class="token number">90624</span>         <span class="token number">0</span> <span class="token number">100</span>% /snap/core/6964
/dev/loop1                                        <span class="token number">93184</span>   <span class="token number">93184</span>         <span class="token number">0</span> <span class="token number">100</span>% /snap/core/6350
/dev/sda2                                        <span class="token number">999320</span>  <span class="token number">214252</span>    <span class="token number">716256</span>  <span class="token number">24</span>% /boot
tmpfs                                            <span class="token number">201728</span>       <span class="token number">0</span>    <span class="token number">201728</span>   <span class="token number">0</span>% /run/user/0
<span class="token comment"># 有此输出表示挂载成功</span>
<span class="token number">193.192</span>.168.141.140:/usr/local/kubernetes/volumes  <span class="token number">19475200</span> <span class="token number">5490944</span>  <span class="token number">12972032</span>  <span class="token number">30</span>% /usr/local/kubernetes/volumes-mount
</code></pre></div><h4 id="验证-nfs-服务"><a href="#验证-nfs-服务" class="header-anchor">#</a> 验证 NFS 服务</h4> <ul><li>测试文件上传</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ip</span> addr <span class="token operator">&gt;</span> /usr/local/kubernetes/volumes-mount/test.txt
</code></pre></div><ul><li>查看 <code>/usr/local/kubernetes/volumes</code> 目录下是否有 <code>test.txt</code> 文件，有则表示成功</li></ul> <h4 id="取消-nfs-客户端挂载"><a href="#取消-nfs-客户端挂载" class="header-anchor">#</a> 取消 NFS 客户端挂载</h4> <blockquote><p><strong>注意：</strong> 不要直接在挂载目录下执行，否则会报错</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">umount</span> /usr/local/kubernetes/volumes-mount
</code></pre></div><h3 id="_6-4-kubernetes-实现数据持久化"><a href="#_6-4-kubernetes-实现数据持久化" class="header-anchor">#</a> 6.4 Kubernetes 实现数据持久化</h3> <h4 id="概述-6"><a href="#概述-6" class="header-anchor">#</a> 概述</h4> <p>存储管理与计算管理是两个不同的问题。Persistent Volume 子系统，对存储的供应和使用做了抽象，以 API 形式提供给管理员和用户使用。要完成这一任务，我们引入了两个新的 API 资源：<strong>Persistent Volume（持久卷）</strong> 和 <strong>Persistent Volume Claim（持久卷消费者）</strong>。</p> <p>Persistent Volume（PV）是集群之中的一块网络存储。跟 Node 一样，也是集群的资源。PV 跟 Volume (卷) 类似，不过会有独立于 Pod 的生命周期。这一 API 对象包含了存储的实现细节，例如 NFS、iSCSI 或者其他的云提供商的存储系统。Persistent Volume Claim (PVC) 是用户的一个请求。跟 Pod 类似，Pod 消费 Node 的资源，PVC 消费 PV 的资源。Pod 能够申请特定的资源（CPU 和内存）；Claim 能够请求特定的尺寸和访问模式（例如可以加载一个读写，以及多个只读实例）</p> <h4 id="pv-与-pvc"><a href="#pv-与-pvc" class="header-anchor">#</a> PV 与 PVC</h4> <p>PV 是集群的资源。PVC 是对这一资源的请求，也是对资源的所有权的检验。PV 和 PVC 之间的互动遵循如下的生命周期。</p> <ul><li><strong>供应：</strong> 集群管理员会创建一系列的 PV。这些 PV 包含了为集群用户提供的真实存储资源，它们可利用 Kubernetes API 来消费。</li> <li><strong>绑定：</strong> 用户创建一个包含了容量和访问模式的持久卷申请。Master 会监听 PVC 的产生，并尝试根据请求内容查找匹配的 PV，并把 PV 和 PVC 进行绑定。用户能够获取满足需要的资源，并且在使用过程中可能超出请求数量。如果找不到合适的卷，这一申请就会持续处于非绑定状态，一直到出现合适的 PV。例如一个集群准备了很多的 50G 大小的持久卷，（虽然总量足够）也是无法响应 100G 的申请的，除非把 100G 的 PV 加入集群。</li> <li><strong>使用：</strong> Pod 把申请作为卷来使用。集群会通过 PVC 查找绑定的 PV，并 Mount 给 Pod。对于支持多种访问方式的卷，用户在使用 PVC 作为卷的时候，可以指定需要的访问方式。一旦用户拥有了一个已经绑定的 PVC，被绑定的 PV 就归该用户所有了。用户的 Pods 能够通过在 Pod 的卷中包含的 PVC 来访问他们占有的 PV。</li> <li><strong>释放：</strong> 当用户完成对卷的使用时，就可以利用 API 删除 PVC 对象了，而且他还可以重新申请。删除 PVC 后，对应的卷被视为 “被释放”，但是这时还不能给其他的 PVC 使用。之前的 PVC 数据还保存在卷中，要根据策略来进行后续处理。</li> <li><strong>回收：</strong> PV 的回收策略向集群阐述了在 PVC 释放卷的时候，应如何进行后续工作。目前可以采用三种策略：保留，回收或者删除。保留策略允许重新申请这一资源。在持久卷能够支持的情况下，删除策略会同时删除持久卷以及 AWS EBS/GCE PD 或者 Cinder 卷中的存储内容。如果插件能够支持，回收策略会执行基础的擦除操作（<code>rm -rf /thevolume/*</code>），这一卷就能被重新申请了。</li></ul> <h4 id="定义-pv"><a href="#定义-pv" class="header-anchor">#</a> 定义 PV</h4> <h5 id="持久卷插件"><a href="#持久卷插件" class="header-anchor">#</a> 持久卷插件</h5> <p>持久卷是以插件方式实现的，目前支持的插件如下：</p> <ul><li>GCEPersistentDisk</li> <li>AWSElasticBlockStore</li> <li><strong>NFS（我们采用的是该方案）</strong></li> <li>iSCSI</li> <li>RBD (Ceph Block Device)</li> <li>Glusterfs</li> <li>HostPath (单节点测试使用)</li> <li>本地持久卷</li></ul> <h5 id="yaml-配置"><a href="#yaml-配置" class="header-anchor">#</a> YAML 配置</h5> <p>创建一个名为 <code>nfs-pv-mysql.yml</code> 的配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 设置容量</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token comment"># 访问模式</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token comment"># 该卷能够以读写模式被多个节点同时加载</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token comment"># 回收策略，这里是基础擦除 `rm-rf/thevolume/*`</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token comment"># NFS 服务端配置的路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/usr/local/kubernetes/volumes&quot;</span>
    <span class="token comment"># NFS 服务端地址</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.141.140
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 部署</span>
kubectl create -f nfs-pv-mysql.yml
<span class="token comment"># 删除</span>
kubectl delete -f nfs-pv-mysql.yml
<span class="token comment"># 查看</span>
kubectl get <span class="token function">pv</span>
NAME           CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
nfs-pv-mysql   5Gi        RWX            Recycle          Available                                   29m
</code></pre></div><h5 id="配置说明"><a href="#配置说明" class="header-anchor">#</a> 配置说明</h5> <ul><li><p><strong>Capacity（容量）</strong></p> <p>一般来说，PV 会指定存储容量。这里需要使用 PV 的 capcity 属性。目前存储大小是唯一一个能够被申请的指标，今后会加入更多属性，例如 IOPS，吞吐能力等。</p></li> <li><p><strong>AccessModes（访问模式）</strong></p> <p>只要资源提供者支持，持久卷能够被用任何方式加载到主机上。每种存储都会有不同的能力，每个 PV 的访问模式也会被设置成为该卷所支持的特定模式。例如 NFS 能够支持多个读写客户端，但是某个 NFS PV 可能会在服务器上以只读方式使用。每个 PV 都有自己的一系列的访问模式，这些访问模式取决于 PV 的能力。访问模式的可选范围如下：</p> <ul><li>ReadWriteOnce：该卷能够以读写模式被加载到一个节点上</li> <li>ReadOnlyMany：该卷能够以只读模式加载到多个节点上</li> <li>ReadWriteMany：该卷能够以读写模式被多个节点同时加载</li></ul> <p>在 CLI 下，访问模式缩写为：</p> <ul><li>RWO：ReadWriteOnce</li> <li>ROX：ReadOnlyMany</li> <li>RWX：ReadWriteMany</li></ul> <p>另外，一个卷不论支持多少种访问模式，同时只能以一种访问模式加载。例如一个 GCE Persistent Disk 既能支持 ReadWriteOnce，也能支持 ReadOnlyMany。</p></li> <li><p><strong>RecyclingPolicy（回收策略）</strong></p> <p>当前的回收策略可选值包括：</p> <ul><li>Retain：人工重新申请</li> <li>Recycle：基础擦除（<code>rm-rf/thevolume/*</code>）</li> <li>Delete：相关的存储资产例如 AWS EBS，GCE PD 或者 OpenStack Cinder 卷一并删除</li></ul> <p>目前，只有 NFS 和 HostPath 支持 Recycle 策略，AWS EBS、GCE PD 以及 Cinder 卷支持 Delete 策略。</p></li> <li><p><strong>阶段（Phase）</strong></p> <p>一个卷会处于如下阶段之一：</p> <ul><li>Available：可用资源，尚未被绑定到 PVC 上</li> <li>Bound：该卷已经被绑定</li> <li>Released：PVC 已经被删除，但该资源尚未被集群回收</li> <li>Failed：该卷的自动回收过程失败</li></ul></li></ul> <h4 id="定义-pvc"><a href="#定义-pvc" class="header-anchor">#</a> 定义 PVC</h4> <p>创建一个名为 <code>nfs-pvc-mysql-myshop.yml</code> 的配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>myshop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token comment"># 需要使用和 PV 一致的访问模式</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token comment"># 按需分配资源</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
     <span class="token key atrule">requests</span><span class="token punctuation">:</span>
       <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 部署</span>
kubectl create -f nfs-pvc-mysql-myshop.yml
<span class="token comment"># 删除</span>
kubectl delete -f nfs-pvc-mysql-myshop.yml
<span class="token comment"># 查看</span>
kubectl get pvc
</code></pre></div><h4 id="部署-mysql8"><a href="#部署-mysql8" class="header-anchor">#</a> 部署 MySQL8</h4> <blockquote><p><strong>注意：</strong> 要确保每台 Node 都安装了 NFS 客户端，<code>apt-get install -y nfs-common</code></p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
          <span class="token comment"># 只有镜像不存在时，才会进行镜像拉取</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token comment"># 同 Docker 配置中的 environment</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
          <span class="token comment"># 容器中的挂载目录</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment"># 挂载到数据卷</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>myshop
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
</code></pre></div><h5 id="解决权限问题"><a href="#解决权限问题" class="header-anchor">#</a> 解决权限问题</h5> <p>当你使用 <code>kubectl create -f</code> 部署后，你会发现 Pod 状态为 Error，容器无法正常启动的情况，我们可以使用 <code>kubectl logs</code> 看到一条日志</p> <div class="language-text extra-class"><pre class="language-text"><code>chown: changing ownership of '/var/lib/mysql/': Operation not permitted
</code></pre></div><p>解决方案是在 NFS 服务端配置中增加一个参数 <code>no_root_squash</code>，即将配置修改为：<code>/usr/local/kubernetes/volumes *(rw,sync,no_subtree_check,no_root_squash)</code></p> <h5 id="测试运行"><a href="#测试运行" class="header-anchor">#</a> 测试运行</h5> <p>部署成功后可以使用 <code>kubectl get service</code> 查看我们 MySQL 的运行端口，再使用连接工具连接会报如下错误</p> <p><img src="/study/assets/img/mysql_error.b660ec32.png" alt=""></p> <p>意思为无法使用密码的方式登录，在 Docker 部署时我们可以在 YAML 中配置相关参数解决这个问题；下一节我们讲解在 Kubernetes 中采用 <strong>ConfigMap</strong> 的方式配置 MySQL</p> <h3 id="_6-5-kubernetes-configmap"><a href="#_6-5-kubernetes-configmap" class="header-anchor">#</a> 6.5 Kubernetes ConfigMap</h3> <h4 id="概述-7"><a href="#概述-7" class="header-anchor">#</a> 概述</h4> <p>ConfigMap 是用来存储配置文件的 Kubernetes 资源对象，所有的配置内容都存储在 etcd 中。它可以被用来保存单个属性，也可以用来保存整个配置文件或者 JSON 二进制对象。ConfigMap API 资源提供了将配置数据注入容器的方式，同时保证该机制对容器来说是透明的。配置应该从 Image 内容中解耦，以此来保持容器化应用程序的可移植性。</p> <h4 id="使用-configmap-配置-mysql"><a href="#使用-configmap-配置-mysql" class="header-anchor">#</a> 使用 ConfigMap 配置 MySQL</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop<span class="token punctuation">-</span>config
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment"># 这里是键值对数据</span>
  <span class="token key atrule">mysqld.cnf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    [client]
    port=3306
    [mysql]
    no-auto-rehash
    [mysqld]
    skip-host-cache
    skip-name-resolve
    default-authentication-plugin=mysql_native_password
    character-set-server=utf8mb4
    collation-server=utf8mb4_general_ci
    explicit_defaults_for_timestamp=true
    lower_case_table_names=1</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token comment"># 以数据卷的形式挂载 MySQL 配置文件目录</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/mysql/conf.d
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment"># 将 ConfigMap 中的内容以文件形式挂载进数据卷</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop<span class="token punctuation">-</span>config
            <span class="token key atrule">items</span><span class="token punctuation">:</span>
                <span class="token comment"># ConfigMap 中的 Key</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> mysqld.cnf
                <span class="token comment"># ConfigMap Key 匹配的 Value 写入名为 mysqld.cnf 的文件中</span>
                <span class="token key atrule">path</span><span class="token punctuation">:</span> mysqld.cnf
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>myshop
          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>myshop
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">32036</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>myshop
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看 ConfigMap</span>
kubectl get cm
kubectl describe cm <span class="token operator">&lt;</span>ConfigMap Name<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_6-6-kubernetes-dashboard"><a href="#_6-6-kubernetes-dashboard" class="header-anchor">#</a> 6.6  Kubernetes Dashboard</h4> <h4 id="概述-8"><a href="#概述-8" class="header-anchor">#</a> 概述</h4> <p>Kubernetes Dashboard 是 Kubernetes 集群的 Web UI，用于管理集群。</p> <h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4> <p>GitHub 地址：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener noreferrer">Kubernetes Dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>下载配置文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
</code></pre></div><p>修改配置如下</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 省略部分代码...</span>

<span class="token comment"># ------------------- Dashboard Deployment ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
        <span class="token comment"># 修改镜像地址为阿里云</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers/kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.10.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>auto<span class="token punctuation">-</span>generate<span class="token punctuation">-</span>certificates
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /certs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
        <span class="token key atrule">secret</span><span class="token punctuation">:</span>
          <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule

<span class="token punctuation">---</span>
<span class="token comment"># ------------------- Dashboard Service ------------------- #</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 修改类型为 NodePort 访问</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
      <span class="token comment"># 设置端口号为 30001</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
</code></pre></div><p>部署到集群</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 部署</span>
kubectl create <span class="token punctuation">-</span>f kubernetes<span class="token punctuation">-</span>dashboard.yaml

<span class="token comment"># 查看</span>
kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get pods
kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get service kubernetes<span class="token punctuation">-</span>dashboard
kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system describe service kubernetes<span class="token punctuation">-</span>dashboard
</code></pre></div><h4 id="访问"><a href="#访问" class="header-anchor">#</a> 访问</h4> <p>需要使用 NodeIP:30001 访问 Dashboard，因为证书原因除火狐浏览器外其它浏览器无法直接打开页面</p> <p>Chrome 浏览器显示如下</p> <p><img src="/study/assets/img/k8s_dashboard1.4906c11e.png" alt=""></p> <p>Firefox 浏览器显示如下</p> <p><img src="/study/assets/img/k8s_dashboard2.788c8d3c.png" alt=""></p> <p>点击 <strong>接受风险并继续</strong> 即可显示欢迎界面</p> <p><img src="/study/assets/img/k8s_ds.9efda2d8.png" alt=""></p> <h4 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h4> <p>我们采用 Token 方式登录</p> <ul><li>创建登录账号，创建一个名为 <code>dashboard-adminuser.yaml</code> 的配置文件</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>kubectl create -f dashboard-adminuser.yaml
</code></pre></div><ul><li>打印 Token 信息</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl -n kube-system describe secret <span class="token variable"><span class="token variable">$(</span>kubectl -n kube-system get secret <span class="token operator">|</span> <span class="token function">grep</span> admin-user <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span><span class="token variable">)</span></span>

<span class="token comment"># 输出如下</span>
Name:         admin-user-token-86cz9
Namespace:    kube-system
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: 3902d3d4-8b13-11e9-8089-000c29d49c77

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1025</span> bytes
namespace:  <span class="token number">11</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTg2Y3o5Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIzOTAyZDNkNC04YjEzLTExZTktODA4OS0wMDBjMjlkNDljNzciLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.pA44wyarsahOwqH7X7RVlcdB1k3_j-L3gwOYlTQ4_Lu5ZmfXDFlhqN-Q1tdryJes_V1Nj_utocnXBAxsGzOGaVR4Te4oli3htSepI9MrggQAyeC3C0_QANXGCE6V5L6B5tGZ6tDsY92VDnlvz2N6OrHaH2IJJd2DlxzYvAPvfAFuPeHWuPeVxUisMfXeW42S7US6skZwbZ06JrPYAFxHjqv3zoxRxI8-bmekltvOamsrL0pAXvIUzaowgbjiQb2NgeLAw9O6qfYcz5DAi2C-7G_yAcve6pgnWcIGhVpKoim9DfJUhe1SVx4H4X5Na6GVaaD6FdUIb7UOgsO1FVpTPw
</code></pre></div><ul><li><p>将 Token 输入浏览器，成功登陆后效果如下</p> <p><img src="/study/assets/img/k8s_ds_home.2a97959b.png" alt=""></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/devops/jenkins-yudocker-de-zi-dong-huacicd-shi-zhan.html" class="prev">
        Jenkins与Docker的自动化CICD实战
      </a></span> <span class="next"><a href="/study/devops/kubernetes-2.html">
        Kubernetes-2
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study/assets/js/app.9d47d501.js" defer></script><script src="/study/assets/js/2.e3467082.js" defer></script><script src="/study/assets/js/3.1db237fe.js" defer></script>
  </body>
</html>
